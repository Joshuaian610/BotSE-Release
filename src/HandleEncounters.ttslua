



posEncounters                     = {

  ["Black Marsh"]                 = {
    ["Town"]                      = {
      ["Alten Corimont"]          = { -42.60, 1.69, 17.04 },
      ["Bright-Throat Village"]   = { -42.65, 1.69, 3.66 },
      ["Dead-Water Village"]      = { -46.52, 1.69, 4.27 },
      ["Fort Redmane"]            = { -54.29, 1.69, 13.28 },
      ["Gideon"]                  = { -51.68, 1.69, 10.31 },
      ["Hissmir"]                 = { -45.19, 1.69, 15.50 },
      ["Leyawiin"]                = { -54.29, 1.69, 10.28 },
      ["Lilmoth"]                 = { -41.36, 1.69, 1.56 },
      ["Percolating Mire"]        = { -40.00, 1.69, 15.50 },
      ["Root-Whisper Village"]    = { -41.30, 1.69, 5.81 },
      ["Stonewastes"]             = { -50.39, 1.69, 6.56 },
      ["Stormhold"]               = { -43.87, 1.69, 20.78 },
    },
    ["Peaceful"]                  = {
      ["Alten Meerhleel"]         = { -43.96, 1.69, 1.29 },
      ["Deep Swamp Forge"]        = { -47.81, 1.69, 3.60 },
      ["Farmer's Nook"]           = { -47.75, 1.69, 14.09 },
      ["Forsaken Hamlet"]         = { -41.26, 1.69, 17.73 },
      ["Fort Blueblood"]          = { -53.02, 1.69, 9.58 },
      ["Hutan-T'Zel"]             = { -46.48, 1.69, 11.80 },
      ["Murkwater"]               = { -43.85, 1.69, 14.81 },
      ["Plateau Of The Traveler"] = { -47.81, 1.69, 8.02 },
      ["Stillrise Village"]       = { -45.17, 1.69, 20.07 },
      ["The Dominus Fatum"]       = { -43.88, 1.69, 5.77 },
      ["Xal Ithix"]               = { -47.78, 1.69, 15.58 },
      ["Xinchei-Konu Monument"]   = { -41.32, 1.69, 2.83 },
    },
    ["Conflict"]                  = {
      ["Blackrose Prison"]        = { -46.51, 1.69, 2.87 },
      ["Camp Merciful Reduction"] = { -39.97, 1.69, 18.48 },
      ["Echoing Hollow"]          = { -45.24, 1.69, 6.58 },
      ["Ten-Maur-Wolk"]           = { -42.60, 1.69, 18.52 },
      ["Vunalk"]                  = { -46.50, 1.69, 8.79 },
      ["Zenithar's Abbey"]        = { -50.35, 1.69, 14.07 },
    },
    ["Unstable"]                  = {
      { -45.23, 1.69, 3.55 },
      { -43.91, 1.69, 7.25 },
      { -47.81, 1.69, 6.61 },
      { -45.20, 1.69, 9.57 },
      { -50.40, 1.69, 8.10 },
      { -54.31, 1.69, 8.82 },
      { -49.08, 1.69, 10.31 },
      { -45.19, 1.69, 12.56 },
      { -49.09, 1.69, 13.28 },
      { -49.08, 1.69, 16.27 },
      { -42.59, 1.69, 14.02 },
      { -46.49, 1.69, 17.81 },
      { -43.90, 1.69, 17.77 },
      { -53.02, 1.69, 12.53 },
    },
  },

  ["Cyrodiil"]                         = {
    ["Town"]                           = {
      ["Bruma"]                        = { -45.52, 1.64, 18.22 },
      ["Castle Black Boot"]            = { -45.59, 1.64, 6.28 },
      ["Castle Bloodmayne"]            = { -43.01, 1.64, 6.33 },
      ["Chalman Keep"]                 = { -42.97, 1.64, 16.75 },
      ["Cheydinhal"]                   = { -39.11, 1.64, 14.57 },
      ["Chorrol"]                      = { -50.74, 1.64, 13.77 },
      ["Cropsford"]                    = { -40.39, 1.64, 9.28 },
      ["Fort Ash"]                     = { -48.18, 1.64, 13.76 },
      ["Fort Warden"]                  = { -50.75, 1.64, 18.24 },
      ["Imperial City"]                = { -44.27, 1.64, 13.02 },
      ["Kingscrest Keep"]              = { -40.37, 1.64, 19.68 },
      ["Vlastarus"]                    = { -48.14, 1.64, 7.82 },
    },
    ["Peaceful"]                       = {
      ["Abbey Of The Eight"]           = { -48.14, 1.64, 6.27 },
      ["Hackdirt"]                     = { -50.78, 1.64, 12.28 },
      ["Ice-Heart Home"]               = { -48.15, 1.64, 18.25 },
      ["Lunar Fang Docks"]             = { -41.37, 1.64, 8.53 },
      ["Riverwatch"]                   = { -43.00, 1.64, 9.35 },
      ["Temple Of The Ancestor Moths"] = { -39.11, 1.64, 17.47 },
      ["Thalara's Winery"]             = { -46.85, 1.64, 7.06 },
      ["Weye"]                         = { -46.89, 1.64, 13.02 },
      ["Weynon Priory"]                = { -49.46, 1.64, 12.97 },
      ["White Fall Mountain"]          = { -39.09, 1.64, 16.02 },
      ["Wilminn's Winery"]             = { -41.69, 1.64, 17.53 },
      ["Zimar's Winery"]               = { -48.15, 1.64, 19.71 },
    },
    ["Conflict"]                       = {
      ["Gray Viper Outpost"]           = { -45.57, 1.64, 10.84 },
      ["Harlun's Watch"]               = { -37.84, 1.64, 12.26 },
      ["Lipsand Tarn"]                 = { -52.03, 1.64, 15.99 },
      ["Sedor"]                        = { -41.68, 1.64, 19.06 },
      ["Underpall Cave"]               = { -46.82, 1.64, 15.99 },
      ["Wenyandawik"]                  = { -44.28, 1.64, 7.04 },
    },
    ["Unstable"]                       = {
      { -44.29, 1.64, 4.09 },
      { -49.42, 1.64, 8.55 },
      { -52.03, 1.64, 19.01 },
      { -49.46, 1.64, 16.00 },
      { -48.14, 1.64, 10.81 },
      { -45.59, 1.64, 9.32 },
      { -44.24, 1.64, 18.95 },
      { -36.53, 1.64, 16.03 },
      { -40.40, 1.64, 15.26 },
      { -40.40, 1.64, 12.28 },
      { -42.97, 1.64, 12.27 },
      { -44.29, 1.64, 11.53 },
      { -45.54, 1.64, 12.29 },
      { -45.59, 1.64, 13.80 },
      { -44.25, 1.64, 14.51 },
      { -42.98, 1.64, 13.75 },
    },
  },

  ["High Rock"]                   = {
    ["Town"]                      = {
      ["Daggerfall"]              = { -53.29, 1.64, 5.62 },
      ["Camlorn"]                 = { -50.74, 1.64, 10.01 },
      ["Crosswych"]               = { -46.88, 1.64, 10.82 },
      ["Alcaire Castle"]          = { -45.57, 1.64, 11.53 },
      ["Shornhelm"]               = { -45.60, 1.64, 14.43 },
      ["Fell's Run"]              = { -42.99, 1.64, 14.43 },
      ["Northpoint"]              = { -42.98, 1.64, 17.50 },
      ["Wayrest"]                 = { -41.77, 1.64, 7.79 },
      ["Evermore"]                = { -37.84, 1.64, 10.00 },
      ["Orsinium"]                = { -36.49, 1.64, 13.66 },
      ["Morkul Stronghold"]       = { -39.12, 1.64, 15.25 },
      ["Fharun Stronghold"]       = { -37.78, 1.64, 17.46 },
    },
    ["Peaceful"]                  = {
      ["Aldcroft"]                = { -50.78, 1.64, 7.05 },
      ["Bangkorai Garrison"]      = { -36.50, 1.64, 9.28 },
      ["Camp Tamrith"]            = { -48.20, 1.64, 12.97 },
      ["Graystone Quarry"]        = { -39.15, 1.64, 12.26 },
      ["Koeglin Village"]         = { -45.58, 1.64, 10.05 },
      ["Hoarfrost Downs"]         = { -44.30, 1.64, 13.76 },
      ["Miltrin's Fishing Cabin"] = { -53.32, 1.64, 7.13 },
      ["Shatul Range"]            = { -36.54, 1.64, 15.20 },
    },
    ["Conflict"]                  = {
      ["At-Tura Estate"]          = { -44.29, 1.64, 7.87 },
      ["Glenumbra Moors"]         = { -50.80, 1.64, 8.50 },
      ["The Doomcrag"]            = { -46.81, 1.64, 15.22 },
      ["Zthenganaz"]              = { -37.88, 1.64, 15.99 },
    },
    ["Unstable"]                  = {
      { -49.47, 1.64, 12.26 },
      { -48.15, 1.64, 10.06 },
      { -44.26, 1.64, 18.19 },
      { -45.59, 1.64, 16.03 },
      { -45.61, 1.64, 13.00 },
      { -43.01, 1.64, 11.55 },
      { -41.70, 1.64, 9.30 },
      { -35.27, 1.64, 10.08 },
      { -37.81, 1.64, 11.55 },
      { -39.12, 1.64, 13.80 },
      { -36.54, 1.64, 16.72 },
    },
  },

  ["Morrowind"]            = {
    ["Town"]               = {
      ["Balmora"]          = { -49.49, 1.64, 15.29 },
      ["Davon's Watch"]    = { -46.87, 1.64, 9.33 },
      ["Ebonheart"]        = { -49.45, 1.64, 7.74 },
      ["Gnisis"]           = { -52.01, 1.64, 19.70 },
      ["Kragenmoor"]       = { -53.32, 1.64, 5.55 },
      ["Mournhold"]        = { -48.19, 1.64, 4.10 },
      ["Narsis"]           = { -52.05, 1.64, 3.25 },
      ["Necrom"]           = { -36.43, 1.64, 12.24 },
      ["Sadrith Mora"]     = { -42.93, 1.64, 17.46 },
      ["Sailenmora"]       = { -41.70, 1.64, 9.25 },
      ["Silent Mire"]      = { -44.26, 1.64, 3.33 },
      ["Vivec City"]       = { -46.85, 1.64, 12.19 },
    },
    ["Peaceful"]           = {
      ["Ald Isra"]         = { -44.25, 1.64, 10.83 },
      ["Dhalmora"]         = { -45.55, 1.64, 8.55 },
      ["Fort Arand"]       = { -48.19, 1.64, 5.58 },
      ["Iliath Temple"]    = { -54.63, 1.64, 6.33 },
      ["Lukiul Uxith"]     = { -53.37, 1.64, 8.50 },
      ["Molag Mar"]        = { -44.27, 1.64, 15.19 },
      ["Muth Gnaar"]       = { -49.50, 1.64, 3.27 },
      ["Seyda Neen"]       = { -48.19, 1.64, 13.04 },
      ["Shad Astula"]      = { -45.59, 1.64, 5.51 },
      ["Tel Dreloth"]      = { -40.38, 1.64, 7.03 },
      ["Tel Hlurag Ven"]   = { -39.10, 1.64, 10.76 },
      ["Vos"]              = { -45.52, 1.64, 18.98 },
    },
    ["Conflict"]           = {
      ["Anchre Egg Mine"]  = { -37.79, 1.64, 10.01 },
      ["Camonnaruhn"]      = { -44.25, 1.64, 6.33 },
      ["Forgotten Wastes"] = { -46.84, 1.64, 19.72 },
      ["Fort Virak"]       = { -53.34, 1.64, 11.42 },
      ["Nchuleftingth"]    = { -45.59, 1.64, 15.91 },
      ["Tormented Spire"]  = { -50.72, 1.64, 5.54 },
    },
    ["Unstable"]           = {
      { -54.64, 1.64, 9.23 },
      { -53.31, 1.64, 7.01 },
      { -52.03, 1.64, 4.79 },
      { -50.77, 1.64, 7.01 },
      { -46.85, 1.64, 3.33 },
      { -45.59, 1.64, 7.09 },
      { -44.32, 1.64, 4.82 },
      { -43.01, 1.64, 8.52 },
      { -40.38, 1.64, 5.53 },
      { -37.79, 1.64, 11.53 },
      { -40.37, 1.64, 11.50 },
      { -49.47, 1.64, 13.79 },
      { -50.74, 1.64, 15.97 },
      { -50.74, 1.64, 20.46 },
    },
    ["Dig Site"]           = {
      { -45.57, 1.64, 4.01 },
      { -49.43, 1.64, 19.70 },
    },
  },

  ["Western Skyrim"]               = {
    ["Town"]                       = {
      ["Dragon Bridge"]            = { -46.37, 1.64, 14.79 },
      ["Entrance To Dusktown"]     = { -45.03, 1.64, 10.98 },
      ["Karthwasten"]              = { -50.26, 1.64, 11.00 },
      ["Karthwatch"]               = { -47.67, 1.64, 12.53 },
      ["Kilkreath Temple"]         = { -45.06, 1.64, 17.01 },
      ["Lost Valley Redoubt"]      = { -43.75, 1.64, 5.86 },
      ["Markarth"]                 = { -52.85, 1.64, 6.63 },
      ["Mor Khazgur"]              = { -51.52, 1.64, 14.81 },
      ["Morthal"]                  = { -38.50, 1.64, 13.27 },
      ["Rebel's Retreat"]          = { -48.99, 1.64, 7.32 },
      ["Solitude"]                 = { -41.17, 1.64, 17.68 },
      ["The Silver Cormorant"]     = { -38.55, 1.64, 17.80 },
    },
    ["Peaceful"]                   = {
      ["Dragon's Belly"]           = { -50.21, 1.64, 15.45 },
      ["Druadach Redoubt"]         = { -51.56, 1.64, 11.82 },
      ["Hroldan Ring"]             = { -47.62, 1.64, 6.54 },
      ["Hunter's House"]           = { -43.77, 1.64, 13.23 },
      ["Morthal Market"]           = { -39.84, 1.64, 12.56 },
      ["North Markarth Outskirts"] = { -51.24, 1.64, 7.27 },
      ["Solitude Docks"]           = { -42.44, 1.64, 17.03 },
      ["Southern Watch"]           = { -45.07, 1.64, 9.52 },
      ["Stillwaters Retreat"]      = { -35.99, 1.64, 16.20 },
      ["Storm-Hawk's Altar"]       = { -39.80, 1.64, 16.96 },
      ["Sword's Point Watchtower"] = { -46.30, 1.64, 19.27 },
      ["Wolf's Eye Lighthouse"]    = { -41.14, 1.64, 20.72 },
    },
    ["Conflict"]                   = {
      ["Briar Rock Ruins"]         = { -51.56, 1.64, 4.30 },
      ["Chilblain Peak"]           = { -48.91, 1.64, 13.24 },
      ["Four Skull Lookout"]       = { -47.64, 1.64, 9.53 },
      ["Labyrinthian"]             = { -37.31, 1.64, 11.06 },
      ["Lift To Greymoor Keep"]    = { -41.17, 1.64, 13.31 },
      ["Ysmgar's Beach"]           = { -47.58, 1.64, 19.96 },
    },
    ["Unstable"] = {
      { -43.76, 1.64, 4.40 },
      { -48.95, 1.64, 5.80 },
      { -50.26, 1.64, 8.09 },
      { -54.13, 1.64, 10.37 },
      { -42.46, 1.64, 11.09 },
      { -46.35, 1.64, 11.82 },
      { -50.24, 1.64, 18.53 },
      { -47.59, 1.64, 16.95 },
      { -45.01, 1.64, 19.99 },
      { -42.46, 1.64, 15.56 },
      { -39.82, 1.64, 15.53 },
      { -34.67, 1.64, 18.51 },
      { -34.67, 1.64, 17.05 },
      { -35.99, 1.64, 13.29 },
      { -34.67, 1.64, 12.56 },
    },
  },

    ["Eastern Skyrim"]                    = {
    ["Town"]                              = {
      ["Fort Amol"]                       = { -48.83, 1.64, 12.73 },
      ["Fort Morvunskar"]                 = { -46.15, 1.64, 15.66 },
      ["Fullhelm Fort"]                   = { -38.46, 1.64, 3.83 },
      ["Ivarstead"]                       = { -52.67, 1.64, 8.93 },
      ["Jorunn's Stand"]                  = { -41.03, 1.64, 12.67 },
      ["Mistwatch"]                       = { -44.92, 1.64, 11.88 },
      ["Nimalten"]                        = { -50.11, 1.64, 7.50 },
      ["Riften"]                          = { -42.37, 1.64, 6.01 },
      ["Shor's Stone"]                    = { -42.35, 1.64, 9.04 },
      ["Skald's Retreat"]                 = { -44.97, 1.64, 4.47 },
      ["Windhelm"]                        = { -42.29, 1.64, 17.94 },
      ["Wittestadr"]                      = { -43.58, 1.64, 14.22 },
    },
    ["Peaceful"]                          = {
      ["Boulderfall Pass"]                = { -43.64, 1.64, 8.18 },
      ["Cragwallow"]                      = { -42.29, 1.64, 14.91 },
      ["Crimson Kada's Crafting Caravan"] = { -47.48, 1.64, 13.46 },
      ["Eldbjorg's Hideaway"]             = { -48.82, 1.64, 8.27 },
      ["Giermund's Hall"]                 = { -51.41, 1.64, 8.22 },
      ["Hammerhome"]                      = { -39.73, 1.64, 12.01 },
      ["Lower Yorgrim"]                   = { -41.06, 1.64, 17.17 },
      ["Smokefrost Vigil"]                = { -41.01, 1.64, 3.82 },
      ["Tinkerer Tobin's Workshop"]       = { -44.86, 1.64, 14.99 },
      ["Treva's Farm"]                    = { -47.50, 1.64, 6.03 },
      ["Trollslayer's Gully"]             = { -46.21, 1.64, 3.79 },
      ["Voljar's Meadery"]                = { -46.20, 1.64, 18.69 },
    },
    ["Conflict"]                          = {
      ["Faldar's Tooth"]                  = { -44.92, 1.64, 6.03 },
      ["Old Sord's Cave"]                 = { -43.62, 1.64, 12.70 },
      ["Skuldafn"]                        = { -38.44, 1.64, 14.20 },
      ["Snapleg Cave"]                    = { -48.83, 1.64, 9.73 },
      ["The Grinning Horker"]             = { -47.48, 1.64, 17.93 },
      ["Trolhetta Summit"]                = { -41.05, 1.64, 2.32 },
    },
    ["Unstable"]                          = {
      { -53.98, 1.64, 9.75 },
      { -53.95, 1.64, 6.80 },
      { -52.71, 1.64, 4.54 },
      { -48.80, 1.64, 5.31 },
      { -50.10, 1.64, 14.93 },
      { -46.20, 1.64, 9.75 },
      { -44.86, 1.64, 17.99 },
      { -44.89, 1.64, 7.52 },
      { -43.64, 1.64, 5.28 },
      { -42.29, 1.64, 19.46 },
      { -41.03, 1.64, 9.72 },
      { -39.74, 1.64, 5.99 },
      { -38.42, 1.64, 8.29 },
      { -38.44, 1.64, 12.75 },
      { -37.08, 1.64, 14.95 },
    },
  },

  ["Valenwood"]                 = {
    ["Town"]                    = {
      ["Arenthia"]              = { -38.55, 1.64, 18.67 },
      ["Baandari Trading Post"] = { -42.47, 1.64, 16.45 },
      ["Dread Vullain"]         = { -51.52, 1.64, 9.74 },
      ["Elden Root"]            = { -41.18, 1.64, 5.25 },
      ["Greenheart"]            = { -50.29, 1.64, 4.46 },
      ["Haven"]                 = { -37.28, 1.64, 2.99 },
      ["Marbruk"]               = { -46.35, 1.64, 8.22 },
      ["Silvenar"]              = { -45.02, 1.64, 15.00 },
      ["Southpoint"]            = { -42.46, 1.64, 1.52 },
      ["Velyn Harbor"]          = { -51.51, 1.64, 14.20 },
      ["Willowgrove"]           = { -41.16, 1.64, 11.35 },
      ["Woodhearth"]            = { -54.15, 1.64, 6.77 },
    },
    ["Peaceful"]                = {
      ["Cormount"]              = { -41.18, 1.64, 8.28 },
      ["Do'Krin Monastery"]     = { -42.44, 1.64, 12.05 },
      ["Falinesti Autumn Site"] = { -39.85, 1.64, 16.46 },
      ["Falinesti Spring Site"] = { -47.68, 1.64, 9.01 },
      ["Falinesti Summer Site"] = { -50.22, 1.64, 13.51 },
      ["Falinesti Winter Site"] = { -42.48, 1.64, 4.48 },
      ["Longhaven"]             = { -52.86, 1.64, 6.02 },
      ["Redfur Trading Post"]   = { -43.77, 1.64, 8.22 },
      ["Spinner's Cottage"]     = { -47.64, 1.64, 6.03 },
      ["Tanglehaven"]           = { -47.66, 1.64, 13.51 },
      ["The Gray Mire"]         = { -41.19, 1.64, 2.24 },
      ["Valeguard"]             = { -43.78, 1.64, 14.19 },
    },
    ["Conflict"]                = {
      ["City Of Ash"]           = { -46.35, 1.64, 9.75 },
      ["Gil-Var-Delle"]         = { -45.09, 1.64, 4.51 },
      ["Horseshoe Island"]      = { -47.62, 1.64, 16.49 },
      ["Ossuary Of Telacar"]    = { -38.58, 1.64, 5.26 },
      ["Rulanyil's Fall"]       = { -51.56, 1.64, 8.27 },
      ["The Vile Manse"]        = { -41.13, 1.64, 18.67 },
    },
    ["Unstable"]                = {
      { -54.10, 1.64, 8.22 },
      { -50.24, 1.64, 6.00 },
      { -51.50, 1.64, 11.22 },
      { -48.94, 1.64, 11.29 },
      { -48.94, 1.64, 15.70 },
      { -46.27, 1.64, 15.69 },
      { -45.06, 1.64, 11.99 },
      { -43.75, 1.64, 9.76 },
      { -43.78, 1.64, 6.76 },
      { -39.83, 1.64, 3.03 },
      { -39.89, 1.64, 7.43 },
      { -41.15, 1.64, 14.19 },
      { -41.15, 1.64, 17.22 },
      { -43.72, 1.64, 18.69 },
      { -38.54, 1.58, 20.19 },
    },
  },
}

posTrainers = {
  {-26.48, 1.69, -14.00},
  {-23.07, 1.69, -14.00},
  {-19.65, 1.69, -14.00},
  {-16.24, 1.69, -14.00},
  {-12.82, 1.69, -14.00},
  {-9.41, 1.69, -14.00},
  {-5.99, 1.69, -14.00},
  {-2.58, 1.69, -14.00},
}

posCommonItems = {
  {-26.48, 1.60, -10.00},
  {-23.07, 1.60, -10.00},
  {-19.65, 1.60, -10.00},
  {-16.24, 1.60, -10.00},
  {-12.82, 1.60, -10.00},
  {-9.41, 1.60, -10.00},
  {-5.99, 1.60, -10.00},
  {-2.58, 1.60, -10.00},
  {0.84, 1.60, -10.00},
  {4.26, 1.60, -10.00},
  {7.67, 1.60, -10.00},
  {11.09, 1.60, -10.00},
  {14.50, 1.60, -10.00},
}

posLegendaryItems = {
  {-26.48, 1.60, -5.00},
  {-23.07, 1.60, -5.00},
  {-19.65, 1.60, -5.00},
  {-16.24, 1.60, -5.00},
  {-12.82, 1.60, -5.00},
  {-9.41, 1.60, -5.00},
  {-5.99, 1.60, -5.00},
  {-2.58, 1.60, -5.00},
  {0.84, 1.60, -5.00},
  {4.26, 1.60, -5.00},
  {7.67, 1.60, -5.00},
  {11.09, 1.60, -5.00},
  {14.50, 1.60, -5.00},
}


function initButtonSetupEncounter(obj)
  
  obj.clearButtons()

  obj.createButton({
    label          = "",
    click_function = "getEncounterLocation",
    function_owner = self,
    position       = { 0.00, 0.31, 0.00 },
    height         = 990,
    width          = 1890,
    scale          = { 1, 1, 1 },
    color          = { 1, 1, 1, 0 },
    hover_color    = { 1, 1, 1, .6 },
    tooltip        = "First, ensure that the Party Overland Token is in your desired Encounter location.\n\nThen, click this button to set up the current location's Encounter."
  })
end


function initButtonCleanupEncounter(obj)

  obj.clearButtons()

  obj.createButton({
    label          = "",
    click_function = "cleanupEncounter",
    function_owner = self,
    position       = { 0.00, 0.31, 0.00 },
    height         = 990,
    width          = 1890,
    scale          = { 1, 1, 1 },
    color          = { 1, 1, 1, 0 },
    hover_color    = { 1, 1, 1, .6 },
    tooltip        = "Click this button to clean up the currently active Encounter."
  })
end


function initButtonsConflictSelect(obj)
  obj.clearButtons()

  local posButton1, heightButton1, posButton2, heightButton2, posButton3, heightButton3 = getConflictButtonDetails(obj.getName())

  obj.createButton({
    label          = "",
    click_function = "setupConflict1",
    function_owner = self,
    position       = posButton1,
    rotation       = { 0, 0, 180 },
    height         = heightButton1,
    width          = 910,
    scale          = { 1, 1, 1 },
    color          = { 1, 1, 1, .6 },
    hover_color    = { 1, 1, 1, .8 },
    tooltip        = "Click to select this conflict encounter option."
  })

  if posButton2 ~= nil and heightButton2 ~= nil then
    obj.createButton({
    label          = "",
    click_function = "setupConflict2",
    function_owner = self,
    position       = posButton2,
    rotation       = { 0, 0, 180 },
    height         = heightButton2,
    width          = 910,
    scale          = { 1, 1, 1 },
    color          = { 1, 1, 1, .6 },
    hover_color    = { 1, 1, 1, .8 },
    tooltip        = "Click to select this conflict encounter option."
  })
  end

  if posButton3 ~= nil and heightButton3 ~= nil then
    obj.createButton({
    label          = "",
    click_function = "setupConflict3",
    function_owner = self,
    position       = posButton3,
    rotation       = { 0, 0, 180 },
    height         = heightButton3,
    width          = 910,
    scale          = { 1, 1, 1 },
    color          = { 1, 1, 1, .6 },
    hover_color    = { 1, 1, 1, .8 },
    tooltip        = "Click to select this conflict encounter option."
  })
  end
end


function initButtonSiegeBattle(obj)

  obj.clearButtons()

  obj.createButton({
    label          = "",
    click_function = "siegeBattle",
    function_owner = self,
    position       = { 0.00, 0.31, 0.00 },
    height         = 990,
    width          = 1890,
    scale          = { 1, 1, 1 },
    color          = { 1, 1, 1, 0 },
    hover_color    = { 1, 1, 1, .6 },
    tooltip        = "Clicking this button builds a clash encounter for a Skyrim Town Siege battle.\n\nClicking this button while the party is located outside of a town space will assume a Traveling Caravan setup."
  })
end


function initButtonDungeonMap(obj)

  obj.clearButtons()

  obj.createButton({
    label          = "",
    click_function = "setupDungeonMap",
    function_owner = self,
    position       = { 0.00, 0.31, 0.00 },
    height         = 990,
    width          = 1890,
    scale          = { 1, 1, 1 },
    color          = { 1, 1, 1, 0 },
    hover_color    = { 1, 1, 1, .6 },
    tooltip        = "Clicking this button quickly sets up the base dungeon map for your current province.\n\nEnemies will need to be pulled for your encounter manually, this button currently only sets up the dungeon map."
  })
end


function animateButtonsEncounter(obj)
  -- this function handles the animation of the switch between setup and cleanup encounter buttons

  -- based on clicked object, determine counterpart button, make the swap visually & mechanically
  local counterpartName = obj.getName() == "Button Setup Encounter" and "Button Cleanup Encounter" or "Button Setup Encounter"
  local counterpart = getObjectbyName(counterpartName)
  if not counterpart then log("animateButtonsEncounter(): counterpart not found") return end

  obj.clearButtons()
  local pos = obj.getPosition()
  pos.y = pos.y - .29
  obj.setPosition(pos)
  counterpart.setPosition({-38.89, 0.87, -5.75})
  counterpart.setScale({0.58, 1.00, 0.58})
  counterpart.setPositionSmooth({-38.89, 1.14, -5.75})
  Wait.time(function() 
   
    if counterpart.getName() == "Button Setup Encounter" then
      initButtonSetupEncounter(counterpart)
    else
      initButtonCleanupEncounter(counterpart)
    end

  end, .5)
  pos.y = -2
  obj.setPositionSmooth(pos, false, false)
end


function getEncounterLocation(button, _, _)

  -- this function handles the detection of the party token, and launching the appropriate encounter type

  animateButtonsEncounter(button)

  -- get and find province map, provinceMapName (especially important for eastern/western skyrim)
  local zone = getObjectFromGUID("64c0a4")
  local provinceMapName = nil
  for _, obj in ipairs(zone.getObjects()) do
    local name = obj.getName()
    local match = string.match(name, "^(.-) Overland Map$")
    if match and posEncounters[match] then
      provinceMapName = match
      break
    end
  end
  if not provinceMapName then
    broadcastToAll("No Province Map Found. Set up encounter manually", "Orange")
    return
  end

  -- first, determine if unstable die is in zone, if it's rolling or not, and if stopped, trigger unstable encounter, resize/place die, and return out
  local dieZone = getObjectFromGUID("b5dd6d")
  local die = getObjectbyName("Unstable Die")
  if not die then log("getEncounterLocation(): die not found") return end

  for _, object in pairs(dieZone.getObjects()) do
    if object == die then
      if object.getVar('just_rolled') then
        broadcastToAll("Please allow the Unstable Die to come to a rest before setting up it's Encounter.", "Orange")
        return

      else

        local dieScale = { 1, 1, 1 }
        local posDieHome = { -56.32, 1.60, 0.41 }
        local rotValue = die.getRotationValue()
        
        animateButtonsEncounter(getObjectbyName("Button Setup Encounter"))

        if rotValue < 4 then          
          setupEncounter(provinceMapName, "Unstable", "Conflict")
        elseif rotValue > 3 and rotValue ~= 6 then
          setupEncounter(provinceMapName, "Unstable", "Peaceful")
        elseif rotValue == 6 then          
          setupTownEncounter(provinceMapName, "Traveling Caravan")
        end

        die.setScale(dieScale)
        die.setPositionSmooth(posDieHome, false, true)
        return

      end
    end
  end

  -- get partyToken, determine it's position 
  local partyToken = getObjectbyName("Party Overland Token")
  if not partyToken then
    broadcastToAll("Party Overland Token not found - Set up encounter manually.", "Orange")
    return
  end
  local pos = partyToken.getPosition()
  local x, y = pos.x, pos.z
  local data = posEncounters[provinceMapName]
  local tol = 0.3

  for category, entries in pairs(data) do
    if category ~= "Unstable" and category ~= "Dig Site" then
      for name, coords in pairs(entries) do
        if math.abs(coords[1] - x) <= tol and math.abs(coords[3] - y) <= tol then
          if category == "Town" then
            setupTownEncounter(provinceMapName, name)
          elseif category == "Peaceful" then
            setupEncounter(provinceMapName, name, "Peaceful")
          elseif category == "Conflict" then
            setupEncounter(provinceMapName, name, "Conflict")
          end
          return category, name
        end
      end

    elseif category == "Unstable" then
      for _, coords in ipairs(entries) do
        if math.abs(coords[1] - x) <= tol and math.abs(coords[3] - y) <= tol then
          setupUnstableEncounter(provinceMapName)
          return "Unstable"
        end
      end

    elseif category == "Dig Site" then
      for _, coords in ipairs(entries) do
        if math.abs(coords[1] - x) <= tol and math.abs(coords[3] - y) <= tol then
          -- dig site stuff
          local gazetteerMorrowind = getObjectbyName("Morrowind Gazetteer")
          if gazetteerMorrowind then gazetteerMorrowind.Book.setPage(3) end
          broadcastToAll("Dig Site Encountered!", "White")
          return "Dig Site"
        end
      end

    end
  end
  return "Empty"
end


function setupEncounter(provinceMapName, encounterName, encounterType)
  
  -- this function handles the setup of all non town encounters

  -- get drawn encounter card, type set by zone selected via checkZone declaration
  local card = nil
  local posActiveEncounter = { -38.89, 1.40, -2.53 }
  local rotFaceUp = { 0, 180, 180 }
  local posDeckPeaceful = { 44.98, 1.40 -2.83 }
  local posDeckConflict = { 49.14, 1.40, -2.85 }
  local checkZone = getObjectFromGUID(encounterType == "Peaceful" and "623063" or "11495d")
  for _, object in pairs(checkZone.getObjects()) do
    if object.type == "Deck" then
      card = object.takeObject()
    elseif object.type == "Card" then
      card = object
    end
  end  
  if card == nil then -- handle deck refresh if needed
    local discardCheckZone = getObjectFromGUID(encounterType == "Peaceful" and "503dae" or "035f7b")
    for _, object in pairs(discardCheckZone.getObjects()) do
      if object.type == "Deck" then
        object.setRotation(rotFaceUp)
        object.shuffle()
        card = object.takeObject()
        object.setPositionSmooth(type == "Peaceful" and posDeckPeaceful or posDeckConflict, false, false)
      end
    end
  end  
  if card ~= nil then
    card.addTag(type == "Peaceful" and "peaceful_encounter" or "conflict_encounter")
    card.setRotation(rotFaceUp)
    card.setPositionSmooth(posActiveEncounter)
    if encounterName ~= "Unstable" then
      broadcastToAll(encounterName .. " - " .. encounterType .. " Encounter Drawn: " .. card.getName(), "White")
    else
      broadcastToAll("Unstable - " .. encounterType .. " Encounter Drawn: " .. card.getName(), "White")
    end
  end

  -- if peaceful encounter, update province effect
  local peDisplay = nil
  for _, object in ipairs(getObjects()) do
    if object.hasTag('pe_display') then
      peDisplay = object
    end
  end

  local currentState = peDisplay.getStateId()

  if peDisplay ~= nil and peDisplay.getStateId() == 1 then
    
    if card.hasTag("symbol0") and currentState ~= 1 then -- state 1
      peDisplay = peDisplay.setState(1)
    elseif card.hasTag("symbol1") and not card.hasTag('symbol2') and not card.hasTag('symbol3') and currentState ~= 2 then -- state 2
      peDisplay = peDisplay.setState(2)
    elseif card.hasTag("symbol2") and not card.hasTag('symbol1') and not card.hasTag('symbol3') and currentState ~= 3 then -- state 3
      peDisplay = peDisplay.setState(3)
    elseif card.hasTag("symbol3") and not card.hasTag('symbol1') and not card.hasTag('symbol2') and currentState ~= 4 then -- state 4
      peDisplay = peDisplay.setState(4)

    -- double province effect icon handling                
        
    -- one for the wilderqueen: symbol1, symbol2            
    -- the love of mother morrowind: symbol1, symbol2
    -- money tree: symbol1, symbol2
    elseif card.hasTag("symbol1") and card.hasTag('symbol2') and currentState ~= 5 then -- state 5  
      peDisplay = peDisplay.setState(5)
    
    -- jungle jumble: symbol1, symbol3
    elseif card.hasTag("symbol1") and card.hasTag('symbol3') and currentState ~= 6 then -- state 6
      peDisplay = peDisplay.setState(6)
    
    -- share the woods: symbol2, symbol3
    elseif card.hasTag("symbol2") and card.hasTag('symbol3') and currentState ~= 7 then -- state 7
      peDisplay = peDisplay.setState(7)
    
    -- introducing arvan: symbol3, symbol3
    elseif card.hasTag("symbol3X2") and currentState ~= 8 then -- state 8
      peDisplay = peDisplay.setState(8)
    end

    Wait.frames(function() 
      peDisplay.interactable = false

      -- add a day indicator to peDisplay
      local currentDayNumber = getObjectbyName("Day Tracker Counter").getVar('val')
      if currentDayNumber and encounterType == "Peaceful" then
        peDisplay.createButton({
          click_function = "nullFunc",
          function_owner = self,
          label          = currentDayNumber,
          position       = {0.70, 0.31, 0.70},
          rotation       = {0, 0, 0},
          width          = 300,
          height         = 300,
          font_size      = 250,
          color          = {20/255, 48/255, 59/255},
          font_color     = {1, 1, 1},
          tooltip        = "Province Effect in effect for Current Day: " .. currentDayNumber .. ".\n\nProvided by Peaceful Encounter Card: " .. card.getName()
        })
      end

      -- add tag to detect if set for current day or not
      peDisplay.addTag('day_locked')
    end)
  end
end


function setupTownEncounter(provinceMapName, townName)

  -- this function handles the setup of town encounters and everything related

  -- check if objects in play zone, return out if so
  local play_zone = getObjectFromGUID("fecaa4")
  for _, object in pairs(play_zone.getObjects()) do
    if (object.type == "Token" or object.type == "Card" or
    object.type == "Deck" or object.type == "Model" or
    object.type == "Tile" and not object.hasTag('enemy_chip')) and object ~= getObjectFromGUID("2f6965") then
      broadcastToAll("Remove objects from bottom area before using this button.", "Orange")
      return
    end
  end
  -- get current province, gazetteer
  local currentProvince = provinceMapName -- needs to be in full format (inc eastern, western) to handle skyrims
  if currentProvince == nil then log("setupTownEncounter(): currentProvince not found") return end
  local normalizedProvince = currentProvince:find("Skyrim") and "Skyrim" or currentProvince
  local gazetteer = getObjectbyName(normalizedProvince .. " Gazetteer")
  if gazetteer == nil then
      broadcastToAll(normalizedProvince .. " Gazetteer not found. Manual setup of Town Encounter will be required.", "Orange")
      return
  end

  local buttonInn = nil
  local buttonQuest = nil
  local marketCommon = 0
  local marketLegend = 0
  local trainers = 0
  local trainerWarrior = false
  local trainerMage = false
  local trainerRogue = false
  local encounterTTip = nil
  local pdfPage = nil

  if currentProvince     == "Black Marsh" then
      if townName        == "Traveling Caravan" then
          buttonInn       = false
          buttonQuest     = true
          marketCommon    = 3
          marketLegend    = 2
          trainers        = 2
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Trouble Brewing[-]: Set the weather to Flooding. Do not change the weather during today's Activate Province Effect step (but still resolve the step for any other effects)."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 3
      elseif townName    == "Alten Corimont" then
          buttonInn       = true
          buttonQuest     = true
          marketCommon    = 3
          marketLegend    = 3
          trainers        = 3
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Open Contracts[-]: As a free town action, an adventurer may discard an active side quest to gain 1 item from the shop."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 4
      elseif townName    == "Bright-Throat Village" then
          buttonInn       = false
          buttonQuest     = true
          marketCommon    = 1
          marketLegend    = 3
          trainers        = 2
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Local Artisans[-]: After populating the shop, the party may choose to discard all items from the shop and replace them with new ones before any town actions are taken."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 5
      elseif townName    == "Dead-Water Village" then
          buttonInn       = false
          buttonQuest     = true
          marketCommon    = 3
          marketLegend    = 2
          trainers        = 2
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Camp Under The Stars[-]: At the start of this encounter, if the weather is Sunny, each adventurer may remove all dice from their cooldown track and heal to full HP."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 6
      elseif townName    == "Fort Redmane" then
          buttonInn       = false
          buttonQuest     = true
          marketCommon    = 2
          marketLegend    = 2
          trainers        = 3
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Dagon's Shadow[-]: Ignore this town effect if there are no Objective tokens currently in play. Each adventurer may take an additional town action. If any adventurer takes this additional town action, each Objective token doubles it's movement during today's Activate Province Effect step."
          trainerWarrior  = true
          trainerMage     = false
          trainerRogue    = false
          pdfPage         = 7
      elseif townName    == "Gideon" then
          buttonInn       = true
          buttonQuest     = true
          marketCommon    = 5
          marketLegend    = 1
          trainers        = 4
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Hub City[-]: Each time an adventurer trains a skill line in this town, discard all remaining trainers and replace them with 4 new ones."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 8
      elseif townName    == "Hissmir" then
          buttonInn       = false
          buttonQuest     = false
          marketCommon    = 2
          marketLegend    = 2
          trainers        = 1
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Hist Communion[-]: At the start of this encounter, if the weather is Sunny, each adventurer may gain 2 tenacity and remove up to 2 light fatigue from their cooldown stack."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 9
      elseif townName    == "Leyawiin" then
          buttonInn       = true
          buttonQuest     = true
          marketCommon    = 4
          marketLegend    = 2
          trainers        = 5
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]No Vacancy[-]: If the weather is Flooding, the inn is closed for this encounter."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 10
      elseif townName    == "Lilmoth" then
          buttonInn       = true
          buttonQuest     = true
          marketCommon    = 6
          marketLegend    = 0
          trainers        = 5
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Oliis Bay Tradeways[-]: When an adventurer takes a shop town action, they may gain 2 items instead of 1."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 11
      elseif townName    == "Percolating Mire" then
          buttonInn       = false
          buttonQuest     = true
          marketCommon    = 0
          marketLegend    = 0
          trainers        = 3
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Lost to the Mire[-]: At the start of this encounter, the party may freely gain the Mercs and Scales side quest, if available."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 12
      elseif townName    == "Root-Whisper Village" then
          buttonInn       = true
          buttonQuest     = true
          marketCommon    = 2
          marketLegend    = 2
          trainers        = 2
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]A Stranger's Generosity[-]: At the start of this encounter, the party must make a social check (Adv. Count X 2). If unsuccessful, the inn is closed for this encounter."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 13
      elseif townName    == "Stonewastes" then
          buttonInn       = false
          buttonQuest     = false
          marketCommon    = 2
          marketLegend    = 1
          trainers        = 4
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Train with the Four Winds[-]: After populating trainers, the party may replace any non Warrior type skill lines from the trainers with randomly drawn Warrior skill lines. If the party chooses to do this, the town square is closed for this encounter."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 14
      elseif townName    == "Stormhold" then
          buttonInn       = true
          buttonQuest     = true
          marketCommon    = 4
          marketLegend    = 1
          trainers        = 5
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Open Air Markets[-]: When populating the shop, if the weather is sunny, the shop populates an additional Common and Legendary item. (Must populate manually)"
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 15
      end

  elseif currentProvince == "Cyrodiil" then
      if townName        == "Traveling Caravan" then
          buttonInn       = false
          buttonQuest     = true
          marketCommon    = 2
          marketLegend    = 2
          trainers        = 1
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Remake Yourself[-]: At least 1 adventurer must take a trainer town action this encounter. If the adventurer who visits the trainer has already filled all of their attribute slots, they must replace a trained skill line with a skill line from the trainer. Any skill dice already trained in the original line are untrained and replaced with skill dice of equal of lower levels from the new line. If the adventurer already has the available skill line trained, they must draw a random untrained skill line to train."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 4
      elseif townName    == "Bruma" then
          buttonInn       = true
          buttonQuest     = true
          marketCommon    = 0
          marketLegend    = 0
          trainers        = 4
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Shadowed Path Secrets[-]: At the start of this encounter, the party may make a social check (Adv. Count X 2). If successful, the party may search the Conflict Overland Deck for the next delve encounter and set it aside. Then, shuffle the deck and place the delve encounter on top.\n[" .. Color.fromString("Green"):toHex() .. "]Shifting Tides[-]: Apply the dominant faction's effect for this town encounter."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 5
      elseif townName    == "Castle Black Boot" then
          buttonInn       = true
          buttonQuest     = true
          marketCommon    = 5
          marketLegend    = 1
          trainers        = 6
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Dominion Control[-]: At the start of this encounter, the party must make a social check (Adv. Count X 4). If the Aldmeri Dominion is dominant, or if it is day 1, this check is automatically successful. Each High Elf, Khajiit, and Wood Elf adventurer may reduce the difficulty of this check by 1. If unsuccessful, Castle Black Boot is closed for this encounter and you must proceed directly to the End of Day Phase.\n[" .. Color.fromString("Green"):toHex() .. "]Shifting Tides[-]: Apply the dominant faction's effect for this town encounter."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 6
      elseif townName    == "Castle Bloodmayne" then
          buttonInn       = true
          buttonQuest     = false
          marketCommon    = 2
          marketLegend    = 2
          trainers        = 3
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Dominion Control[-]: At the start of this encounter, the party must make a social check (Adv. Count X 3). If the Aldmeri Dominion is dominant, or if it is day 1, this check is automatically successful. Each High Elf, Khajiit, and Wood Elf adventurer may reduce the difficulty of this check by 1. If unsuccessful, the inn is closed for this encounter.\n[" .. Color.fromString("Green"):toHex() .. "]Shifting Tides[-]: Apply the dominant faction's effect for this town encounter."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 7
      elseif townName    == "Chalman Keep" then
          buttonInn       = true
          buttonQuest     = false
          marketCommon    = 4
          marketLegend    = 0
          trainers        = 3
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Pact} Control[-]: At the start of this encounter, the party must make a social check (Adv. Count X 3). If the Aldmeri Dominion is dominant, or if it is day 1, this check is automatically successful. Each High Elf, Khajiit, and Wood Elf adventurer may reduce the difficulty of this check by 1. If unsuccessful, the shop and trainers are closed for this encounter.\n[" .. Color.fromString("Green"):toHex() .. "]Shifting Tides[-]: Apply the dominant faction's effect for this town encounter."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 8
      elseif townName    == "Cheydinhal" then
          buttonInn       = true
          buttonQuest     = true
          marketCommon    = 1
          marketLegend    = 3
          trainers        = 5
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Resistance Allies[-]: At the start of this encounter, the party may make a social check (Adv. Count X 2). If successful, the party may search the Conflict Overland Deck for the next delve encounter and set it aside. Shuffle the deck and place the delve encounter on top."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 9
      elseif townName    == "Chorrol" then
          buttonInn       = true
          buttonQuest     = true
          marketCommon    = 4
          marketLegend    = 1
          trainers        = 4
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Little Oak Place[-]: After each time an item is gained from the shop, immediately refill the shop with a new item from the corresponding deck."
          trainerWarrior  = false
          trainerMage     = false
          trainerRogue    = true
          pdfPage         = 10
      elseif townName    == "Cropsford" then
          buttonInn       = true
          buttonQuest     = true
          marketCommon    = 4
          marketLegend    = 2
          trainers        = 4
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Definitely Appropriate[-]: At the start of this encounter, the party may freely gain the 'Seems Like Appropriate Business' side quest, if possible.\n[" .. Color.fromString("Green"):toHex() .. "]Shifting Tides[-]: Apply the dominant faction's effect for this town encounter."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 11
      elseif townName    == "Fort Ash" then
          buttonInn       = true
          buttonQuest     = false
          marketCommon    = 2
          marketLegend    = 2
          trainers        = 3
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Covenant Control[-]: At the start of this encounter, the party must make a social check (Adv. Count X 3). If the Daggerfall Covenant is dominant, this check is automatically successful. Each Breton, Orc, and Redguard adventurer may reduce the difficulty of this check by 1. If unsuccessful, the inn is closed for this encounter.\n[" .. Color.fromString("Green"):toHex() .. "]Shifting Tides[-]: Apply the dominant faction's effect for this town encounter."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 12
      elseif townName    == "Fort Warden" then
          buttonInn       = true
          buttonQuest     = true
          marketCommon    = 4
          marketLegend    = 1
          trainers        = 6
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Covenant Control[-]: At the start of this encounter, the party must make a social check (Adv. Count X 4). If the Daggerfall Covenant is dominant, this check is automatically successful. Each Breton, Orc, and Redguard adventurer may reduce the difficulty of this check by 1. If unsuccessful, Fort Warden is closed for this encounter and you must proceed directly to the End of Day Phase.\n[" .. Color.fromString("Green"):toHex() .. "]Shifting Tides[-]: Apply the dominant faction's effect for this town encounter."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 13
      elseif townName    == "Imperial City" then
          buttonInn       = false
          buttonQuest     = false
          marketCommon    = 0
          marketLegend    = 0
          local bag_objs  = getObjectbyName("Skill Tokens Bag").getObjects()
          trainers        = #bag_objs
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Black Worm Influence[-]: Skip today's Adventurer's Rest step. All skill tokens from the trainer bag are available for this encounter, but each time an adventurer trains a skill line, they must gain 1 overfatigue. Imperial adventuers may choose to gain a light fatigue instead.\n[" .. Color.fromString("Green"):toHex() .. "]Shifting Tides[-]: Apply the dominant faction's effect for this town encounter."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 14
      elseif townName    == "Kingscrest Keep" then
          buttonInn       = true
          buttonQuest     = true
          marketCommon    = 3
          marketLegend    = 2
          trainers        = 6
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Pact Control[-]: At the start of this encounter, the party must make a social check (Adv. Count X 4). If the Ebonheart Pact is dominant, this check is automatically successful. Each Argonian, Dark Elf, and Nord adventurer may reduce the difficulty of this check by 1. If unsuccessful, Kingscrest Keep is closed for this encounter and you must proceed directly to the End of Day Phase.\n[" .. Color.fromString("Green"):toHex() .. "]Shifting Tides[-]: Apply the dominant faction's effect for this town encounter."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 15
      elseif townName    == "Vlastarus" then
          buttonInn       = true
          buttonQuest     = true
          marketCommon    = 2
          marketLegend    = 1
          trainers        = 4
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Armory Stock[-]: All items in the shop must be Weapon or Armor (Not yet scripted - manually pull). All items that are drawn and replaced when populating the shop are shuffled back into their respective decks afterwards. The shop remains open even if the Daggerfall Covenant is the dominant faction.\n[" .. Color.fromString("Green"):toHex() .. "]Shifting Tides[-]: Apply the dominant faction's effect for this town encounter."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 16
      end

  elseif currentProvince == "High Rock" then
      if townName        == "Traveling Caravan" then
          buttonInn       = false
          buttonQuest     = true
          marketCommon    = 8
          marketLegend    = 0
          trainers        = 2
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Malicious Mistrust[-]: At the start of this encounter, the party must make a social check determined by the current unrest level:\n\n Peaceful (Adv. Count X 1), Tense (Adv. Count X 2), Dangerous (Adv. Count X 3), Chaotic (Adv. Count X 4)\n\nAdventurers may roll Combat skill dice as if they are Speech skill dice. Adventurers do not get tenacity from Tenacity results. If unsuccessful, each adventurer must discard an item or be dealt 2 damage."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 4
      elseif townName    == "Alcaire Castle" then
          buttonInn       = true
          buttonQuest     = false
          marketCommon    = 4
          marketLegend    = 0
          trainers        = 4
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Edric's Greed[-]: At the start of this encounter, the party may freely gain the Dark Forces of Greed side quest."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 5
      elseif townName    == "Camlorn" then
          buttonInn       = false
          buttonQuest     = false
          marketCommon    = 2
          marketLegend    = 2
          trainers        = 3
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Faolchu's Regiment[-]: After all adventurers have taken all of their town actions, if the unrest level is at Tense or higher, each adventurer must exhaust Adv. Count availble skill dice (or as many as possible)."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 6
      elseif townName    == "Crosswych" then
          buttonInn       = true
          buttonQuest     = true
          marketCommon    = 3
          marketLegend    = 0
          trainers        = 5
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Spirit of Resistance[-]: At the start of this encounter, if the unrest level is at Dangerous or higher, each adventurer may remove 1 die from their cooldown track."
          trainerWarrior  = false
          trainerMage     = false
          trainerRogue    = true
          pdfPage         = 7
      elseif townName    == "Daggerfall" then
          buttonInn       = true
          buttonQuest     = true
          marketCommon    = 4
          marketLegend    = 1
          trainers        = 5
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Covenant Namesake[-]: The first time a Breton, Orc, or Redguard adventurer takes a quest board town action this encounter, they may keep both side quests they draw."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 8
      elseif townName    == "Evermore" then
          buttonInn       = true
          buttonQuest     = true
          marketCommon    = 0
          marketLegend    = 4
          trainers        = 5
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Watchful Eyes[-]: If the unrest level is at Dangerous or higher, the shop is closed for this encounter. If unrest is reduced below Dangerous during this town encounter, the shop opens and is populated at that time."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 9
      elseif townName    == "Fell's Run" then
          buttonInn       = true
          buttonQuest     = true
          marketCommon    = 2
          marketLegend    = 3
          trainers        = 3
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Bitterhand Influence[-]: At the start of this encounter, if the unrest level is at Tense or higher, each adventurer must discard 1 item, if possible."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 10
      elseif townName    == "Fharun Stronghold" then
          buttonInn       = false
          buttonQuest     = true
          marketCommon    = 0
          marketLegend    = 0
          trainers        = 4
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Unstable Strife[-]: At the start of this encounter, if the unrest level is at Tense or lower, increase unreast by 1. If the unrest level is at Dangerous or higher, decrease unrest by 1."
          trainerWarrior  = true
          trainerMage     = false
          trainerRogue    = false
          pdfPage         = 11
      elseif townName    == "Morkul Stronghold" then
          buttonInn       = true
          buttonQuest     = false
          marketCommon    = 3
          marketLegend    = 1
          trainers        = 3
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Insular[-]: If the unrest level is at Dangerous or higher, the inn is closed for this encounter. The party may make a social check (Adv. Count X 3). If successful, the inn is open."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 12
      elseif townName    == "Northpoint" then
          buttonInn       = true
          buttonQuest     = true
          marketCommon    = 3
          marketLegend    = 3
          trainers        = 3
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Smuggler's Haven[-]: The first time a single adventurer takes a shop town action this encounter, they may gain 2 items instead of 1. If the unrest level is at Dangerous (neither higher nor lower), each adventurer may do this the first time they take a town action this encounter."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 13
      elseif townName    == "Orsinium" then
          buttonInn       = true
          buttonQuest     = true
          marketCommon    = 4
          marketLegend    = 2
          trainers        = 5
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Kurog's Legacy[-]: Each time a Warrior type skill line is trained, increase unrest by 1. This effect is ignored on day 1."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 14
      elseif townName    == "Shornhelm" then
          buttonInn       = true
          buttonQuest     = true
          marketCommon    = 3
          marketLegend    = 1
          trainers        = 0
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]A City Divided[-]: Before populating trainers, subtract a number of trainers based on the current unrest level (then manually draw from skill bag).\n\nPeaceful: 0, Tense: 2, Dangerous: 4, Chaotic: 6"
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 15
      elseif townName    == "Wayrest" then
          buttonInn       = true
          buttonQuest     = true
          marketCommon    = 3
          marketLegend    = 2
          trainers        = 5
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Suspicious of Outsiders[-]: If the unrest level is at Dangerous or higher, adventurers have 1 fewer town action this encounter."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 16
      end

  elseif currentProvince == "Morrowind" then
      if townName        == "Traveling Caravan" then
          buttonInn       = false
          buttonQuest     = true
          marketCommon    = 0
          marketLegend    = 6
          trainers        = 5
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Dismaying Delays[-]: Each adventurer has 2 fewer town actions. At the start of this encounter, the party may choose to increase the Dig track by 1 to give each adventurer an additional town action. This may be done multiple times, up until the Excavation Track is increased."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 4
      elseif townName    == "Balmora" then
          buttonInn       = true
          buttonQuest     = true
          marketCommon    = 4
          marketLegend    = 0
          trainers        = 5
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]House Brother's Guidance[-]: After populating trainers, each adventurer may discard an item to (manually) replace 1 of the drawn skill lines with a Warrior type skill line of their choice from the trainer bag."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 5
      elseif    townName == "Davon's Watch" then
          buttonInn       = true
          buttonQuest     = false
          marketCommon    = 4
          marketLegend    = 2
          trainers        = 4
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Besieged[-]: If this is the party's first visit to Davon's Watch this campaign, the first town action taken must be the Army of the Dead town square action. This is considered a free town action. The party may choose to ignore this effect if each adventurer either discards 2 items or gains 2 overfatigue. Then, log the visit in your campaign journal."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 6
      elseif townName == "Ebonheart" then
          buttonInn       = true
          buttonQuest     = true
          marketCommon    = 6
          marketLegend    = 0
          trainers        = 5
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Strie in the Pact[-]: Argonian adventurers cannot take inn town actions. Dark Elf adventurers cannot take trainer town actions. Nord adventurers cannot take shop town actions. The party may make a social check (Adv. Count X 2) and ignore this effect if successful."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 7
      elseif townName    == "Gnisis" then
          buttonInn       = true
          buttonQuest     = true
          marketCommon    = 0
          marketLegend    = 0
          trainers        = 4
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Fanisea Saram, traveling merchant[-]: If it is day 7 or earlier, the shop is open and (manually) populated with 6 Legendary Items."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 8
      elseif townName    == "Kragenmoor" then
          buttonInn       = true
          buttonQuest     = false
          marketCommon    = 5
          marketLegend    = 1
          trainers        = 3
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Vendetta of House Dres[-]: If the party ever takes the Liberators town square action, Kragenmoor becomes closed for the rest of the campaign, except for quest-specific reasons (log this in your campaign journal)."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 9
      elseif townName    == "Mournhold" then
          buttonInn       = true
          buttonQuest     = true
          marketCommon    = 3
          marketLegend    = 5
          trainers        = 6
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Bustling Capital[-]: Each adventurer has 1 additional town action. If this is the party's first visit to Mournhold this campaign. the first town action taken must be the Registration town square action. Then, log this visit in your campaign journal."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 10
      elseif townName    == "Narsis" then
          buttonInn       = false
          buttonQuest     = true
          marketCommon    = 5
          marketLegend    = 1
          trainers        = 5
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Plague Ridden[-]: After each time an adventurer takes a town action, they must roll 1 D6. On a 1-3, they gain 2 light fatigue or are dealt 1 true damage. This effect is ignored on day 1."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 11
      elseif townName    == "Necrom" then
          buttonInn       = true
          buttonQuest     = true
          marketCommon    = 6
          marketLegend    = 2
          trainers        = 5
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Bounding Ritual[-]: At the start of this encounter, the party gains the following Persistent effect: For the rest of the session, after a full party defeat, the party may be placed in Necrom instead of in the closest town. Doing so revives each adventurer to full HP."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 12
      elseif townName    == "Sadrith Mora" then
          buttonInn       = true
          buttonQuest     = false
          marketCommon    = 2
          marketLegend    = 3
          trainers        = 4
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Outside the Pact[-]: At the start of this encounter, each adventurer may discard 1 Legendary Item to gain 1 additional town action."
          trainerWarrior  = false
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 13
      elseif townName    == "Sailenmora" then
          buttonInn       = false
          buttonQuest     = true
          marketCommon    = 0
          marketLegend    = 0
          trainers        = 3
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Baandari Merchants[-]: At the start of this encounter, each adventurer may draw 1 Common Item. Each adventurer that does so must then discard 1 Common Item."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 14
      elseif townName    == "Silent Mire" then
          buttonInn       = false
          buttonQuest     = true
          marketCommon    = 3
          marketLegend    = 0
          trainers        = 3
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]A Pirate's Calling[-]: At the start of this encounter, the party may freely gain The Prodigal Bandit side quest, if possible."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 15
      elseif townName    == "Vivec City" then
          buttonInn       = true
          buttonQuest     = true
          marketCommon    = 3
          marketLegend    = 4
          trainers        = 5
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Shadow of Baar Dau[-]: Adventurers must spend 1 tenacity in order to take a second town action. This effect is ignored on day 1."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 16
      end

  elseif currentProvince == "Eastern Skyrim" then
      if townName        == "Traveling Caravan" then
          buttonInn       = false
          buttonQuest     = true
          marketCommon    = 0
          marketLegend    = 6
          trainers        = 5
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Dismaying Delays[-]: Each adventurer has 2 fewer town actions. At the start of this encounter, the party may choose to increase the Dig track by 1 to give each adventurer an additional town action. This may be done multiple times, up until the Excavation Track is increased."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 4
      elseif townName    == "Fort Amol" then
          buttonInn       = true
          buttonQuest     = true
          marketCommon    = 2
          marketLegend    = 1
          trainers        = 4
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Pact Meeting Ground[-]: If this town is under siege, Nord, Dark Elf, and Argonian adventurers may add 1 enemy Combat die to each of their engaes made in One Hand, Two Hand, or Bow Battle Forms."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 7
      elseif townName    == "Fort Morvunskar" then
          buttonInn       = true
          buttonQuest     = true
          marketCommon    = 0
          marketLegend    = 0
          trainers        = 4
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Keepers of the Crypts[-]: If this town is under siege, level 10: Nord Swordmaster becomes a companion controlled by the party for this clash. If Adv. Count is 3+ use level 20: Nord Pyromancer instead."
          trainerWarrior  = true
          trainerMage     = false
          trainerRogue    = false
          pdfPage         = 8
      elseif townName    == "Fullhelm Fort" then
          buttonInn       = true
          buttonQuest     = true
          marketCommon    = 8
          marketLegend    = 0
          trainers        = 0
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Ironhand's Oath[-]: If this town is under siege, each adventurer gains 1 additional town action but does not gain a free town action upon defeating all enemies. If there are undefeated enemies at the end of this encounter, this town is closed for the rest of the campaign (log this in your campaign journal)."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 9
      elseif townName    == "Ivarstead" then
          buttonInn       = true
          buttonQuest     = true
          marketCommon    = 3
          marketLegend    = 2
          trainers        = 3
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Adla's Wares[-]: All items in the shop must be Food or Potion. All other items that are drawn and replaced when populating the shop are shuffled back into their respective decks."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 10
      elseif townName    == "Jorunn's Stand" then
          buttonInn       = false
          buttonQuest     = true
          marketCommon    = 2
          marketLegend    = 1
          trainers        = 4
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Easy Mark[-]: If this town is under siege, add Adv. Count level 1 enemies to the EP and deploy them last."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 11
      elseif townName    == "Mistwatch" then
          buttonInn       = false
          buttonQuest     = true
          marketCommon    = 0
          marketLegend    = 0
          trainers        = 4
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Spirits of the Crevasse[-]: If the party is on a Psijic Order or Undaunted quest, adventurers may take guild kiosk town actions. If this town is under siege, this town action must be taken in the town square. The first time this encounter that an adventurer takes the Undaunted guild kiosk town action, populate a shop of 4 Common Items."
          trainerWarrior  = true
          trainerMage     = false
          trainerRogue    = false
          pdfPage         = 17
      elseif townName    == "Nimalten" then
          buttonInn       = true
          buttonQuest     = true
          marketCommon    = 04
          marketLegend    = 4
          trainers        = 2
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Nimalten Barrow[-]: If the town is under siege, party members occupying the town square building cannot target or be targeted by units not occupying the town square."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 20
      elseif townName    == "Riften" then
          buttonInn       = true
          buttonQuest     = true
          marketCommon    = 4
          marketLegend    = 1
          trainers        = 6
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Ruins of Sinmur[-]: At the start of this encounter, 1 adventurer must roll 1 D6. If the adventurer's class is a Warrior type, or if it is day 1, they may re-roll the D6 once. The rolled result is closed for this encounter.\n\n1: Shop, 2: Trainers, 3: Inn, 4: Quest Board and Alchemy Station, 5: Guild Kiosk, 6: Town Square"
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 22
      elseif townName    == "Shor's Stone" then
          buttonInn       = true
          buttonQuest     = true
          marketCommon    = 5
          marketLegend    = 0
          trainers        = 5
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Mining Town[-]: At the start of this encounter, each adventurer with a Warrior type class gains 1 tenacity."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 23
      elseif townName    == "Skald's Retreat" then
          buttonInn       = true
          buttonQuest     = false
          marketCommon    = 0
          marketLegend    = 0
          trainers        = 3
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Song of Awakening[-]: At the start of this encounter, the party may freely gain the Bard Harder side quest, if available."
          trainerWarrior  = false
          trainerMage     = true
          trainerRogue    = false
          pdfPage         = 25
      elseif townName    == "Windhelm" then
          buttonInn       = true
          buttonQuest     = true
          marketCommon    = 4
          marketLegend    = 2
          trainers        = 6
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Eating Contests[-]: At the start of this encounter, each adventurer must discard all Food in their inventory. Then, they gain 1 tenacity for each item they discarded. This effect is ignored on day 1 or if the town is under siege."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 27
      elseif townName    == "Wittestadr" then
          buttonInn       = true
          buttonQuest     = false
          marketCommon    = 0
          marketLegend    = 0
          trainers        = 3
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Soothing Hot Springs[-]: After an adventurer takes an inn town action, they gain 2 bonus HP."
          trainerWarrior  = false
          trainerMage     = false
          trainerRogue    = true
          pdfPage         = 28
      end

  elseif currentProvince == "Western Skyrim" then
      if townName        == "Traveling Caravan" then
          buttonInn       = false
          buttonQuest     = true
          marketCommon    = 2
          marketLegend    = 3
          trainers        = 5
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Winds of Change[-]: At the start of this encounter, each adventurer must spend 2 tenacity, untrain a skill line (and all dice in that line), or flip their class sheet to the opposite side."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 4
      elseif townName    == "Dragon Bridge" then
          buttonInn       = true
          buttonQuest     = true
          marketCommon    = 0
          marketLegend    = 0
          trainers        = 5
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Dragon Bridge Garrison[-]: If this town is under siege and the party defeats or otherwise removes all enemies, gain 1 XP instead of gaining the free town action."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 5
      elseif townName    == "Entrance To Dusktown" then
          buttonInn       = true
          buttonQuest     = true
          marketCommon    = 2
          marketLegend    = 2
          trainers        = 4
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Bitterblade Mining Consortium[-]: The first time that trainers are populated each encounter, the party may choose to (manually) discard all of them and repopulate new ones."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 6
      elseif townName    == "Karthwasten" then
          buttonInn       = false
          buttonQuest     = true
          marketCommon    = 0
          marketLegend    = 0
          trainers        = 3
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Siege of the Harrowed[-]: If this town is under siege, each enemy gains enemy skills: Decay and Rot. Adventurers cannot take town actions in buildings that enemies are occupying."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 12
      elseif townName    == "Karthwatch" then
          buttonInn       = true
          buttonQuest     = false
          marketCommon    = 0
          marketLegend    = 0
          trainers        = 2
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Desolate[-]: If this is the first time the party has visited Karthwatch this campaign, do not advance the Day Dial at the start of the next New Day Phase. Log this visit in your campaign journal."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 13
      elseif townName    == "Kilkreath Temple" then
          buttonInn       = true
          buttonQuest     = true
          marketCommon    = 0
          marketLegend    = 0
          trainers        = 5
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Temple to Meridia[-]: If the party is on a Mages Guild or Fighters Guild quest, adventurers may take guild kiosk town actions. If this town is under siege, this town action must be taken in the town square."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 14
      elseif townName    == "Lost Valley Redoubt" then
          buttonInn       = false
          buttonQuest     = true
          marketCommon    = 0
          marketLegend    = 6
          trainers        = 0
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]There for the Taking[-]: At the start of this encounter, 1 adventurer must make a lockpick check of 1-5-3 (2 attempts). If successful, adventurers may gain 2 items instead of 1 when taking shop town actions. If unsuccessful, the shop is closed for the rest of the encounter."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 15
      elseif townName    == "Markarth" then
          buttonInn       = true
          buttonQuest     = true
          marketCommon    = 4
          marketLegend    = 1
          trainers        = 6
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Reachfolk Stronghold[-]: If this town is under siege, level 20: Briarheart becomes a companion controlled by the party for this clas. If Adv. Count is 3+ use level 10: Reachman instead."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 16
      elseif townName    == "Mor Khazgur" then
          buttonInn       = false
          buttonQuest     = true
          marketCommon    = 3
          marketLegend    = 0
          trainers        = 2
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Friend to Fighters[-]: If at least 1 party member is an Orc, or if the party is on a Circle of Champions quest, each adventurer may take a free guild kiosk town action."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 18
      elseif townName    == "Morthal" then
          buttonInn       = true
          buttonQuest     = true
          marketCommon    = 2
          marketLegend    = 2
          trainers        = 3
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Arsonists[-]: If this town is under siege and a party member takes damage while occupying a building, that building is closed for the rest of the encounter. Flip the building facedown. Each unit occupying the building is dealt 1 true damage and is placed in the closest unoccupied hex outside of that building. The building is now impassable."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 19
      elseif townName    == "Rebel's Retreat" then
          buttonInn       = false
          buttonQuest     = true
          marketCommon    = 4
          marketLegend    = 1
          trainers        = 2
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Arsonists[-]: If this town is under siege and a party member takes damage while occupying a building, that building is closed for the rest of the encounter. Flip the building facedown. Each unit occupying the building is dealt 1 true damage and is placed in the closest unoccupied hex outside of that building. The building is now impassable."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 21
      elseif townName    == "The Silver Cormorant" then
          buttonInn       = true
          buttonQuest     = true
          marketCommon    = 0
          marketLegend    = 0
          trainers        = 3
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Easy Mark[-]: If this town is under siege, add Adv. Count level 1 enemies to the EP and deploy them first."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 24
      elseif townName    == "Solitude" then
          buttonInn       = true
          buttonQuest     = true
          marketCommon    = 3
          marketLegend    = 2
          trainers        = 6
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Shadow of the Blue Palace[-]: If this town is under siege, reduce the calculated EP by 4 (to a minimum of 1)."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 26
      end
  elseif currentProvince == "Valenwood" then
      if townName        == "Traveling Caravan" then
          buttonInn       = false
          buttonQuest     = true
          marketCommon    = 0
          marketLegend    = 0
          trainers        = 0
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Off the Beaten Path[-]: At the start of this encounter, you must log this visit in the campaign journal. Then, each adventurer is dealt true damage equal to the number of times the party has visited this caravan. If this damage would defeat an adventurer, they instead remain at 1HP."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 3
      elseif townName    == "Arenthia" then
          buttonInn       = true
          buttonQuest     = true
          marketCommon    = 5
          marketLegend    = 1
          trainers        = 6
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Colovian Influence[-]: Imperial adventurers may draw 2 Legendary Items when taking the town square action, choosing 1 to gain and 1 to discard."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 4
      elseif townName    == "Baandari Trading Post" then
          buttonInn       = true
          buttonQuest     = false
          marketCommon    = 6
          marketLegend    = 2
          trainers        = 3
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]The Bylaw of Salvage[-]: At the start of this encounter, 1 adventurer must make a lockpick check of 6-5-4 (3 attempts). If unsuccessful, each adventurer must discard 1 item, if possible."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 5
      elseif townName    == "Dread Vullain" then
          buttonInn       = false
          buttonQuest     = true
          marketCommon    = 3
          marketLegend    = 2
          trainers        = 0
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Blessings of the Blackroot[-]: At the start of this encounter, each adventurer may place a Bane status die on their class card. Then, gain the following Persistent effect: At the start of the next clash, each adventurer may apply the Bane status die on their class card to a non-quest enemy of their choice. If they do not, the Bane die is discarded."
          trainerWarrior  = false
          trainerMage     = false
          trainerRogue    = false
          pdfPage         = 6
      elseif townName    == "Elden Root" then
          buttonInn       = true
          buttonQuest     = true
          marketCommon    = 3
          marketLegend    = 3
          trainers        = 6
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Dominion Capital[-]: At the end of this encounter, you may move the party token 1 hex. If there is at least 1 High Elf, Khajiit, or Wood Elf adventurer in the party, you may move the party token up to 2 hexes instead."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 7
      elseif townName    == "Greenheart" then
          buttonInn       = false
          buttonQuest     = true
          marketCommon    = 4
          marketLegend    = 0
          trainers        = 0
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Seat of the Wilderqueen[-]: At the start of this encounter, you may make a social check (Adv. Count X 4). If successful, gain the following Persistent effect: For the rest of the current session, you may ignore enemy skill: Native."
          trainerWarrior  = false
          trainerMage     = false
          trainerRogue    = false
          pdfPage         = 8
      elseif townName    == "Haven" then
          buttonInn       = true
          buttonQuest     = true
          marketCommon    = 3
          marketLegend    = 1
          trainers        = 6
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Epicenter of Trade[-]: After each time an adventurer visits the trainer, draw a new token from the trainer bag and add it to the skill lines available to be trained."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 9
      elseif townName    == "Marbruk" then
          buttonInn       = true
          buttonQuest     = true
          marketCommon    = 3
          marketLegend    = 1
          trainers        = 4
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Vibrant Underworld[-]: If the party is on a quest for the Thieves Guild, Dark Brotherhood, Undaunted, or Eyes of the Queen, each adventurer may take a free guild kiosk town action during this encounter."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 10
      elseif townName    == "Silvenar" then
          buttonInn       = false
          buttonQuest     = false
          marketCommon    = 1
          marketLegend    = 2
          trainers        = 4
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Sentinals of the Green Lady[-]: At the start of this encounter, the party may freely gain the Power of Teamwork side quest, if available."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 11
      elseif townName    == "Southpoint" then
          buttonInn       = true
          buttonQuest     = true
          marketCommon    = 4
          marketLegend    = 3
          trainers        = 5
          encounterTTip   = ""
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 12
      elseif townName    == "Velyn Harbor" then
          buttonInn       = true
          buttonQuest     = true
          marketCommon    = 3
          marketLegend    = 2
          trainers        = 4
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Harbor Customs Hall[-]: After each time an adventurer takes a shop town action, they may discard an item from their inventory to take a free inn town action."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 13
      elseif townName    == "Willowgrove" then
          buttonInn       = false
          buttonQuest     = true
          marketCommon    = 5
          marketLegend    = 0
          trainers        = 2
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Green Pact Devotion[-]: At the start of this encounter, each adventurer must discard all Food items in their inventory. Then, each adventurer heals for 1 HP for each Common Food Item and 2 HP for each Legendary Food Item they discarded that does not have any of the following traits: Fruit, Grain, Salad, or Vegetable."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 14
      elseif townName    == "Woodhearth" then
          buttonInn       = true
          buttonQuest     = true
          marketCommon    = 3
          marketLegend    = 1
          trainers        = 6
          encounterTTip   = "[" .. Color.fromString("Green"):toHex() .. "]Thalmor Outpost[-]: After each time an adventurer takes an inn town action, they may gain 2 tenacity."
          trainerWarrior  = true
          trainerMage     = true
          trainerRogue    = true
          pdfPage         = 15
      end
  end

  -- get item decks, skill token bag
  local commonDeck = getObjectbyName("Common Items")
  local legendDeck = getObjectbyName("Legendary Items")
  local trainerBag = getObjectbyName("Skill Tokens Bag")
  if not trainerBag then log("setupTownEncounter() trainerBag not found") return end
  if commonDeck == nil then
    local zoneDeckCommon = getObjectFromGUID("0ec927")
    for _, object in pairs(zoneDeckCommon.getObjects()) do
      if object.type == "Deck" then
        commonDeck = object
      end
    end
  end
  if legendDeck == nil then
    zoneDeckLegend = getObjectFromGUID("254628")
    for _, object in pairs(zoneDeckLegend.getObjects()) do
      if object.type == "Deck" then
        legendDeck = object
      end
    end
  end
  if commonDeck == nil or legendDeck == nil then
    broadcastToAll("One of the item decks not found. Manual setup of Town Encounter will be required.", "Orange")
    return
  end

  -- deal market item cards
  for i = 1, marketCommon do
    local dealCard = commonDeck.takeObject()
    dealCard.addTag('common_item')
    dealCard.setRotation({0, 180, 0})
    dealCard.setPositionSmooth(posCommonItems[i])
  end
  for i = 1, marketLegend do
    local dealCard = legendDeck.takeObject()
    dealCard.addTag('legend_item')
    dealCard.setRotation({0, 180, 0})
    dealCard.setPositionSmooth(posLegendaryItems[i])
  end

  -- deal trainer tokens
  trainerBag.shuffle()
  for i = 1, trainers do
    local foundToken = false
    local bagObjects = trainerBag.getObjects()
    for index, object in ipairs(bagObjects) do
      local objTags = object.tags or {}
      for _, tag in ipairs(objTags) do
        if (tag == "skill_token_warrior" and trainerWarrior) or
           (tag == "skill_token_mage" and trainerMage) or
           (tag == "skill_token_rogue" and trainerRogue) then

          local dealToken = trainerBag.takeObject({ guid = object.guid })
          -- handle shaerza's upside down assets
          if dealToken.getName() == "Daedric Summoning Skill Line Token" or
          dealToken.getName() == "Illusion Skill Line Token" then
            dealToken.setRotation({ 0, 0, 0 })
          else
            dealToken.setRotation({ 0, 180, 0 })
          end
          dealToken.setPositionSmooth(posTrainers[i])

          table.remove(bagObjects, index) -- prevent reusing the same token
          foundToken = true
          break
        end
      end
      if foundToken then break end
    end
  end

  -- clone, place gazetteer
  local townDisplay = gazetteer.clone()
  Wait.frames(function()
    local scaleTownDisplay = { 5.25, 1.00, 5.25 }
    local rotTownDisplay = { 0, 180, 0 }
    local posTownDisplay = { -20.31, 1.24, 8.52 }
    townDisplay.setScale(scaleTownDisplay)
    townDisplay.setRotation(rotTownDisplay)
    townDisplay.setPosition(posTownDisplay)
    townDisplay.addTag("town_display_gazetteer")
    townDisplay.Book.setPage(pdfPage)
  end)

  --- place inn, side quest buttons if required
  if buttonInn then
    local buttonInn = getObjectbyName("Bag Button Inn").takeObject()
    Wait.frames(function()
      local rotButtonInn = { 0, 180, 0 }
      local posButtonInn = { -9.50, 1.24, 0.00 }
      buttonInn.setLock(true)
      buttonInn.interactable = false
      buttonInn.setRotation(rotButtonInn)
      buttonInn.setPosition(posButtonInn)
    end)
  end
  if buttonQuest then
    local buttonQuest = getObjectbyName("Bag Button Side Quest").takeObject()
    Wait.frames(function()
      local rotButtonQuest = { 0, 180, 0 }
      local posButtonQuest = { -9.50, 1.24, 5.00 }
      buttonQuest.setLock(true)
      buttonQuest.interactable = false
      buttonQuest.setRotation(rotButtonQuest)
      buttonQuest.setPosition(posButtonQuest)
    end)
  end

  broadcastToAll("[" .. Color.fromString("Yellow"):toHex() .. "]" .. townName .. "[-]: Town Encounter Intiated." , "White")
  Wait.time(function() if townName ~= "Southpoint" then printToAll(encounterTTip, "White") end end, 1.5)
end


function setupUnstableEncounter()
  local dieUnstable = getObjectbyName("Unstable Die")
  local scaleDie = { 3, 3, 3 }
  local posDie = { -23, 2.13, -10 }
  dieUnstable.setScale(scaleDie)
  dieUnstable.setPositionSmooth(posDie, false, true)
  broadcastToAll("Unstable Encounter - Once Unstable Die rolls, use 'Setup Encounter' button again to trigger encounter for Unstable Die result.", "White")

  Wait.time(function()

    dieUnstable.setVar("just_rolled", true)
    dieUnstable.roll()

    function coroutine_monitor_dieUnstable()
      repeat
        if dieUnstable.resting then break end
        coroutine.yield(0)
      until false
      local value = dieUnstable.getRotationValue()
      dieUnstable.setRotationValue(value)
      dieUnstable.setVar('just_rolled', false)
      return 1
    end

    startLuaCoroutine(self, "coroutine_monitor_dieUnstable")

  end, 1)
end


function cleanupEncounter(button, _, _)

  -- this function handles the cleanup of the currently active encounter

  animateButtonsEncounter(button)

  local encounterZone = getObjectFromGUID("fecaa4")
  local rotFaceUp = { 0, 180, 0 }
  local rotFaceDown = { 0, 180, 180 }
  local posCommonItems = { 57.54, 2.00, -2.83 }
  local posLegendaryItems = { 61.66, 2.00, -2.85 }
  local posPeacefuls = { 44.98, 1.5, -2.83 }
  local posConflicts = { 49.16, 1.5, -2.83 }
  local bagSkillTokens = getObjectbyName("Skill Tokens Bag")
  for _, object in pairs(encounterZone.getObjects()) do
    -- cleanup placed skill tokens
    if string.find(object.getName(), "Skill Line Token") then
      bagSkillTokens.putObject(object)
    end

    -- cleanup placed market cards    
    if object.type == "Card" then
      if object.hasTag('common_item') then -- common
        object.removeTag('common_item')
        object.setRotation(rotFaceUp)
        object.setPositionSmooth(posCommonItems, false, false)

      elseif object.hasTag('legend_item') then -- legendary
        object.removeTag('legend_item')
        object.setRotation(rotFaceUp)
        object.setPositionSmooth(posLegendaryItems, false, false)

      elseif object.hasTag('peaceful_encounter') then -- peaceful
        object.removeTag('peaceful_encounter')
        object.setRotation(rotFaceDown)
        object.setPositionSmooth(posPeacefuls, false, false)

      elseif object.hasTag('conflict_encounter') then -- conflict
        object.removeTag('conflict_encounter')
        object.setRotation(rotFaceDown)
        object.setPositionSmooth(posConflicts, false, false)      
      end
    end
  end

  -- clear active encounter card
  local zoneActiveEncounter = getObjectFromGUID("8347e9")
  for _, object in pairs(zoneActiveEncounter.getObjects()) do
    if object.hasTag('peaceful_encounter') then -- peaceful
      object.removeTag('peaceful_encounter')
      object.setRotation(rotFaceDown)
      object.setPositionSmooth(posPeacefuls, false, false)

    elseif object.hasTag('conflict_encounter') then -- conflict
      object.removeTag('conflict_encounter')
      if object.hasTag('conflict_selected') then
        object.removeTag('conflict_selected')
      end
      object.setRotation(rotFaceDown)
      object.setPositionSmooth(posConflicts, false, false)
    end
  end

  -- clean up town encounter gazetteer
  for _, object in pairs(getObjects()) do
    if object.hasTag("town_display_gazetteer") then
      object.destruct()
    end
  end

  -- clean up inn / quest buttons
  for _, object in pairs(getObjects()) do
    if object.hasTag('button_inn') or object.hasTag('button_quest') then
      object.destruct()
    end
  end

  -- send loose side quests to discard
  local zoneBattleArea = getObjectFromGUID("b5dd6d")
  local posDiscardSideQuest = {63.78, 2.00, 3.31}
  for _, object in pairs(zoneBattleArea.getObjects()) do
    if object.hasTag('side_quest') then
      object.setRotation(rotFaceDown)
      object.setPositionSmooth(posDiscardSideQuest, false, true)
    end
  end
end


function onObjectRotate(object, spin, flip, playerColor, oldSpin, oldFlip)

  -- this function checks rotated objects to see if they're active conflict cards,
  -- inits conflict setup buttons on card
  local rotTolerance = 5
  if (math.abs(object.getRotation().z) < rotTolerance) or (math.abs(object.getRotation().z - 360) < rotTolerance) then
    local pos = object.getPosition()
    local tolerance = 0.50
    if (math.abs(pos.x + 38.88) < tolerance) and (math.abs(pos.z + 2.53) < tolerance) then
      initButtonsConflictSelect(object)
    end
  end
end


function getConflictButtonDetails(cardName)

  -- this function returns the height and position values for the conflict select buttons, based on card name
  -- will return nil for value if button does not exist on card (1 to 3 buttons possible per card)
  local posButton1 = nil
  local posButton2 = nil
  local posButton3 = nil
  local heightButton1 = nil
  local heightButton2 = nil
  local heightButton3 = nil
  
  -- GENERAL CONFLICT ENCOUNTERS
  if cardName == "Wabbajack Attack" then
    posButton1 = { -0.02, -0.21, -1.29 }
    heightButton1 = 60
    posButton2 = { -0.02, -0.21, 0.835 }
    heightButton2 = 60

  elseif cardName == "Forever Mine" then
    posButton1 = { -0.02, -0.21, -1.28 }
    heightButton1 = 60
    posButton2 = { -0.02, -0.21, 0.34 }
    heightButton2 = 65

  elseif cardName == "The Wacky Box of Wonders" then
    posButton1 = { -0.02, -0.21, -1.175 }
    heightButton1 = 200

  elseif cardName == "Highwaymen" then
    posButton1 = { -0.02, -0.21, -1.25 }
    heightButton1 = 60
    posButton2 = { -0.02, -0.21, 0.65 }
    heightButton2 = 60

  elseif cardName == "The \"Well\" of \"Life\"" then
    posButton1 = { -0.02, -0.21, -1.28 }
    heightButton1 = 60
    posButton2 = { -0.02, -0.21, -0.185 }
    heightButton2 = 65

  elseif cardName == "Captured!" then
    posButton1 = { -0.02, -0.21, -1.27 }
    heightButton1 = 60
    posButton2 = { -0.02, -0.21, 0.86 }
    heightButton2 = 60

  elseif cardName == "Unsullied Pool" then
    posButton1 = { -0.02, -0.21, -1.27 }
    heightButton1 = 60
    posButton2 = { -0.02, -0.21, 0.665 }
    heightButton2 = 60

  elseif cardName == "Broken Bones" then
    posButton1 = { -0.02, -0.21, -1.28 }
    heightButton1 = 60
    posButton2 = { -0.02, -0.21, 0.44 }
    heightButton2 = 60

  elseif cardName == "Black Market Economics" then
    posButton1 = { -0.02, -0.21, -1.225 }
    heightButton1 = 70
    posButton2 = { -0.02, -0.21, -0.52 }
    heightButton2 = 60

  elseif cardName == "Keep Away" then
    posButton1 = { -0.02, -0.21, -1.28 }
    heightButton1 = 60

  -- BLACK MARSH CONFLICT ENCOUNTERS
  elseif cardName == "Captives of House Telvanni" then
    posButton1 = { -0.01, -0.21, -1.26 }
    heightButton1 = 60

  elseif cardName == "Corrupted Communion" then
    posButton1 = { -0.01, -0.21, -1.23 }
    heightButton1 = 70

  elseif cardName == "Deal or Die" then
    posButton1 = { -0.01, -0.21, -1.22 }
    heightButton1 = 70
    posButton2 = { -0.01, -0.21, 0.87 }
    heightButton2 = 60
  
  elseif cardName == "Uncharted Xanmeer" then
    posButton1 = { -0.01, -0.21, -1.228 }
    heightButton1 = 70
    posButton2 = { -0.01, -0.21, 0.468 }
    heightButton2 = 60
  
  elseif cardName == "Keep Ayleid on It" then
    posButton1 = { -0.01, -0.21, -1.262 }
    heightButton1 = 60

  elseif cardName == "Origin of the Species" then
    posButton1 = { -0.01, -0.21, -1.26 }
    heightButton1 = 60

  elseif cardName == "Captive Audience" then
    posButton1 = { -0.01, -0.21, -1.275 }
    heightButton1 = 60

  elseif cardName == "A Pirate's Death For Ye" then
    posButton1 = { 0.00, -0.21, -1.223 }
    heightButton1 = 60
    posButton2 = { 0.00, -0.21, 0.17 }
    heightButton2 = 200

  -- CYRODIIL CONFLICT ENCOUNTERS
  elseif cardName == "War Profiteering" then
    posButton1 = { 0.00, -0.21, -1.265 }
    heightButton1 = 60
    posButton2 = { 0.00, -0.21, -0.015 }
    heightButton2 = 60
    posButton3 = { 0.00, -0.21, .95 }
    heightButton3 = 60

  elseif cardName == "Heroes for Hire" then
    posButton1 = { -0.01, -0.21, -1.27 }
    heightButton1 = 60
    posButton2 = { -0.01, -0.21, -0.50 }
    heightButton2 = 60

  elseif cardName == "Champion of the Downtrodden" then
    posButton1 = { -0.01, -0.21, -1.28 }
    heightButton1 = 60
    posButton2 = { -0.01, -0.21, 0.835 }
    heightButton2 = 60
  
  elseif cardName == "The Poorly-Lit Brotherhood" then
    posButton1 = { -0.01, -0.21, -1.218 }
    heightButton1 = 90
    posButton2 = { -0.01, -0.21, -0.28 }
    heightButton2 = 200
    posButton3 = { -0.01, -0.21, 0.535 }
    heightButton3 = 90
  
  elseif cardName == "Cast Your Lot!" then
    posButton1 = { -0.01, -0.21, -1.26 }
    heightButton1 = 60

  elseif cardName == "Predictive Diplomacy" then
    posButton1 = { -0.01, -0.21, -1.275 }
    heightButton1 = 60

  elseif cardName == "Traders to the Cause" then
    posButton1 = { -0.01, -0.21, -1.27 }
    heightButton1 = 60
    posButton2 = { -0.01, -0.21, -0.40 }
    heightButton2 = 60

  elseif cardName == "Anchors, Away!" then
    posButton1 = { 0.00, -0.21, -1.26 }
    heightButton1 = 60

  -- HIGH ROCK CONFLICT ENCOUNTERS
  elseif cardName == "Supine and Supernal" then
    posButton1 = { -0.01, -0.21, -1.26 }
    heightButton1 = 60
    posButton2 = { -0.01, -0.21, -0.6 }
    heightButton2 = 60

  elseif cardName == "Border Battle" then
    posButton1 = { -0.01, -0.21, -1.22 }
    heightButton1 = 90
    posButton2 = { -0.01, -0.21, -0.365 }
    heightButton2 = 90

  elseif cardName == "Pit Stop" then
    posButton1 = { -0.01, -0.21, -1.265 }
    heightButton1 = 60
    posButton2 = { -0.01, -0.21, 0.54 }
    heightButton2 = 60

  elseif cardName == "Rooks to the Left, Midnight to the Right" then
    posButton1 = { -0.01, -0.21, -1.26 }
    heightButton1 = 60
  
  elseif cardName == "Delving with the Dead" then
    posButton1 = { -0.01, -0.21, -1.26 }
    heightButton1 = 60
    posButton2 = { -0.01, -0.21, 0.50 }
    heightButton2 = 90
  
  elseif cardName == "Cave of Conflict" then
    posButton1 = { -0.01, -0.21, -1.26 }
    heightButton1 = 60
    posButton2 = { -0.01, -0.21, -0.592 }
    heightButton2 = 60
     posButton3 = { -0.01, -0.21, 0.18 }
    heightButton3 = 60

  elseif cardName == "No Unrest for the Wicked" then
    posButton1 = { -0.01, -0.21, -1.26 }
    heightButton1 = 60
    posButton2 = { -0.01, -0.21, -0.24 }
    heightButton2 = 60

  elseif cardName == "Rumormonger" then
    posButton1 = { -0.01, -0.21, -1.275 }
    heightButton1 = 60
    posButton2 = { -0.01, -0.21, -0.37 }
    heightButton2 = 60

  -- MORROWIND CONFLICT ENCOUNTERS
  elseif cardName == "Wrong Side of the Law" then
    posButton1 = { -0.01, -0.21, -1.225 }
    heightButton1 = 60

  elseif cardName == "Not Mushroom to Move" then
    posButton1 = { -0.01, -0.21, -1.265 }
    heightButton1 = 60

  elseif cardName == "Egg Mine? No, Eggs Mine!" then
    posButton1 = { -0.01, -0.21, -1.265 }
    heightButton1 = 60
  
  elseif cardName == "Deals in Dwemer" then
    posButton1 = { 0.00, -0.21, -1.199 }
    heightButton1 = 90
    posButton2 = { 0.00, -0.21, -0.342 }
    heightButton2 = 60
  
  elseif cardName == "Augmented Arms" then
    posButton1 = { -0.01, -0.21, -1.26 }
    heightButton1 = 60

  elseif cardName == "Yours for the Taking" then
    posButton1 = { -0.01, -0.21, -1.26 }
    heightButton1 = 60

  elseif cardName == "No Tresspassing" then
    posButton1 = { 0.00, -0.21, -1.22 }
    heightButton1 = 90
    posButton2 = { 0.00, -0.21, 0.42 }
    heightButton2 = 200

  elseif cardName == "Mystery Under Morrowind" then
    posButton1 = { 0.00, -0.21, -1.27 }
    heightButton1 = 60
    posButton2 = { 0.00, -0.21, 0.543 }
    heightButton2 = 90

  -- SKYRIM CONFLICT ENCOUNTERS
  elseif cardName == "Cold Discomfort" then
    posButton1 = { -0.01, -0.21, -1.27 }
    heightButton1 = 60
    posButton2 = { -0.01, -0.21, 0.70 }
    heightButton2 = 90

  elseif cardName == "A Storm of Fists" then
    posButton1 = { -0.01, -0.21, -1.21 }
    heightButton1 = 90

  elseif cardName == "Mudcrab Crossing" then
    posButton1 = { -0.01, -0.21, -1.21 }
    heightButton1 = 90
  
  elseif cardName == "Phalanges of Fate" then
    posButton1 = { -0.01, -0.21, -1.20 }
    heightButton1 = 90
    posButton2 = { -0.01, -0.21, 0.865 }
    heightButton2 = 60
  
  elseif cardName == "Any Fort in a Harrowstorm" then
    posButton1 = { -0.01, -0.21, -1.27 }
    heightButton1 = 60
    posButton2 = { -0.01, -0.21, 0.12 }
    heightButton2 = 60

  elseif cardName == "Compass of Cruelty" then
    posButton1 = { -0.01, -0.21, -1.20 }
    heightButton1 = 90

  elseif cardName == "Maniacal Monolith" then
    posButton1 = { -0.01, -0.21, -1.26 }
    heightButton1 = 60

  elseif cardName == "Good Finds are Hard to Help" then
    posButton1 = { -0.01, -0.21, -1.26 }
    heightButton1 = 60
    posButton2 = { -0.01, -0.21, 0.589 }
    heightButton2 = 60

  -- VALENWOOD CONFLICT ENCOUNTERS
  elseif cardName == "Forest Fatalities" then
    posButton1 = { -0.01, -0.21, -1.27 }
    heightButton1 = 60
    posButton2 = { -0.01, -0.21, -0.712 }
    heightButton2 = 60

  elseif cardName == "Altar Your Destiny" then
    posButton1 = { -0.01, -0.21, -1.28 }
    heightButton1 = 60
    posButton2 = { -0.01, -0.21, 0.717 }
    heightButton2 = 60

  elseif cardName == "Heeding the Call" then
    posButton1 = { -0.01, -0.21, -1.28 }
    heightButton1 = 60
  
  elseif cardName == "An Enemy In Need" then
    posButton1 = { 0.00, -0.21, -1.232 }
    heightButton1 = 120
    posButton2 = { 0.00, -0.21, -0.468 }
    heightButton2 = 120
  
  elseif cardName == "Vine Snared" then
    posButton1 = { -0.01, -0.21, -1.230 }
    heightButton1 = 120
    posButton2 = { -0.01, -0.21, 0.717 }
    heightButton2 = 60

  elseif cardName == "Dead Mer Tell No Tales" then
    posButton1 = { 0.00, -0.21, -1.28 }
    heightButton1 = 60
    posButton2 = { 0.00, -0.21, 0.11 }
    heightButton2 = 60

  elseif cardName == "Competitive Arvantage" then
    posButton1 = { -0.01, -0.21, -1.285 }
    heightButton1 = 60
    posButton2 = { 0.00, -0.21, 0.20 }
    heightButton2 = 60

  elseif cardName == "Parting the Veiled" then
    posButton1 = { -0.01, -0.21, -1.28 }
    heightButton1 = 60
    posButton2 = { -0.01, -0.21, -0.572 }
    heightButton2 = 120

  end
  return posButton1, heightButton1, posButton2, heightButton2, posButton3, heightButton3
end


function setupConflict1(card, _, _)

  cardName = card.getName()
  
  -- this function handles the setup of the first (top) conflict encounter card option
  
  local ttip = ""
  local isUnstable = false
  local conflictType = nil

  -- GENERAL CONFLICT ENCOUNTERS
  if cardName == "Wabbajack Attack" then
    ttip = "Don't get Cheesed!"
    conflictType = "Clash"

  elseif cardName == "Forever Mine" then
    ttip = "Explore the mine."
    conflictType = "Delve"

  elseif cardName == "The Wacky Box of Wonders" then
    ttip = "You interrupt the bandit solving the puzzle box. A flurry of afflictions fly out."
    conflictType = "Clash"

  elseif cardName == "Highwaymen" then
    ttip = "Sieze the caravan!"
    isUnstable = true
    conflictType = "Clash"

  elseif cardName == "The \"Well\" of \"Life\"" then
    ttip = "Search the \"Well\"."
    conflictType = "Delve"

  elseif cardName == "Captured!" then
    ttip = "Time to get your stuff back!"
    isUnstable = true
    conflictType = "Clash"

  elseif cardName == "Unsullied Pool" then
    ttip = "Hunt the beasts."
    isUnstable = true
    conflictType = "Clash"

  elseif cardName == "Broken Bones" then
    ttip = "Endless skeletons."
    conflictType = "Delve"
  
  elseif cardName == "Black Market Economics" then
    ttip = "And if you can reap the benefits, all the better."
    conflictType = "Clash"

  elseif cardName == "Keep Away" then
    ttip = "These [i]do[/i] look pretty sharp..."
    conflictType = "Clash"

  -- BLACK MARSH CONFLICT ENCOUNTERS
  elseif cardName == "Captives of House Telvanni" then
    ttip = "The locks seem to be loose..."
    conflictType = "Clash"

  elseif cardName == "Corrupted Communion" then
    ttip = "You judge the weight of a non-fatal blow."
    conflictType = "Clash"

  elseif cardName == "Deal or Die" then
    ttip = "You decide to push their luck a little lower."
    isUnstable = true
    conflictType = "Clash"
  
  elseif cardName == "Uncharted Xanmeer" then
    ttip = "Who knows what secrets lie beneath the bog?"
    conflictType = "Delve"
  
  elseif cardName == "Keep Ayleid on It" then
    ttip = "A simple look won't hurt..."
    conflictType = "Clash"

  elseif cardName == "Origin of the Species" then
    ttip = "Stop the poachers."
    conflictType = "Clash"

  elseif cardName == "Captive Audience" then
    ttip = "Free the captives!"
    conflictType = "Clash"

  elseif cardName == "A Pirate's Death For Ye" then
    ttip = "Follow the map to an underground hoard."
    conflictType = "Delve"

  -- CYRODIIL CONFLICT ENCOUNTERS
  elseif cardName == "War Profiteering" then
    ttip = "Power Broker."
    conflictType = "Delve"

  elseif cardName == "Heroes for Hire" then
    ttip = "Enlist (temporarily)."
    conflictType = "Clash"

  elseif cardName == "Champion of the Downtrodden" then
    ttip = "Defend the village."
    isUnstable = true
    conflictType = "Clash"
  
  elseif cardName == "The Poorly-Lit Brotherhood" then
    ttip = "Imitate their stealthy movements."
    conflictType = "Delve"
  
  elseif cardName == "Cast Your Lot!" then
    ttip = "Go it alone."
    conflictType = "Clash"

  elseif cardName == "Predictive Diplomacy" then
    ttip = "Make your move."
    conflictType = "Clash"

  elseif cardName == "Traders to the Cause" then
    ttip = "Control the flow."
    conflictType = "Clash"

  elseif cardName == "Anchors, Away!" then
    ttip = "Sever the link to Oblivion."
    conflictType = "Clash"

  -- HIGH ROCK CONFLICT ENCOUNTERS
  elseif cardName == "Supine and Supernal" then
    ttip = "Wake me up inside!"
    conflictType = "Clash"

  elseif cardName == "Border Battle" then
    ttip = "Power politics on the edge of the Covenant."
    isUnstable = true
    conflictType = "Clash"

  elseif cardName == "Pit Stop" then
    ttip = "Last an hour in the brawl-pit."
    isUnstable = true
    conflictType = "Clash"

  elseif cardName == "Rooks to the Left, Midnight to the Right" then
    ttip = "Stuck in the middle."
    conflictType = "Clash"
  
  elseif cardName == "Delving with the Dead" then
    ttip = "Grave consequences await."
    conflictType = "Delve"
  
  elseif cardName == "Cave of Conflict" then
    ttip = "Side with the Orcs."
    conflictType = "Delve"

  elseif cardName == "No Unrest for the Wicked" then
    ttip = "Take the invaders head-on."
    isUnstable = true
    conflictType = "Clash"

  elseif cardName == "Rumormonger" then
    ttip = "Pretend to be \"The Plague.\""
    conflictType = "Clash"

  -- MORROWIND CONFLICT ENCOUNTERS
  elseif cardName == "Wrong Side of the Law" then
    ttip = "Can you wriggle out of your remaining chains?"
    conflictType = "Clash"

  elseif cardName == "Not Mushroom to Move" then
    ttip = "Food fight."
    conflictType = "Clash"

  elseif cardName == "Egg Mine? No, Eggs Mine!" then
    ttip = "Egg Scramble"
    conflictType = "Clash"
  
  elseif cardName == "Deals in Dwemer" then
    ttip = "Follow these trustworthy folk to the cave"
    isUnstable = true
    conflictType = "Clash"
  
  elseif cardName == "Augmented Arms" then
    ttip = "This stuff is dangerous!"
    conflictType = "Clash"

  elseif cardName == "Yours for the Taking" then
    ttip = "You can take `em!"
    conflictType = "Clash"

  elseif cardName == "No Tresspassing" then
    ttip = "Scribs cry at morning, diggers take warning."
    conflictType = "Delve"

  elseif cardName == "Mystery Under Morrowind" then
    ttip = "These chambers are moving!"
    conflictType = "Delve"

  -- SKYRIM CONFLICT ENCOUNTERS
  elseif cardName == "Cold Discomfort" then
    ttip = "Frozen resolve."
    isUnstable = true
    conflictType = "Clash"

  elseif cardName == "A Storm of Fists" then
    ttip = "The only tribute you'll give is your blade."
    conflictType = "Clash"

  elseif cardName == "Mudcrab Crossing" then
    ttip = "Mudcrabs are a man's (or mer's, or beastfolk's) best friend."
    conflictType = "Clash"
  
  elseif cardName == "Phalanges of Fate" then
    ttip = "The odds have to be pretty low, right? Right?"
    conflictType = "Delve"
  
  elseif cardName == "Any Fort in a Harrowstorm" then
    ttip = "Keep Moving In"
    conflictType = "Delve"

  elseif cardName == "Compass of Cruelty" then
    ttip = "The snow is always whiter on the other side."
    conflictType = "Clash"

  elseif cardName == "Maniacal Monolith" then
    ttip = "Off to a rocky start."
    conflictType = "Clash"

  elseif cardName == "Good Finds are Hard to Help" then
    ttip = "Defend free trade!"
    conflictType = "Clash"

  -- VALENWOOD CONFLICT ENCOUNTERS
  elseif cardName == "Forest Fatalities" then
    ttip = "Spy the enemy."
    conflictType = "Clash"

  elseif cardName == "Altar Your Destiny" then
    ttip = "Blood offering."
    isUnstable = true
    conflictType = "Clash"

  elseif cardName == "Heeding the Call" then
    ttip = "Fearlessness is frightening."
    conflictType = "Clash"
  
  elseif cardName == "An Enemy In Need" then
    ttip = "Just make this quick and move on!"
    conflictType = "Clash"
  
  elseif cardName == "Vine Snared" then
    ttip = "You can... pant, pant... handle this!"
    isUnstable = true
    conflictType = "Clash"

  elseif cardName == "Dead Mer Tell No Tales" then
    ttip = "Professional plunderers."
    conflictType = "Delve"

  elseif cardName == "Competitive Arvantage" then
    ttip = "Sure, why not?"
    conflictType = "Delve"

  elseif cardName == "Parting the Veiled" then
    ttip = "Rush in with indignation!"
    conflictType = "Clash"

  end

  -- if isUnstable is true, need to get which current province map is out (can't use getCurrentProvince because I need to differentiate eastern and western skyrim) is out, and determine if partyToken is located on an Unstable space per the data in posEncounters
  if not isUnstable then
    local isOnUnstable = checkIfUnstable()
    if isOnUnstable and -- only trigger if card has unstable option
    (cardName == "Wabbajack Attack" or cardName == "Highwaymen" or cardName == "Captured!" or cardName == "Unsullied Pool" or
    cardName == "Deal or Die" or cardName == "Traders to the Cause" or cardName == "Heroes for Hire" or cardName == "Champion of the Downtrodden" or
    cardName == "No Unrest for the Wicked" or cardName == "Cave of Conflict" or cardName == "Supine and Supernal" or cardName == "Border Battle" or
    cardName == "Pit Stop" or cardName == "Deals in Dwemer" or cardName == "Good Finds are Hard to Help" or cardName == "Cold Discomfort" or
    cardName == "Parting the Veiled" or cardName == "Competitive Arvantage" or cardName == "Dead Mer Tell No Tales" or cardName == "Vine Snared" or
    cardName == "An Enemy In Need" or cardName == "Altar Your Destiny" or cardName == "Forest Fatalities") then
      broadcastToAll("Party Token located in Unstable space - Unstable option must be selected.", "Orange")
      return
    end
  end
  
  card.clearButtons()
  card.addTag('conflict_selected')

  if conflictType == "Clash" then
    deployClash(cardName, 1)
  elseif conflictType == "Delve" then
    deployDelve(cardName, 1)
  end
end


function setupConflict2(card, _, _)

  cardName = card.getName()

  -- this function handles the setup of the second conflict encounter card option

  local ttip = ""
  local isUnstable = false
  local conflictType = nil

  -- GENERAL CONFLICT ENCOUNTERS
  if cardName == "Wabbajack Attack" then
    ttip = "Too late!"
    isUnstable = true

  elseif cardName == "Forever Mine" then
    ttip = "Excavate some rusty old scraps outside."
    isUnstable = true

  elseif cardName == "Highwaymen" then
    ttip = "Sneak Away."

  elseif cardName == "The \"Well\" of \"Life\"" then
    ttip = "Throw in a coin."

  elseif cardName == "Captured!" then
    ttip = "Tiptoe off."

  elseif cardName == "Unsullied Pool" then
    ttip = "Drink from the pool."

  elseif cardName == "Broken Bones" then
    ttip = "These bones are facing a slight delay."

  elseif cardName == "Black Market Economics" then
    ttip = "Fight first, treasure later."
    conflictType = "Clash"

  -- BLACK MARSH CONFLICT ENCOUNTERS
  elseif cardName == "Deal or Die" then
    ttip = "Strike a deal."

  elseif cardName == "Uncharted Xanmeer" then
    ttip = "Let some other fools take the risk."

  elseif cardName == "A Pirate's Death For Ye" then
    ttip = "Someone hardier than you would pay good money for a map like this..."

  -- CYRODIIL CONFLICT ENCOUNTERS
  elseif cardName == "War Profiteering" then
    ttip = "Pension plan."
    conflictType = "Delve"

  elseif cardName == "Heroes for Hire" then
    ttip = "Go dark."
    isUnstable = true
    conflictType = "Clash"

  elseif cardName == "Champion of the Downtrodden" then
    ttip = "Leave them to their fate."
  
  elseif cardName == "The Poorly-Lit Brotherhood" then
    ttip = "Make a break for it, taking a few flesh wounds in the process."
 
  elseif cardName == "Traders to the Cause" then
    ttip = "Destroy their wares."
    isUnstable = true
    conflictType = "Clash"

  -- HIGH ROCK CONFLICT ENCOUNTERS
  elseif cardName == "Supine and Supernal" then
    ttip = "You can't wake up!"
    isUnstable = true
    conflictType = "Clash"

  elseif cardName == "Border Battle" then
    ttip = "Just survive. Kings can worry about who goes where."
    conflictType = "Clash"

  elseif cardName == "Pit Stop" then
    ttip = "Looks more like a maul pit."
  
  elseif cardName == "Delving with the Dead" then
    ttip = "One brush with vomit is enough for today."
  
  elseif cardName == "Cave of Conflict" then
    ttip = "Side with the Bretons."
    conflictType = "Delve"

  elseif cardName == "No Unrest for the Wicked" then
    ttip = "Set traps in the rubble."
    conflictType = "Clash"

  elseif cardName == "Rumormonger" then
    ttip = "Just be yourself!"
    conflictType = "Clash"

  -- MORROWIND CONFLICT ENCOUNTERS

  elseif cardName == "Deals in Dwemer" then
    ttip = "Call the treasure hunters out as the swindlers they are."
    conflictType = "Clash"

  elseif cardName == "No Tresspassing" then
    ttip = "Skitter out of there as fast as you can, lest something follows you..."

  elseif cardName == "Mystery Under Morrowind" then
    ttip = "Some secrets are best left unlearned."

  -- SKYRIM CONFLICT ENCOUNTERS
  elseif cardName == "Cold Discomfort" then
    ttip = "Make a dash for the closest campfire."
      
  elseif cardName == "Phalanges of Fate" then
    ttip = "Eh, best not to tempt fate."
  
  elseif cardName == "Any Fort in a Harrowstorm" then
    ttip = "It looks cold in there."

  elseif cardName == "Good Finds are Hard to Help" then
    ttip = "Slashed throats, slashed prices."
    isUnstable = true
    conflictType = "Clash"

  -- VALENWOOD CONFLICT ENCOUNTERS
  elseif cardName == "Forest Fatalities" then
    ttip = "Spied by the enemy."
    isUnstable = true
    conflictType = "Clash"

  elseif cardName == "Altar Your Destiny" then
    ttip = "Material offering."

  elseif cardName == "An Enemy In Need" then
    ttip = "Hopefully, someone sees your good deed."
    isUnstable = true
    conflictType = "Clash"
  
  elseif cardName == "Vine Snared" then
    ttip = "Cutpurse and run."

  elseif cardName == "Dead Mer Tell No Tales" then
    ttip = "Ransom your life."
    isUnstable = true    

  elseif cardName == "Competitive Arvantage" then
    ttip = "Trap Arvan within the delve."
    isUnstable = true

  elseif cardName == "Parting the Veiled" then
    ttip = "Caution and stealth will leave no trace."
    conflictType = "Clash"

  end

  -- if isUnstable is true, need to get which current province map is out (can't use getCurrentProvince because I need to differentiate eastern and western skyrim) is out, and determine if partyToken is located on an Unstable space per the data in posEncounters
  if not isUnstable then
    local isOnUnstable = checkIfUnstable()
    if isOnUnstable and -- only trigger if card has unstable option
    (cardName == "Wabbajack Attack" or cardName == "Highwaymen" or cardName == "Captured!" or cardName == "Unsullied Pool" or
    cardName == "Deal or Die" or cardName == "Traders to the Cause" or cardName == "Heroes for Hire" or cardName == "Champion of the Downtrodden" or
    cardName == "No Unrest for the Wicked" or cardName == "Cave of Conflict" or cardName == "Supine and Supernal" or cardName == "Border Battle" or
    cardName == "Pit Stop" or cardName == "Deals in Dwemer" or cardName == "Good Finds are Hard to Help" or cardName == "Cold Discomfort" or
    cardName == "Parting the Veiled" or cardName == "Competitive Arvantage" or cardName == "Dead Mer Tell No Tales" or cardName == "Vine Snared" or
    cardName == "An Enemy In Need" or cardName == "Altar Your Destiny" or cardName == "Forest Fatalities") then
      broadcastToAll("Party Token located in Unstable space - Unstable option must be selected.", "Orange")
      return
    end
  end
  
  card.clearButtons()
  card.addTag('conflict_selected')

  if conflictType == "Clash" then
    deployClash(cardName, 2)
  elseif conflictType == "Delve" then
    deployDelve(cardName, 2)
  end
end


function setupConflict3(card, _, _)

  cardName = card.getName()
  -- this function handles the setup of the second conflict encounter card option

  local ttip = ""
  local isUnstable = false
  local conflictType = nil

  -- CYRODIIL CONFLICT ENCOUNTERS
  if cardName == "War Profiteering" then
    ttip = "Give peace a chance."
  
  elseif cardName == "The Poorly-Lit Brotherhood" then
    ttip = "Call out, \"Hey, we're on the same team!\""

  -- HIGH ROCK CONFLICT ENCOUNTERS
  elseif cardName == "Caves of Conflict" then
    ttip = "Side with neither."
    isUnstable = true
    conflictType = "Delve"

  end

  -- if isUnstable is true, need to get which current province map is out (can't use getCurrentProvince because I need to differentiate eastern and western skyrim) is out, and determine if partyToken is located on an Unstable space per the data in posEncounters
  if not isUnstable then
    local isOnUnstable = checkIfUnstable()
    if isOnUnstable and -- only trigger if card has unstable option
    (cardName == "Wabbajack Attack" or cardName == "Highwaymen" or cardName == "Captured!" or cardName == "Unsullied Pool" or
    cardName == "Deal or Die" or cardName == "Traders to the Cause" or cardName == "Heroes for Hire" or cardName == "Champion of the Downtrodden" or
    cardName == "No Unrest for the Wicked" or cardName == "Cave of Conflict" or cardName == "Supine and Supernal" or cardName == "Border Battle" or
    cardName == "Pit Stop" or cardName == "Deals in Dwemer" or cardName == "Good Finds are Hard to Help" or cardName == "Cold Discomfort" or
    cardName == "Parting the Veiled" or cardName == "Competitive Arvantage" or cardName == "Dead Mer Tell No Tales" or cardName == "Vine Snared" or
    cardName == "An Enemy In Need" or cardName == "Altar Your Destiny" or cardName == "Forest Fatalities") then
      broadcastToAll("Party Token located in Unstable space - Unstable option must be selected.", "Orange")
      return
    end
  end
  
  card.clearButtons()
  card.addTag('conflict_selected')

  if conflictType == "Clash" then
    deployClash(cardName, 2)
  elseif conflictType == "Delve" then
    deployDelve(cardName, 2)
  end
end


function checkIfUnstable()

  -- this function checks and returns if the party token is located at an unstable space
  local isOnUnstable = false
  local partyToken = getObjectbyName("Party Overland Token")
  if not partyToken then log("checkIfUnstable(): partyToken not found") return end
  local partyPos = partyToken.getPosition()
  local zone = getObjectFromGUID("64c0a4")
  local provinceMapName = nil

  for _, obj in ipairs(zone.getObjects()) do
    local name = obj.getName()
    local match = string.match(name, "^(.-) Overland Map$")
    if match and posEncounters[match] then
      provinceMapName = match
      break
    end
  end
  if not provinceMapName then
    broadcastToAll("No Province Map Found. Set up encounter manually", "Orange")
    return
  end
  
  local encounterPositions = posEncounters[provinceMapName]
  if not encounterPositions then log("checkIfUnstable(): encounterPositions not found for " .. provinceMapName) return false end

  local unstableList = encounterPositions["Unstable"]
  if not unstableList then log("checkIfUnstable(): Unstable list missing for " .. provinceMapName) return false end

  local tolerance = 0.5

  for _, encounterPos in ipairs(unstableList) do
    if (math.abs(partyPos.x - encounterPos[1]) < tolerance)
    and (math.abs(partyPos.z - encounterPos[3]) < tolerance) then
      return true
    end
  end

  return false
end


function deployClash(cardName, optionNumber)

  -- this function handles the setup of clash conflict encounters
  local playerCount = getObjectbyName("Button Player Count").getVar('val')

  -- spaces declared top to bottom, left to right, column by column
  posClashSpaces = {
    -- lefthand column
    ["column1"]   = {
      { -8.20, 2.25, 5.96 },
      { -8.20, 2.25, 2.41 },
      { -8.20, 2.25, -1.14 },
    },
    -- second from lefthand column
    ["column2"]   = {
      { -5.13, 2.25, 7.74 },
      { -5.13, 2.25, 4.19 },
      { -5.13, 2.25, 0.64 },
      { -5.13, 2.25, -2.91 },
    },
    -- third from lefthand column
    ["column3"]   = {
      { -2.05, 2.25, 9.51 },
      { -2.05, 2.25, 5.96 },
      { -2.05, 2.25, 2.41 },
      { -2.05, 2.25, -1.14 },
      { -2.05, 2.25, -4.69 },
    },
    -- middle column
    ["column4"]   = {
      { 1.02, 2.25, 7.74 },
      { 1.02, 2.25, 4.19 },
      { 1.02, 2.25, 0.64 },
      { 1.02, 2.25, -2.91 },
    },
    -- third from righthand column
    ["column5"]   = {
      { 4.10, 2.25, 9.51 },
      { 4.10, 2.25, 5.96 },
      { 4.10, 2.25, 2.41 },
      { 4.10, 2.25, -1.14 },
      { 4.10, 2.25, -4.69 },
    },
    -- second from righthand column
    ["column6"]   = {
      { 7.18, 2.25, 7.74 },
      { 7.18, 2.25, 4.19 },
      { 7.18, 2.25, 0.64 },
      { 7.18, 2.25, -2.91 },
    },
    -- righthand column
    ["column7"]   = {
      { 10.25, 2.25, 5.96 },
      { 10.25, 2.25, 2.41 },
      { 10.25, 2.25, -1.14 },
    },
  }
  
  -- first verify there's no clash mats or gazetteers on table
  local checkZoneBattle = getObjectFromGUID("b5dd6d")
  for _, object in pairs(checkZoneBattle.getObjects()) do
    if object.getName() == "Clash Mat" or object.getName():find("Gazetteer") then
      broadcastToAll("Clear previous encounter before using this button.", "Orange")
      return
    end
  end

  -- get current province, determine which clash mat to use
  local currentProvince = getCurrentProvince()
  if currentProvince == "" or currentProvince == nil then log("deployClash(): currentProvince not found") return end

  -- randomly select mat from possible pool based on current province
  local matPool = {
    ["Black Marsh"] = {"A", "B", "C"},
    ["Cyrodiil"]    = {"A", "B"},
    ["High Rock"]   = {"A", "D"},
    ["Morrowind"]   = {"A", "B", "C"},
    ["Skyrim"]      = {"A", "B", "D"},
    ["Valenwood"]   = {"A", "B"},
  }
  local provinceMatPool = matPool[currentProvince]  
  local selectedMat = provinceMatPool[math.random(#provinceMatPool)]

  -- get clash mat bag, entrance tile bag
  local bagClashMat = getObjectbyName("Clash Mat Bag")
  local bagEntranceTile = getObjectbyName("Entrance Tile Bag")
  if not bagClashMat then log("deployClash(): bagClashMat not found") return end
  if not bagEntranceTile then log("deployClash(): bagEntranceTile not found") return end

  -- pull selected mat from bag, place (if clash mat required, most conflict encounters will require clash mat)
  if cardName ~= "Keep Ayleid on It" and cardName ~= "Pit Stop" and cardName ~= "Yours for the Taking" and not (cardName == "Good Finds are Hard to Help" and optionNumber == 2) then 
    local rotClashMat = { 0, 0, 0 }
    local posClashMat = { 2.05, 1.37, 2.41 }
    local clashMat = nil
    for _, object in pairs(bagClashMat.getObjects()) do
      if object.name == "Clash Mat" and object.gm_notes == selectedMat then
        clashMat = bagClashMat.takeObject({guid = object.guid})
      end
    end
    if clashMat == nil then log("deployClash(): clashMat not found") return end
    Wait.frames(function()
      clashMat.setRotation(rotClashMat)
      clashMat.setPosition(posClashMat)
      clashMat.setLock(true)
    end)

  elseif cardName == "Keep Ayleid on It" then
    local bag19Hex = getObjectbyName("19 Hex Bag")
    local rot19Hex = { 0, 60, 0 }
    local pos19Hex = { -2.05, 1.53, 2.41 }
    local bag3Hex = getObjectbyName("3 Hex Bag")
    local rot3Hex = { 0, 240, 0 }
    local pos3Hex = {{ 6.15, 1.53, 9.51 }, { 6.15, 1.53, -4.69 }}

    local tile19Hex = bag19Hex.takeObject()
    Wait.frames(function()
      tile19Hex.setRotation(rot19Hex)
      tile19Hex.setPosition(pos19Hex)
      tile19Hex.setLock(true)
    end)
    for i = 1, 2 do
      local tile3Hex = bag3Hex.takeObject()
      Wait.frames(function()
        tile3Hex.setRotation(rot3Hex)
        tile3Hex.setPosition(pos3Hex[i])
        tile3Hex.setLock(true)
      end)
    end
    
  elseif cardName == "Pit Stop" then
    local bag19Hex = getObjectbyName("19 Hex Bag")
    local rot19Hex = { 0, 60, 0 }
    local pos19Hex = { 4.10, 1.53, 2.41 }
    local tile19Hex = bag19Hex.takeObject()
    Wait.frames(function()
      tile19Hex.setRotation(rot19Hex)
      tile19Hex.setPosition(pos19Hex)
      tile19Hex.setLock(true)
    end)
  
  elseif cardName == "Yours for the Taking" then
    local bag7Hex = getObjectbyName("7 Hex Bag")
    local rot7Hex = { 0, 60, 0 }
    local pos7Hex = { 4.10, 1.24, 2.41 }
    local bag3Hex = getObjectbyName("3 Hex Bag")
    local rot3Hex = { 0, 0, 0 }
    local pos3Hex = { { -3.07, 1.53, 7.74 }, { -3.08, 1.53, -2.91 } }

    local tile7Hex = bag7Hex.takeObject()
    Wait.frames(function()
      tile7Hex.setRotation(rot7Hex)
      tile7Hex.setPosition(pos7Hex)
      tile7Hex.setLock(true)
    end)
    for i = 1, 2 do
      local tile3Hex = bag3Hex.takeObject()
      Wait.frames(function()
        tile3Hex.setRotation(rot3Hex)
        tile3Hex.setPosition(pos3Hex[i])
        tile3Hex.setLock(true)
      end)
    end
  end

  -- wait 1 second for clash mat to place, then pull and place any required obstacles
  Wait.time(function()

    local bagObstacle = getObjectbyName("Obstacle Hex Bag")

    if cardName == "No Unrest for the Wicked" then
      local rot3HexObstacle = { 0, 0, 0 }
      local pos3HexObstacle = {
        { -6.15, 2.63, -1.14 },
        { -3.08, 2.63, 7.74 },
        { 6.15, 2.63, 2.41 },
      }
      for i = 1, 3 do
        local obstacle3Hex = nil
        for _, object in pairs(bagObstacle.getObjects()) do
          if object.name == "3 Hex Obstacle" then
            obstacle3Hex = bagObstacle.takeObject({guid=object.guid})
            break
          end
        end
        if obstacle3Hex ~= nil then
          obstacle3Hex.setRotation(rot3HexObstacle)
          obstacle3Hex.setPosition(pos3HexObstacle[i])
          obstacle3Hex.setLock(true)
        end
      end

    elseif cardName == "Not Mushroom to Move" then
      local rot7HexObstacle = { 0, 300, 0 }
      local pos7HexObstacle = { 1.02, 1.53, 4.19 }
      local obstacle7Hex = nil
      for _, object in pairs(bagObstacle.getObjects()) do
        if object.name == "7 Hex Obstacle" then
          obstacle7Hex = bagObstacle.takeObject({guid=object.guid})
          break
        end
      end
      if obstacle7Hex ~= nil then
        obstacle7Hex.setRotation(rot7HexObstacle)
        obstacle7Hex.setPosition(pos7HexObstacle)
        obstacle7Hex.setLock(true)
      end

    elseif cardName == "SK Siege Encounter" then
      deploySkyrimTown()

    elseif cardName == "An Enemy In Need" then
      local rot3HexObstacle = { { 0, 300, 0 }, { 0, 0, 0 }, { 0, 300, 0 } }
      local pos3HexObstacle = { { -1.02, 2.63, -2.91 }, { 0.00, 2.63, 2.41 }, { 8.20, 2.63, 5.96 } }
      for i = 1, 3 do
        local obstacle3Hex = nil
        for _, object in pairs(bagObstacle.getObjects()) do
          if object.name == "3 Hex Obstacle" then
            obstacle3Hex = bagObstacle.takeObject({guid=object.guid})
            break
          end
        end
        if obstacle3Hex ~= nil then
          obstacle3Hex.setRotation(rot3HexObstacle[i])
          obstacle3Hex.setPosition(pos3HexObstacle[i])
          obstacle3Hex.setLock(true)
        end
      end

    end

  end, 1)

  -- get rotation, position of entrance tile per encounter name
  -- also get tables for cache and enemy placement
  local rotEntranceTile = {}
  local posEntranceTile = {}
  local spacesCaches = {}
  local rotCaches = {}
  local rotCommonCaches = { 0, 180, 0 }
  local rotLegendaryCaches = { 0, 180, 180 }
  local spacesEnemies = {}
  
  -- GENERAL ENCOUNTERS
  if cardName == "Wabbajack Attack" then
    rotEntranceTile = { 0, 300, 0 }
    posEntranceTile = { -12.30, 1.53, 2.41 }
    rotCaches = {
      rotCommonCaches,
      rotCommonCaches,
    }
    spacesCaches = {
      posClashSpaces["column3"][1],
      posClashSpaces["column7"][3],
    }
    spacesEnemies = {
      posClashSpaces["column6"][1],
      posClashSpaces["column5"][1],
      posClashSpaces["column7"][1],
      posClashSpaces["column5"][2],
      posClashSpaces["column6"][2],
      posClashSpaces["column4"][1],
      posClashSpaces["column7"][2],
      posClashSpaces["column5"][3],
    }

  elseif cardName == "The Wacky Box of Wonders" then
    rotEntranceTile = { 0, 180, 0 }
    posEntranceTile = {9.22, 1.53, -6.46}
    rotCaches = {
      rotLegendaryCaches,
      rotCommonCaches,
      rotCommonCaches,
    }
    spacesCaches = {
      posClashSpaces["column1"][2],
      posClashSpaces["column3"][5],
      posClashSpaces["column6"][1],
    }
    spacesEnemies = {
      posClashSpaces["column3"][3],
      posClashSpaces["column3"][1],
      posClashSpaces["column1"][3],
      posClashSpaces["column3"][2],
      posClashSpaces["column2"][3],
      posClashSpaces["column1"][1],
      posClashSpaces["column7"][1],
      posClashSpaces["column4"][4],
    }

  elseif cardName == "Highwaymen" then
    rotEntranceTile = { 0, 300, 0 }
    posEntranceTile = { -12.30, 1.53, 2.41 }
    rotCaches = {
      rotCommonCaches,
      rotCommonCaches,
      rotCommonCaches,
    }
    spacesCaches = {
      posClashSpaces["column3"][1],
      posClashSpaces["column4"][2],
      posClashSpaces["column5"][1],
    }
    spacesEnemies = {
      posClashSpaces["column2"][1],
      posClashSpaces["column6"][3],
      posClashSpaces["column6"][1],
      posClashSpaces["column2"][3],
      posClashSpaces["column6"][2],
      posClashSpaces["column2"][2],
      posClashSpaces["column4"][1],
      posClashSpaces["column4"][3],
    }

  elseif cardName == "Captured!" then
    rotEntranceTile = { 0, 120, 0}
    posEntranceTile = { 14.35, 1.53, 2.41 }
    rotCaches = {
      rotCommonCaches,
      rotCommonCaches,
      rotCommonCaches,
      rotCommonCaches,
    }
    spacesCaches = {
      posClashSpaces["column1"][1],
      posClashSpaces["column1"][3],
      posClashSpaces["column3"][5],
      posClashSpaces["column6"][1],
    }
    spacesEnemies = {
      posClashSpaces["column5"][1],
      posClashSpaces["column4"][4],
      posClashSpaces["column3"][2],
      posClashSpaces["column5"][3],
      posClashSpaces["column4"][1],
      posClashSpaces["column3"][4],
      posClashSpaces["column3"][3],
      posClashSpaces["column4"][2],
    }

  elseif cardName == "Unsullied Pool" then
    rotEntranceTile = { 0, 300, 0 }
    posEntranceTile = { -12.30, 1.53, 2.41 }
    rotCaches = {
      rotCommonCaches,
      rotLegendaryCaches,
    }
    spacesCaches = {
      posClashSpaces["column1"][1],
      posClashSpaces["column1"][3],
    }
    spacesEnemies = {
      posClashSpaces["column5"][3],
      posClashSpaces["column5"][1],
      posClashSpaces["column5"][5],
      posClashSpaces["column7"][1],
      posClashSpaces["column7"][3],
      posClashSpaces["column7"][2],
      posClashSpaces["column6"][1],
      posClashSpaces["column6"][4],
    }

  elseif cardName == "Black Market Economics" then
    rotEntranceTile = { 0, 0, 0 }
    posEntranceTile = { 2.05, 1.53, 13.06 }
    rotCaches = {
      rotCommonCaches,
      rotCommonCaches,
      rotCommonCaches,
      rotCommonCaches,
      rotCommonCaches,
    }
    spacesCaches = {
      posClashSpaces["column1"][2],
      posClashSpaces["column2"][4],
      posClashSpaces["column4"][4],
      posClashSpaces["column6"][4],
      posClashSpaces["column7"][2],
    }
    spacesEnemies = {
      posClashSpaces["column4"][3],
      posClashSpaces["column2"][3],
      posClashSpaces["column6"][3],
      posClashSpaces["column2"][2],
      posClashSpaces["column6"][2],
      posClashSpaces["column4"][2],
      posClashSpaces["column3"][3],
      posClashSpaces["column5"][3],
    }

  elseif cardName == "Keep Away" then
    rotEntranceTile = { 0, 240, 0 }
    posEntranceTile = { -7.18, 1.53, -6.46 }
    rotCaches = {
      rotCommonCaches,
      rotCommonCaches,
      rotCommonCaches,
      rotCommonCaches,
      rotCommonCaches,
    }
    spacesCaches = {
      posClashSpaces["column1"][1],
      posClashSpaces["column3"][1],
      posClashSpaces["column4"][4],
    }
    spacesEnemies = {
      posClashSpaces["column3"][3],
      posClashSpaces["column5"][2],
      posClashSpaces["column6"][3],
      posClashSpaces["column1"][3],
      posClashSpaces["column2"][4],
      posClashSpaces["column6"][4],
      posClashSpaces["column5"][1],
      posClashSpaces["column4"][2],
    }
  
  -- BLACK MARSH CONFLICT ENCOUNTERS
  elseif cardName == "Captives of House Telvanni" then
    rotEntranceTile = { 0, 180, 0 }
    posEntranceTile = { 9.22, 1.53, -6.46 }
    rotCaches = {
      rotLegendaryCaches,
      rotCommonCaches,
    }
    spacesCaches = {
      posClashSpaces["column1"][1],
      posClashSpaces["column5"][1],
    }
    spacesEnemies = {
      posClashSpaces["column4"][1],
      posClashSpaces["column4"][2],
      posClashSpaces["column3"][3],
      posClashSpaces["column5"][3],
      posClashSpaces["column2"][3],
      posClashSpaces["column7"][3],
      posClashSpaces["column1"][3],
      posClashSpaces["column7"][3],
    }

  elseif cardName == "Corrupted Communion" then
    rotEntranceTile = { 0, 120, 0 }
    posEntranceTile = { 14.35, 1.53, 2.41 }
    rotCaches = {
      rotCommonCaches,
      rotCommonCaches,
    }
    spacesCaches = {
      posClashSpaces["column3"][1],
      posClashSpaces["column3"][5],
    }
    spacesEnemies = {
      posClashSpaces["column5"][1],
      posClashSpaces["column5"][5],
      posClashSpaces["column3"][3],
      posClashSpaces["column1"][1],
      posClashSpaces["column1"][3],
      posClashSpaces["column6"][1],
      posClashSpaces["column6"][4],
      posClashSpaces["column5"][3],
    }

  elseif cardName == "Deal or Die" then
    rotEntranceTile = { 0, 240, 0 }
    posEntranceTile = { -7.18, 1.53, -6.46 }
    rotCaches = {
      rotLegendaryCaches,
      rotCommonCaches,
      rotCommonCaches,
    }
    spacesCaches = {
      posClashSpaces["column6"][2],
      posClashSpaces["column4"][2],
      posClashSpaces["column5"][4],
    }
    spacesEnemies = {
      posClashSpaces["column4"][3],
      posClashSpaces["column3"][3],
      posClashSpaces["column4"][4],
      posClashSpaces["column4"][1],
      posClashSpaces["column5"][5],
      posClashSpaces["column5"][3],
      posClashSpaces["column2"][3],
      posClashSpaces["column4"][5],
    }
  
  elseif cardName == "Keep Ayleid on It" then
    rotEntranceTile = { 0, 300, 0 }
    posEntranceTile = { -12.30, 1.53, 2.41 }
    rotCaches = {
      rotCommonCaches,
      rotCommonCaches,
      rotCommonCaches,
      rotCommonCaches,
      rotCommonCaches,
    }
    spacesCaches = {
      posClashSpaces["column3"][1],
      posClashSpaces["column5"][3],
      posClashSpaces["column3"][5],
      { 7.17, 1.84, 11.29 },
      { 7.17, 1.84, -6.46 },
    }
    spacesEnemies = {
      posClashSpaces["column3"][3],
      posClashSpaces["column4"][3],
      posClashSpaces["column4"][2],
      posClashSpaces["column1"][2],
    }

  elseif cardName == "Origin of the Species" then
    rotEntranceTile = { 0, 120, 0 }
    posEntranceTile = { 14.35, 1.53, 2.41 }
    rotCaches = {
      rotCommonCaches,
      rotCommonCaches,
    }
    spacesCaches = {
      posClashSpaces["column2"][4],
      posClashSpaces["column5"][1],
    }
    spacesEnemies = {
      posClashSpaces["column3"][3],
      posClashSpaces["column3"][1],
      posClashSpaces["column1"][3],
      posClashSpaces["column4"][4],
      posClashSpaces["column1"][1],
      posClashSpaces["column3"][5],
      posClashSpaces["column5"][2],
      posClashSpaces["column2"][2],
    }

  elseif cardName == "Captive Audience" then
    rotEntranceTile = { 0, 120, 0 }
    posEntranceTile = { 14.35, 1.53, 2.41 }
    rotCaches = {
      rotCommonCaches,
      rotCommonCaches,
      rotCommonCaches,
    }
    spacesCaches = {
      posClashSpaces["column1"][2],
      posClashSpaces["column3"][1],
      posClashSpaces["column3"][5],
    }
    spacesEnemies = {
      posClashSpaces["column4"][1],
      posClashSpaces["column4"][4],
      posClashSpaces["column3"][2],
      posClashSpaces["column3"][4],
      posClashSpaces["column2"][1],
      posClashSpaces["column2"][4],
      posClashSpaces["column1"][1],
      posClashSpaces["column1"][3],
    }

  -- CYRODIIL CONFLICT ENCOUNTERS
 
  elseif cardName == "Heroes for Hire" then
    rotEntranceTile = { 0, 240, 0 }
    posEntranceTile = { -7.18, 1.53, -6.46 }
    rotCaches = {
      rotCommonCaches,
      rotCommonCaches,
    }
    spacesCaches = {
      posClashSpaces["column4"][2],
      posClashSpaces["column4"][3],
    }
    spacesEnemies = {
      posClashSpaces["column3"][1],
      posClashSpaces["column5"][5],
      posClashSpaces["column5"][2],
      posClashSpaces["column2"][3],
      posClashSpaces["column4"][1],
      posClashSpaces["column4"][4],
      posClashSpaces["column6"][2],
      posClashSpaces["column3"][4],
    }

  elseif cardName == "Champion of the Downtrodden" then
    rotEntranceTile = { 0, 120, 0 }
    posEntranceTile = { 14.35, 1.53, 2.41 }
    rotCaches = {
      rotCommonCaches,
      rotCommonCaches,
    }
    spacesCaches = {
      posClashSpaces["column5"][1],
      posClashSpaces["column5"][5],
    }
    spacesEnemies = {
      posClashSpaces["column5"][3],
      posClashSpaces["column6"][1],
      posClashSpaces["column6"][4],
      posClashSpaces["column7"][2],
      posClashSpaces["column4"][1],
      posClashSpaces["column4"][4],
      posClashSpaces["column3"][3],
      posClashSpaces["column7"][1],
    }
  
  elseif cardName == "Cast Your Lot!" then
    rotEntranceTile = { 0, 300, 0 }
    posEntranceTile = { -12.30, 1.53, 2.41 }
    rotCaches = {
      rotCommonCaches,
      rotLegendaryCaches,
    }
    spacesCaches = {
      posClashSpaces["column1"][1],
      posClashSpaces["column6"][4],
    }
    spacesEnemies = {
      posClashSpaces["column4"][1],
      posClashSpaces["column5"][1],
      posClashSpaces["column6"][1],
      posClashSpaces["column6"][2],
      posClashSpaces["column5"][3],
      posClashSpaces["column4"][3],
      posClashSpaces["column4"][4],
      posClashSpaces["column5"][5],
    }

  elseif cardName == "Predictive Diplomacy" then
    rotEntranceTile = { 0, 120, 0 }
    posEntranceTile = { 14.35, 1.53, 2.41 }
    rotCaches = {
      rotLegendaryCaches,
    }
    spacesCaches = {
      posClashSpaces["column1"][2],
    }
    spacesEnemies = {
      posClashSpaces["column2"][1],
      posClashSpaces["column2"][4],
      posClashSpaces["column4"][4],
      posClashSpaces["column4"][1],
      posClashSpaces["column5"][5],
      posClashSpaces["column5"][1],
      posClashSpaces["column7"][3],
      posClashSpaces["column7"][1],
    }

  elseif cardName == "Traders to the Cause" then
    rotEntranceTile = { 0, 300, 0 }
    posEntranceTile = { -12.30, 1.53, 2.41 }
    rotCaches = {
      rotLegendaryCaches,
      rotCommonCaches,
      rotCommonCaches,
    }
    spacesCaches = {
      posClashSpaces["column5"][3],
      posClashSpaces["column6"][1],
      posClashSpaces["column6"][4],
    }
    spacesEnemies = {
      posClashSpaces["column4"][2],
      posClashSpaces["column4"][3],
      posClashSpaces["column3"][3],
      posClashSpaces["column5"][2],
      posClashSpaces["column5"][4],
      posClashSpaces["column6"][2],
      posClashSpaces["column6"][3],
      posClashSpaces["column7"][2],
    }

  elseif cardName == "Anchors, Away!" then
    rotEntranceTile = { 0, 120, 0 }
    posEntranceTile = { 14.35, 1.53, 2.41 }
    rotCaches = {
      rotCommonCaches,
      rotCommonCaches,
    }
    spacesCaches = {
      posClashSpaces["column6"][1],
      posClashSpaces["column6"][4],
    }
    spacesEnemies = {
      posClashSpaces["column3"][3],
      posClashSpaces["column4"][1],
      posClashSpaces["column4"][4],
      posClashSpaces["column5"][1],
      posClashSpaces["column5"][5],
      posClashSpaces["column5"][3],
      posClashSpaces["column3"][5],
      posClashSpaces["column3"][1],
    }

  -- HIGH ROCK CONFLICT ENCOUNTERS
  elseif cardName == "Supine and Supernal" then
    rotEntranceTile = { 0, 240, 0 }
    posEntranceTile = { -7.18, 1.53, -6.46 }
    rotCaches = {
      rotLegendaryCaches,
      rotCommonCaches,
    }
    spacesCaches = {
      posClashSpaces["column4"][2],
      posClashSpaces["column4"][3],
    }
    spacesEnemies = {
      posClashSpaces["column1"][1],
      posClashSpaces["column7"][3],
      posClashSpaces["column1"][3],
      posClashSpaces["column7"][1],
      posClashSpaces["column3"][1],
      posClashSpaces["column5"][5],
      posClashSpaces["column5"][1],
      posClashSpaces["column3"][5],
    }

  elseif cardName == "Border Battle" then
    rotEntranceTile = { 0, 180, 0 }
    posEntranceTile = { 0.00, 1.53, -8.24 }
    rotCaches = {
      rotLegendaryCaches,
      rotCommonCaches,
      rotCommonCaches,
    }
    spacesCaches = {
      posClashSpaces["column4"][1],
      posClashSpaces["column1"][3],
      posClashSpaces["column7"][3],
    }
    spacesEnemies = {
      posClashSpaces["column3"][1],
      posClashSpaces["column5"][1],
      posClashSpaces["column6"][4],
      posClashSpaces["column2"][4],
      posClashSpaces["column2"][2],
      posClashSpaces["column6"][2],
      posClashSpaces["column7"][1],
      posClashSpaces["column1"][1],
    }

  elseif cardName == "Pit Stop" then
    rotEntranceTile = { 0, 120, 0 }
    posEntranceTile = { 14.35, 1.53, 2.41 }
    rotCaches = {
      rotCommonCaches,
      rotCommonCaches,
      rotCommonCaches,
      rotCommonCaches,
    }
    spacesCaches = {
      posClashSpaces["column4"][1],
      posClashSpaces["column4"][4],
      posClashSpaces["column6"][1],
      posClashSpaces["column6"][4],
    }
    spacesEnemies = {
      posClashSpaces["column5"][1],
      posClashSpaces["column5"][5],
      posClashSpaces["column7"][1],
      posClashSpaces["column3"][4],
      posClashSpaces["column7"][3],
      posClashSpaces["column3"][2],
      posClashSpaces["column5"][2],
      posClashSpaces["column5"][4],
    }

  elseif cardName == "Rooks to the Left, Midnight to the Right" then
    rotEntranceTile = { 0, 300, 0 }
    posEntranceTile = {-12.30, 1.53, 2.41}
    rotCaches = {
      rotCommonCaches,
      rotCommonCaches,
      rotLegendaryCaches,
    }
    spacesCaches = {
      posClashSpaces["column3"][1],
      posClashSpaces["column3"][5],
      posClashSpaces["column7"][2],
    }
    spacesEnemies = {
      posClashSpaces["column6"][1],
      posClashSpaces["column6"][4],
      posClashSpaces["column4"][4],
      posClashSpaces["column4"][1],
      posClashSpaces["column5"][1],
      posClashSpaces["column5"][5],
      posClashSpaces["column2"][1],
      posClashSpaces["column2"][4],
    }
  
  elseif cardName == "No Unrest for the Wicked" then
    rotEntranceTile = { 0, 180, 0 }
    posEntranceTile = { 9.22, 1.53, -6.46 }
    rotCaches = {
      rotCommonCaches,
      rotCommonCaches,
    }
    spacesCaches = {
      posClashSpaces["column3"][4],
      posClashSpaces["column5"][2],
    }
    spacesEnemies = {
      posClashSpaces["column5"][1],
      posClashSpaces["column1"][1],
      posClashSpaces["column3"][5],
      posClashSpaces["column7"][1],
      posClashSpaces["column3"][3],
      posClashSpaces["column4"][1],
      posClashSpaces["column1"][2],
      posClashSpaces["column5"][4],
    }

  elseif cardName == "Rumormonger" then
    rotEntranceTile = { 0, 240, 0 }
    posEntranceTile = { 2.05, 1.53, -8.24 }
    rotCaches = {
      rotLegendaryCaches,
      rotCommonCaches,
      rotCommonCaches,
    }
    spacesCaches = {
      posClashSpaces["column4"][1],
      posClashSpaces["column1"][1],
      posClashSpaces["column7"][1],
    }
    spacesEnemies = {
      posClashSpaces["column2"][2],
      posClashSpaces["column6"][2],
      posClashSpaces["column4"][2],
      posClashSpaces["column2"][3],
      posClashSpaces["column6"][3],
      posClashSpaces["column3"][3],
      posClashSpaces["column5"][3],
      posClashSpaces["column4"][3],
    }

  -- MORROWIND CONFLICT ENCOUNTERS
  elseif cardName == "Wrong Side of the Law" then
    rotEntranceTile = { 0, 300, 0 }
    posEntranceTile = { -12.30, 1.53, 2.41 }
    rotCaches = {
      rotCommonCaches,
      rotCommonCaches,
    }
    spacesCaches = {
      posClashSpaces["column7"][1],
      posClashSpaces["column7"][3],
    }
    spacesEnemies = {
      posClashSpaces["column4"][2],
      posClashSpaces["column4"][3],
      posClashSpaces["column6"][2],
      posClashSpaces["column6"][3],
      posClashSpaces["column2"][1],
      posClashSpaces["column2"][4],
      posClashSpaces["column3"][5],
      posClashSpaces["column3"][1],
    }

  elseif cardName == "Not Mushroom to Move" then
    rotEntranceTile = { 0, 120, 0 }
    posEntranceTile = { 14.35, 1.53, 2.41 }
    rotCaches = {
      rotLegendaryCaches,
      rotCommonCaches,
    }
    spacesCaches = {
      posClashSpaces["column1"][2],
      posClashSpaces["column6"][2],
    }
    spacesEnemies = {
      posClashSpaces["column1"][1],
      posClashSpaces["column1"][3],
      posClashSpaces["column3"][1],
      posClashSpaces["column3"][5],
      posClashSpaces["column5"][5],
      posClashSpaces["column5"][1],
      posClashSpaces["column2"][1],
      posClashSpaces["column2"][4],
    }

  elseif cardName == "Egg Mine? No, Eggs Mine!" then
    rotEntranceTile = { 0, 300, 0 }
    posEntranceTile = { -12.30, 1.53, 5.96 }
    rotCaches = {
      rotCommonCaches,
      rotCommonCaches,
      rotCommonCaches,
      rotCommonCaches,
      rotCommonCaches,
      rotCommonCaches,      
    }
    spacesCaches = {
      posClashSpaces["column1"][3],
      posClashSpaces["column2"][3],
      posClashSpaces["column2"][4],
      posClashSpaces["column6"][1],
      posClashSpaces["column6"][2],
      posClashSpaces["column7"][1],
    }
    spacesEnemies = {
      posClashSpaces["column5"][5],
      posClashSpaces["column3"][1],
      posClashSpaces["column5"][1],
      posClashSpaces["column3"][5],
      posClashSpaces["column4"][2],
      posClashSpaces["column4"][3],
      posClashSpaces["column1"][2],
      posClashSpaces["column7"][2],
    }
  
  elseif cardName == "Deals in Dwemer" then
    rotEntranceTile = { 0, 300, 0 }
    posEntranceTile = { -12.30, 1.53, 2.4 }
    rotCaches = {
      rotLegendaryCaches,
      rotCommonCaches,
      rotCommonCaches,
      rotCommonCaches,
    }
    spacesCaches = {
      posClashSpaces["column4"][1],
      posClashSpaces["column4"][2],
      posClashSpaces["column4"][3],
      posClashSpaces["column4"][4],
    }
    spacesEnemies = {
      posClashSpaces["column7"][1],
      posClashSpaces["column6"][4],
      posClashSpaces["column7"][3],
      posClashSpaces["column6"][1],
      posClashSpaces["column3"][1],
      posClashSpaces["column3"][5],
      posClashSpaces["column2"][1],
      posClashSpaces["column2"][4],
    }
  
  elseif cardName == "Augmented Arms" then
    rotEntranceTile = { 0, 180, 0 }
    posEntranceTile = { 9.22, 1.53, -6.46 }
    rotCaches = {
      rotCommonCaches,
      rotCommonCaches,
      rotCommonCaches,
      rotCommonCaches,
      rotCommonCaches,
      rotCommonCaches,
    }
    spacesCaches = {
      -- positioned off clash mat since players have choice where to place
      { 13.32, 1.24, -2.91 },
      { 13.32, 1.24, 0.64 },
      { 13.32, 1.24, 4.19 },
      { 17.42, 1.24, 4.19 },
      { 17.42, 1.24, 0.64 },
      { 17.42, 1.24, -2.91 },
    }
    spacesEnemies = {
      posClashSpaces["column5"][4],
      posClashSpaces["column3"][4],
      posClashSpaces["column5"][2],
      posClashSpaces["column3"][2],
      posClashSpaces["column6"][3],
      posClashSpaces["column2"][3],
      posClashSpaces["column6"][2],
      posClashSpaces["column2"][2],
    }

  elseif cardName == "Yours for the Taking" then
    rotEntranceTile = { 0, 300, 0 }
    posEntranceTile = { -6.15, 1.53, 2.41 }
    rotCaches = {
      rotLegendaryCaches,
    }
    spacesCaches = {
      posClashSpaces["column5"][3],
    }
    spacesEnemies = {
      posClashSpaces["column3"][2],
      posClashSpaces["column3"][4],
      posClashSpaces["column3"][5],
      posClashSpaces["column3"][1],
      posClashSpaces["column6"][2],
      posClashSpaces["column6"][3],
      posClashSpaces["column5"][2],
      posClashSpaces["column5"][4],
    }

  -- SKYRIM CONFLICT ENCOUNTERS
  elseif cardName == "Cold Discomfort" then
    rotEntranceTile = { 0, 0, 0 }
    posEntranceTile = { -7.18, 1.53, 11.29 }
    rotCaches = {
      rotCommonCaches,
      rotLegendaryCaches,
    }
    spacesCaches = {
      posClashSpaces["column5"][1],
      posClashSpaces["column5"][4],
    }
    spacesEnemies = {
      posClashSpaces["column4"][2],
      posClashSpaces["column7"][3],
      posClashSpaces["column1"][2],
      posClashSpaces["column3"][4],
      posClashSpaces["column6"][1],
      posClashSpaces["column5"][5],
      posClashSpaces["column3"][1],
      posClashSpaces["column7"][3],
    }

  elseif cardName == "A Storm of Fists" then
    rotEntranceTile = { 0, 120, 0 }
    posEntranceTile = { 14.35, 1.53, 2.41 }
    rotCaches = {
      rotLegendaryCaches,
      rotCommonCaches,
    }
    spacesCaches = {
      posClashSpaces["column2"][3],
      posClashSpaces["column6"][3],
    }
    spacesEnemies = {
      posClashSpaces["column4"][2],
      posClashSpaces["column5"][3],
      posClashSpaces["column6"][2],
      posClashSpaces["column7"][2],
      posClashSpaces["column3"][3],
      posClashSpaces["column2"][2],
      posClashSpaces["column1"][2],
      posClashSpaces["column4"][3],
    }

  elseif cardName == "Mudcrab Crossing" then
    rotEntranceTile = { 0, 120, 0 }
    posEntranceTile = { 14.35, 1.53, 2.41 }
    rotCaches = {
      rotLegendaryCaches,
      rotCommonCaches,
    }
    spacesCaches = {
      posClashSpaces["column3"][5],
      posClashSpaces["column5"][1],
    }
    spacesEnemies = {
      posClashSpaces["column5"][3],
      posClashSpaces["column3"][3],
      posClashSpaces["column6"][1],
      posClashSpaces["column2"][4],
      posClashSpaces["column6"][4],
      posClashSpaces["column2"][1],
      posClashSpaces["column4"][1],
      posClashSpaces["column4"][4],
    }
    
  elseif cardName == "Compass of Cruelty" then
    rotEntranceTile = { 0, 300, 0 }
    posEntranceTile = { -12.30, 1.53, 2.41 }
    rotCaches = {
      rotCommonCaches,
      rotCommonCaches,
      rotLegendaryCaches,
    }
    spacesCaches = {
      posClashSpaces["column3"][1],
      posClashSpaces["column3"][5],
      posClashSpaces["column7"][3],
    }
    spacesEnemies = {
      posClashSpaces["column5"][2],
      posClashSpaces["column5"][4],
      posClashSpaces["column4"][2],
      posClashSpaces["column4"][3],
      posClashSpaces["column6"][2],
      posClashSpaces["column6"][3],
      posClashSpaces["column3"][2],
      posClashSpaces["column3"][4],
    }

  elseif cardName == "Maniacal Monolith" then
    rotEntranceTile = { 0, 300, 0 }
    posEntranceTile = { -12.30, 1.53, 2.41 }
    rotCaches = {
      rotLegendaryCaches,
      rotLegendaryCaches,
    }
    spacesCaches = {
      posClashSpaces["column5"][1],
      posClashSpaces["column5"][5],
    }
    spacesEnemies = {
      posClashSpaces["column5"][3],
      posClashSpaces["column4"][4],
      posClashSpaces["column4"][1],
      posClashSpaces["column2"][2],
      posClashSpaces["column2"][3],
      posClashSpaces["column7"][2],
      posClashSpaces["column7"][3],
      posClashSpaces["column5"][3],
    }

  elseif cardName == "Good Finds are Hard to Help" then
    rotEntranceTile = { 0, 240, 0 }
    posEntranceTile = { -7.18, 1.53, -6.46 }
    rotCaches = {}
    spacesCaches = {}
    spacesEnemies = {
      posClashSpaces["column5"][3],
      posClashSpaces["column5"][5],
      posClashSpaces["column1"][3],
      posClashSpaces["column3"][1],
      posClashSpaces["column5"][2],
      posClashSpaces["column5"][4],
      posClashSpaces["column1"][1],
      posClashSpaces["column7"][2],
    }

  elseif cardName == "SK Siege Encounter" then
    rotEntranceTile = { 0, 300, 0 }
    posEntranceTile = { -12.30, 1.53, 2.41 }
    rotCaches = {}
    spacesCaches = {}
    spacesEnemies = {
      posClashSpaces["column3"][3],
      posClashSpaces["column5"][5],
      posClashSpaces["column1"][1],
      posClashSpaces["column5"][1],
      posClashSpaces["column1"][3],
      posClashSpaces["column3"][5],
      posClashSpaces["column3"][1],
      posClashSpaces["column7"][2],
    }

  -- VALENWOOD CONFLICT ENCOUNTERS
  elseif cardName == "Forest Fatalities" then
    rotEntranceTile = { 0, 240, 0 }
    posEntranceTile = { -7.18, 1.53, -6.46 }
    rotCaches = {
      rotCommonCaches,
      rotLegendaryCaches,
      rotCommonCaches,
    }
    spacesCaches = {
      posClashSpaces["column1"][1],
      posClashSpaces["column5"][1],
      posClashSpaces["column7"][2],
    }
    spacesEnemies = {
      posClashSpaces["column3"][1],
      posClashSpaces["column3"][5],
      posClashSpaces["column1"][3],
      posClashSpaces["column5"][3],
      posClashSpaces["column7"][3],
      posClashSpaces["column5"][5],
      posClashSpaces["column4"][1],
      posClashSpaces["column2"][1],
    }

  elseif cardName == "Altar Your Destiny" then
    rotEntranceTile = { 0, 120, 0 }
    posEntranceTile = { 14.35, 1.53, 2.41 }
    rotCaches = {
      rotLegendaryCaches,
      rotCommonCaches,
      rotCommonCaches,
    }
    spacesCaches = {
      posClashSpaces["column1"][2],
      posClashSpaces["column5"][1],
      posClashSpaces["column5"][5],
    }
    spacesEnemies = {
      { 19.47, 2.00, -2.91 },
      { 19.47, 2.00, 0.64 },
      { 19.47, 2.00, 4.19 },
      { 19.47, 2.00, 7.74 },
      { 23.57, 2.00, 7.74 },
      { 23.57, 2.00, 4.19 },
      { 23.57, 2.00, 0.64 },
      { 23.57, 2.00, -2.91 },
    }

  elseif cardName == "Heeding the Call" then
    rotEntranceTile = { 0, 180, 0 }
    posEntranceTile = { 9.22, 1.53, -6.46 }
    rotCaches = {
      rotLegendaryCaches,
      rotCommonCaches,
      rotCommonCaches,
      rotCommonCaches,
    }
    spacesCaches = {
      posClashSpaces["column3"][4],
      posClashSpaces["column4"][3],
      posClashSpaces["column5"][2],
      posClashSpaces["column5"][3],
    }
    spacesEnemies = {
      posClashSpaces["column3"][1],
      posClashSpaces["column3"][5],
      posClashSpaces["column6"][2],
      posClashSpaces["column3"][3],
      posClashSpaces["column5"][5],
      posClashSpaces["column5"][4],
      posClashSpaces["column4"][1],
      posClashSpaces["column3"][2],
    }
  
  elseif cardName == "An Enemy In Need" then
    rotEntranceTile = { 0, 120, 0 }
    posEntranceTile = { 14.35, 1.53, 2.41 }
    rotCaches = {
      rotCommonCaches,
      rotLegendaryCaches,
      rotCommonCaches,
    }
    spacesCaches = {
      posClashSpaces["column2"][1],
      posClashSpaces["column2"][4],
      posClashSpaces["column6"][4],
    }
    spacesEnemies = {
      posClashSpaces["column1"][3],
      posClashSpaces["column3"][1],
      posClashSpaces["column5"][5],
      posClashSpaces["column5"][1],
      posClashSpaces["column1"][1],
      posClashSpaces["column7"][3],
      posClashSpaces["column5"][3],
      posClashSpaces["column4"][1],
    }
  
  elseif cardName == "Vine Snared" then
    rotEntranceTile = { 0, 120, 0 }
    posEntranceTile = { 14.35, 1.53, 2.41 }
    rotCaches = {
      rotCommonCaches,
      rotCommonCaches,
      rotCommonCaches,
    }
    spacesCaches = {
      posClashSpaces["column1"][2],
      posClashSpaces["column3"][1],
      posClashSpaces["column3"][5],
    }
    spacesEnemies = {
      posClashSpaces["column4"][1],
      posClashSpaces["column4"][4],
      posClashSpaces["column3"][2],
      posClashSpaces["column3"][4],
      posClashSpaces["column2"][1],
      posClashSpaces["column2"][4],
      posClashSpaces["column1"][1],
      posClashSpaces["column1"][3],
    }

  
  
  elseif cardName == "Parting the Veiled" then
    rotEntranceTile = { 0, 300, 0 }
    posEntranceTile = { -12.32, 1.53, 2.41 }
    rotCaches = {
      rotCommonCaches,
      rotLegendaryCaches,
      rotCommonCaches,
    }
    spacesCaches = {
      posClashSpaces["column5"][1],
      posClashSpaces["column5"][3],
      posClashSpaces["column5"][5],
    }
    spacesEnemies = {
      posClashSpaces["column3"][1],
      posClashSpaces["column3"][5],
      posClashSpaces["column7"][2],
      posClashSpaces["column1"][2],
      posClashSpaces["column2"][1],
      posClashSpaces["column4"][4],
      posClashSpaces["column4"][1],
      posClashSpaces["column2"][4],
    }

  end

  if not (cardName == "Good Finds are Hard to Help" and optionNumber == 2) then 
    local bagEntranceTiles = getObjectbyName("Entrance Tile Bag")
    local entranceTile = bagEntranceTiles.takeObject()

    Wait.frames(function()
      entranceTile.setRotation(rotEntranceTile)
      entranceTile.setPosition(posEntranceTile)
      entranceTile.setLock(true)
    end)
  end

  local bagCacheChips = getObjectbyName("Cache Chip Bag")

  -- special cache handling per encounter
  local playerCount = getObjectbyName("Button Player Count").getVar('val')

  -- Captured! needs to flip common caches to legendary at 3+ players
  if cardName == "Captured!" and playerCount > 2 then
    rotCaches = {
      rotLegendaryCaches,
      rotLegendaryCaches,
      rotLegendaryCaches,
      rotLegendaryCaches,
    }
  end

  -- Augmented Arms need to flip common to legendary if on an unstable space
  local isUnstable = checkIfUnstable()
  if cardName == "Augmented Arms" and isUnstable then
    rotCaches = {
      rotLegendaryCaches,
      rotLegendaryCaches,
      rotLegendaryCaches,
      rotLegendaryCaches,
      rotLegendaryCaches,
      rotLegendaryCaches,
    }
  end

  -- Keep Away needs to deploy correct number of caches, 3+ players = 5, otherwise = 3
  if cardName == "Keep Away" and playerCount > 2 then
     spacesCaches = {
      posClashSpaces["column1"][1],
      posClashSpaces["column3"][1],
      posClashSpaces["column4"][4],
      posClashSpaces["column1"][2],
      posClashSpaces["column7"][1],
    }
  end

  Wait.time(function()

    if cardName == "Keep Ayleid on It" then      
      for i = 1, playerCount+1 do
        local highlightColor = rotCaches[i] == rotCommonCaches and "Green" or "Orange"
        local cache = bagCacheChips.takeObject({rotation = rotCaches[i], position = spacesCaches[i], smooth = true})
        Wait.frames(function() cache.highlightOn(highlightColor) end)
      end

    elseif cardName == "Deals in Dwemer" and optionNumber == 2 then
      log("Deals in Dwemer: skipping cache placement")

    elseif cardName == "Augmented Arms" then
      for i = 1, playerCount+2 do
        local highlightColor = rotCaches[i] == rotCommonCaches and "Green" or "Orange"
        local cache = bagCacheChips.takeObject({rotation = rotCaches[i], position = spacesCaches[i], smooth = true})
        Wait.frames(function() cache.highlightOn(highlightColor) end)
      end

    else
      for i = 1, #spacesCaches do
        local highlightColor = rotCaches[i] == rotCommonCaches and "Green" or "Orange"
        local cache = bagCacheChips.takeObject({rotation = rotCaches[i], position = spacesCaches[i], smooth = true})
        Wait.frames(function() cache.highlightOn(highlightColor) end)
      end
    end
  end, 1)

  Wait.time(function() deployClashEnemies(cardName, spacesEnemies, optionNumber) end, 2)

  broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Clash has begun[-]: " .. cardName, "White")

end


function deployDelve(cardName, optionNumber)
  
  -- this function handles the setup and deployment of a delve encounter
  -- currently will only pull, place, and lock an entrance tile
  local bagEntranceTiles = getObjectbyName("Entrance Tile Bag")
  local rotEntranceTile = { 0, 300, 0 }
  local posEntranceTile = { -25.63, 1.53, 14.84 }

  local entranceTile = bagEntranceTiles.takeObject()

  Wait.frames(function()
    entranceTile.setRotation(rotEntranceTile)
    entranceTile.setPosition(posEntranceTile)
    entranceTile.setLock(true)
  end)

  broadcastToAll("Delve has begun: " .. cardName, "White")

end


function getChipBreakdown(value)

  -- this function takes in an EP value and returns a table with keyed values
  -- ie: 78 - result = { [20]=3, [10]=1, [5]=1, [1]=3 }
  local chipBreakdown = {}
  chipBreakdown[20] = math.floor(value / 20)
  value = value % 20
  chipBreakdown[10] = math.floor(value / 10)
  value = value % 10
  chipBreakdown[5]  = math.floor(value / 5)
  value = value % 5
  chipBreakdown[1]  = value
  return chipBreakdown
end


function deployClashEnemies(cardName, spacesEnemies, optionNumber)

  -- this function handles the individual enemy setup requirements for any given clash
  local currentCalculatedEP = getObjectbyName("Button Calculated EP").getVar('val')
  local playerCount = getObjectbyName("Button Player Count").getVar('val')
  local chipBreakdown = getChipBreakdown(currentCalculatedEP)
  local bagLow, bagHigh = getObjectbyName("Level 1 / 5 Enemies"), getObjectbyName("Level 10 / 20 Enemies")
  bagLow.shuffle()
  bagHigh.shuffle()
  local enemyCount = 0

  -- GENERAL ENCOUNTERS
  if cardName == "Wabbajack Attack" then
    -- before deploying EP, add khajiit marauder (<3) or khajiit cultist to enemy pool and deploy
    local extraEnemy = playerCount < 3 and "Khajiit Marauder" or "Khajiit Cultist"
    local extraBag = playerCount < 3 and bagLow or bagHigh
    local extraRot = { 0, 180, 180 }
    for _, object in pairs(extraBag.getObjects()) do
      if object.name:find(extraEnemy) then
        local chipExtraEnemy = extraBag.takeObject({guid = object.guid, rotation = extraRot})
        enemyCount = 1
        Wait.frames(function()
          -- chipExtraEnemy.setVar('fresh_out_of_bag')
          chipExtraEnemy.setPositionSmooth(spacesEnemies[enemyCount], false, true)
        end)
        break
      end
    end

    -- deploy rest of EP
    Wait.time(function()

      if chipBreakdown[20] > 0 then
        for i = 1, chipBreakdown[20] do
          if enemyCount < 8 then
            local chip20 = bagHigh.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip20.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[10] > 0 then
        for i = 1, chipBreakdown[10] do
          if enemyCount < 8 then
            local chip10 = bagHigh.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip10.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[5] > 0 then
        for i = 1, chipBreakdown[5] do
          if enemyCount < 8 then
            local chip5 = bagLow.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip5.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[1] > 0 then
        for i = 1, chipBreakdown[1] do
          if enemyCount < 8 then
            local chip1 = bagLow.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip1.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end
    end, 1)

  elseif cardName == "The Wacky Box of Wonders" then
    -- check if unstable to determine if 3 or 4 fatigue is needed
    local isUnstable = checkIfUnstable()
    local fatigueCount = isUnstable and 4 or 3
    local bagLightFatigue = getObjectbyName("Fatigue Dice Bag")
    -- somehow determine which adv mats are actually in use
    local seatedColors = {"Red", "Orange", "Blue", "Green"}
    local actuallySeatedColors = {}
    for i = 1, 4 do
      local matExists = false
      local buttonExists = false
      for _, object in pairs(getObjects()) do
        -- detect if player mat exists
        if object.getName() == seatedColors[i] .. " Adventurer Mat" then
          matExists = true
          break
        end
      end

      -- if mat exists, check for button (should not be there if actually seated)
      if matExists then
        for _, obj in pairs(getObjects()) do
          if obj.getName() == "Button Clear Playerarea" and obj.getGMNotes() == seatedColors[i] then
            buttonExists = true
            break
          end
        end
      end

      -- once veriied player is seated at location, draw and add fatigue dice to cooldown track
      if matExists and not buttonExists then
        local waitTimer = 0
        for j = 1, fatigueCount do
          if #bagLightFatigue.getObjects() > 0 then
            Wait.time(function()

              local lightFatigue = bagLightFatigue.takeObject()
              placeDieToTrack(seatedColors[i], lightFatigue, "Cooldown")

            end, waitTimer)

          else
            broadcastToAll("Light Fatigue supply out, handle Wacky Box of Wonders Setup manually.", "Orange")
            return
          end
          waitTimer = waitTimer + .50
        end

        -- wait for fatigue dice to place, then draw, roll, & place status effect die to cooldown track
        Wait.time(function()
          
          local bagStatusDice = getObjectbyName("Status Effect Dice Bag")
          if #bagStatusDice.getObjects() < 1 then
            broadcastToAll("Unable to take a Status Die - Supply is empty!", "Orange")
            return
          else
            local statusEffectDie = bagStatusDice.takeObject()
            local dieResults = {"Stealth", "Blind", "Daze", "Maim", "Fear", "Bane"}
            
            Wait.frames(function()
              placeDieToTrack(seatedColors[i], statusEffectDie, "Roll")

              Wait.time(function()
                statusEffectDie.randomize()
                Wait.condition(
                  function()
                    statusEffectDie.setRotationValue(statusEffectDie.getRotationValue())
                    if Player[seatedColors[i]].steam_name ~= nil then
                      broadcastToAll("[" .. Color.fromString(seatedColors[i]):toHex() .. "]" .. Player[seatedColors[i]].steam_name .. "[-] has rolled: " .. dieResults[statusEffectDie.getRotationValue()], "White")
                    else
                      broadcastToAll("[" .. Color.fromString(seatedColors[i]):toHex() .. "]" .. seatedColors[i] .. " Player[-]  has rolled: " .. dieResults[statusEffectDie.getRotationValue()], "White")
                    end
                    Wait.time(function()
                      placeDieToTrack(seatedColors[i], statusEffectDie, "Cooldown")
                    end, .5)
                  end,
                  function() return statusEffectDie.resting end
                )
              end, .5)
            end)
          end

        end, 2.5)
      end
    end
    -- gain light fatigue, then, roll status die and place to CD track
    -- first enemy deployed must be a human type
    local firstEnemyDrawn = false
    Wait.time(function()

      if chipBreakdown[20] > 0 then
        for i = 1, chipBreakdown[20] do
          local chip20 = nil
          enemyCount = enemyCount + 1
          local index = enemyCount
          if enemyCount < 8 then
            if firstEnemyDrawn then
                chip20 = bagHigh.takeObject({rotation = { 0, 180, 0 }})
                Wait.frames(function() chip20.setPositionSmooth(spacesEnemies[index], false, true) end)
            else
              chip20 = deployEnemyType(20, "Human", spacesEnemies[index])
              firstEnemyDrawn = true
            end
          end
        end
      end

      if chipBreakdown[10] > 0 then
        for i = 1, chipBreakdown[10] do
          local chip10 = nil
          enemyCount = enemyCount + 1
            local index = enemyCount
          if enemyCount < 8 then
            if firstEnemyDrawn then
                chip10 = bagHigh.takeObject({rotation = { 0, 180, 180 }})
                Wait.frames(function() chip10.setPositionSmooth(spacesEnemies[index], false, true) end)              
            else
              chip10 = deployEnemyType(10, "Human", spacesEnemies[index])
              firstEnemyDrawn = true
            end
          end
        end
      end

      if chipBreakdown[5] > 0 then
        for i = 1, chipBreakdown[5] do
          local chip5 = nil
          enemyCount = enemyCount + 1
          local index = enemyCount
          if enemyCount < 8 then
            if firstEnemyDrawn then
                chip5 = bagLow.takeObject({rotation = { 0, 180, 0 }})
                Wait.frames(function() chip5.setPositionSmooth(spacesEnemies[index], false, true) end)
            else
              chip5 = deployEnemyType(5, "Human", spacesEnemies[index])
              firstEnemyDrawn = true
            end
          end
        end
      end

      if chipBreakdown[1] > 0 then
        for i = 1, chipBreakdown[1] do
          local chip1 = nil
          if enemyCount < 8 then
            enemyCount = enemyCount + 1
            local index = enemyCount
            if firstEnemyDrawn then
                chip1 = bagLow.takeObject({rotation = { 0, 180, 180 }})
                Wait.frames(function() chip1.setPositionSmooth(spacesEnemies[index], false, true) end)
            else
              chip1 = deployEnemyType(1, "Human", spacesEnemies[index])
              firstEnemyDrawn = true
            end
          end
        end
      end
    end, 1)


  elseif cardName == "Highwaymen" then
    -- only extra setup required is to broadcast a reminder to remove a cache chip at 3+ players

    -- deploy EP
    Wait.time(function()

      if chipBreakdown[20] > 0 then
        for i = 1, chipBreakdown[20] do
          if enemyCount < 8 then
            local chip20 = bagHigh.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip20.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[10] > 0 then
        for i = 1, chipBreakdown[10] do
          if enemyCount < 8 then
            local chip10 = bagHigh.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip10.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[5] > 0 then
        for i = 1, chipBreakdown[5] do
          if enemyCount < 8 then
            local chip5 = bagLow.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip5.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[1] > 0 then
        for i = 1, chipBreakdown[1] do
          if enemyCount < 8 then
            local chip1 = bagLow.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip1.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end
    end, 1)

    -- broadcast reminder to remove cache chip if 3+    
    if playerCount > 2 then
      broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder 3+ Players[-]: Remember to select a cache chip to remove.", "White")
    end
    
  elseif cardName == "Captured!" then
    -- only extra setup required is cache related (common caches should be legendary instead at 3+ player count), so, normal enemy deployment otherwise

    -- deploy EP
    Wait.time(function()

      if chipBreakdown[20] > 0 then
        for i = 1, chipBreakdown[20] do
          if enemyCount < 8 then
            local chip20 = bagHigh.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip20.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[10] > 0 then
        for i = 1, chipBreakdown[10] do
          if enemyCount < 8 then
            local chip10 = bagHigh.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip10.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[5] > 0 then
        for i = 1, chipBreakdown[5] do
          if enemyCount < 8 then
            local chip5 = bagLow.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip5.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[1] > 0 then
        for i = 1, chipBreakdown[1] do
          if enemyCount < 8 then
            local chip1 = bagLow.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip1.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end
    end, 1)


  elseif cardName == "Unsullied Pool" then
    -- use as many beasts as possible while deploying EP, at 3+ players, will need to adjust HP +2 on enemies, and broadcast reminder to flip lvl 1s to 5s

    -- deploy EP
    local toModifyHP = {}
    Wait.time(function()

      if chipBreakdown[20] > 0 then
        for i = 1, chipBreakdown[20] do
          if enemyCount < 8 then
            enemyCount = enemyCount + 1
            local index = enemyCount
            local chip20 = deployEnemyType(20, "Beast", spacesEnemies[index])
            Wait.frames(function()
              if chip20 == nil then chip20 = bagHigh.takeObject({rotation = { 0, 180, 0 }}) end
              Wait.frames(function() chip20.setPositionSmooth(spacesEnemies[index], false, true) table.insert(toModifyHP, chip20) end)
            end)
          end
        end
      end

      if chipBreakdown[10] > 0 then
        for i = 1, chipBreakdown[10] do
          if enemyCount < 8 then
            enemyCount = enemyCount + 1
            local index = enemyCount
            local chip10 = deployEnemyType(10, "Beast", spacesEnemies[index])
            Wait.frames(function()
              if chip10 == nil then chip10 = bagHigh.takeObject({rotation = { 0, 180, 180 }}) end
              Wait.frames(function() chip10.setPositionSmooth(spacesEnemies[index], false, true) table.insert(toModifyHP, chip10) end)
            end)
          end
        end
      end

      if chipBreakdown[5] > 0 then
        for i = 1, chipBreakdown[5] do
          if enemyCount < 8 then
            enemyCount = enemyCount + 1
            local index = enemyCount
            local chip5 = deployEnemyType(5, "Beast", spacesEnemies[index])
            Wait.frames(function()
              if chip5 == nil then chip5 = bagLow.takeObject({rotation = { 0, 180, 0 }}) end
              Wait.frames(function() chip5.setPositionSmooth(spacesEnemies[index], false, true) table.insert(toModifyHP, chip5) end)
            end)
          end
        end
      end

      if chipBreakdown[1] > 0 then
        for i = 1, chipBreakdown[1] do
          if enemyCount < 8 then
            enemyCount = enemyCount + 1
            local index = enemyCount
            local chip1 = deployEnemyType(1, "Beast", spacesEnemies[index])
            Wait.frames(function()
              if chip1 == nil then chip1 = bagLow.takeObject({rotation = { 0, 180, 180 }}) end
              Wait.frames(function() chip1.setPositionSmooth(spacesEnemies[index], false, true) table.insert(toModifyHP, chip1) end)
            end)
          end
        end
      end

      -- broadcast Reminder to flip playerCount enemies from 1 to 5
      broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder[-]: Flip " .. playerCount .. " level 1 enemies to lvl 5 side if possible, keeping same HP values (will need to use counter after flip).", "White")
    end, 1)

    -- at 3+ players, increase all deployed chips HP by 2
    if playerCount > 2 then
      Wait.time(function()
        
        broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]3+ Players[-]: Enemy HP values are increased by 2.", "White")
        for _, chip in pairs(toModifyHP) do
          local oldVal = chip.getVar('val')
          local newVal = oldVal + 2
          local bagScript = getObjectbyName("Defeated Monsters Bag")
          bagScript.call('set_val_remote', {chipObj=chip, val=newVal})
        end
      
      end, 3)
    end

  elseif cardName == "Black Market Economics" then

    -- if optionNumber == 1, need to deploy a level 5 or 10 (3+ players) enemy last

    -- deploy EP
    Wait.time(function()

      if chipBreakdown[20] > 0 then
        for i = 1, chipBreakdown[20] do
          if enemyCount < 8 then
            local chip20 = bagHigh.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip20.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[10] > 0 then
        for i = 1, chipBreakdown[10] do
          if enemyCount < 8 then
            local chip10 = bagHigh.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip10.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[5] > 0 then
        for i = 1, chipBreakdown[5] do
          if enemyCount < 8 then
            local chip5 = bagLow.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip5.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[1] > 0 then
        for i = 1, chipBreakdown[1] do
          if enemyCount < 8 then
            local chip1 = bagLow.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip1.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      -- handle extra enemy
      local bagExtraEnemyDraw = getObjectbyName(playerCount > 2 and "Level 10 / 20 Enemies" or "Level 1 / 5 Enemies")
      if enemyCount < 8 then
        local extraEnemy = bagExtraEnemyDraw.takeObject({rotation = playerCount > 2 and { 0, 180, 180 } or { 0, 180, 0 }})
        enemyCount = enemyCount + 1
        local index = enemyCount
        Wait.frames(function() extraEnemy.setPositionSmooth(spacesEnemies[index], false, true) end)
      else

      end
    end, 1)

  elseif cardName == "Keep Away" then
  
    -- normal enemy deployment, 3+ players need extra caches deployed

    -- deploy EP
    Wait.time(function()

      if chipBreakdown[20] > 0 then
        for i = 1, chipBreakdown[20] do
          if enemyCount < 8 then
            local chip20 = bagHigh.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip20.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[10] > 0 then
        for i = 1, chipBreakdown[10] do
          if enemyCount < 8 then
            local chip10 = bagHigh.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip10.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[5] > 0 then
        for i = 1, chipBreakdown[5] do
          if enemyCount < 8 then
            local chip5 = bagLow.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip5.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[1] > 0 then
        for i = 1, chipBreakdown[1] do
          if enemyCount < 8 then
            local chip1 = bagLow.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip1.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end
    end, 1)
  
  -- BM ENCOUNTERS
  elseif cardName == "Captives of House Telvanni" then
    -- broadcast reminder that all adventurers need to make a lockpick check (1-5-2) with 3 attempts
    -- and also broadcast reminder if weather is flooding that adventurers have 2 fewer attempts during lockpick checks
    local attemptCount = checkWeather() == "Flooding" and 1 or 3
    broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder[-]: All adventurers must make an initial lockpick check 1-5-2 (" .. attemptCount .. ").", "White")
    Wait.time(function()
      if checkWeather() == "Flooding" then
        broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder[-]: Current weather is flooding, adventurers will have 2 fewer attempts during lockpick checks.", "White")        
      end
      if playerCount > 2 then
        broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder 3+ Players[-]: Adventurers gain overfatigue instead of light fatigue when adjusting lockpick dice.", "White")
      end
    end, 1)

    -- deploy EP
    Wait.time(function()

      if chipBreakdown[20] > 0 then
        for i = 1, chipBreakdown[20] do
          if enemyCount < 8 then
            local chip20 = bagHigh.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip20.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[10] > 0 then
        for i = 1, chipBreakdown[10] do
          if enemyCount < 8 then
            local chip10 = bagHigh.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip10.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[5] > 0 then
        for i = 1, chipBreakdown[5] do
          if enemyCount < 8 then
            local chip5 = bagLow.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip5.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[1] > 0 then
        for i = 1, chipBreakdown[1] do
          if enemyCount < 8 then
            local chip1 = bagLow.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip1.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end
    end, 1)

  elseif cardName == "Corrupted Communion" then
    local weatherToken = nil
    -- set weather to flooding
    for _, object in pairs(getObjects()) do
      if object.getName() == "Book Overland Token" and object.getDescription() == "Weather Gauge" then
        weatherToken = object
      end
    end
    if weatherToken == nil then log("deployClashEnemies() weatherToken not found") return end

    -- after deploying EP, deploy additional level 1 enemies to remaining unoccupied enemy hexes
    local deployedChips = {}

    -- deploy EP
    Wait.time(function()

      if chipBreakdown[20] > 0 then
        for i = 1, chipBreakdown[20] do
          if enemyCount < 8 then
            local chip20 = bagHigh.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount

            if enemyCount <= 4 then
              table.insert(deployedChips, chip20)
            end

            Wait.frames(function() chip20.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[10] > 0 then
        for i = 1, chipBreakdown[10] do
          if enemyCount < 8 then
            local chip10 = bagHigh.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount

            if enemyCount <= 4 then
              table.insert(deployedChips, chip10)
            end

            Wait.frames(function() chip10.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[5] > 0 then
        for i = 1, chipBreakdown[5] do
          if enemyCount < 8 then
            local chip5 = bagLow.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount

            if enemyCount <= 4 then
              table.insert(deployedChips, chip5)
            end

            Wait.frames(function() chip5.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[1] > 0 then
        for i = 1, chipBreakdown[1] do
          if enemyCount < 8 then
            local chip1 = bagLow.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount

            if enemyCount <= 4 then
              table.insert(deployedChips, chip1)
            end

            Wait.frames(function() chip1.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      -- fill remaining empty spaces with level 1s
      if enemyCount < 8 then
        for index = enemyCount + 1, 8 do
          local chip1extra = bagLow.takeObject({rotation = { 0, 180, 180 }})
          -- include filler chips for first 4 status dice logic
          if index <= 4 then
            table.insert(deployedChips, chip1extra)
          end
          Wait.frames(function() chip1extra.setPositionSmooth(spacesEnemies[index], false, true) end)
        end
      end

    end, 1)

    -- apply blind status die to first 4 enemies deployed
    Wait.time(function()

      local bagStatusEffectDice = getObjectbyName("Status Effect Dice Bag")
      
      for _, chip in ipairs(deployedChips) do
        
        local chipPos = chip.getPosition()
        local diePos = { chipPos.x, 4, chipPos.z }

        local statusDie = bagStatusEffectDice.takeObject({
          rotation = { 0, 0, 0 }
        })

        Wait.frames(function()
          statusDie.setPositionSmooth(diePos, false, true)
          statusDie.setDescription("Blind:\nThis unit has a range of 1, considers allied units to targetable, and can only target the strongest adjacent unit.")
        end)
        
      end

    end, 2)

    -- if unstable, broadcast reminder to flip playerCount lvl 1 enemies to level 5, adjusting their HP
    if checkIfUnstable() then
      broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder[-]: Party token is currently at unstable location, the party will need to flip up to " .. playerCount ..  " level 1 enemies.", "White")        
    end

  elseif cardName == "Deal or Die" then
    -- no odd setup stuff outside of maybe broadcasting a reminder if weather is flooding
    if checkWeather() == "Flooding" then
      broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder[-]: Weather is currently Flooding, unit may only move 1 hex during their movement actions.", "White")
    end

    -- deploy EP
    Wait.time(function()

      if chipBreakdown[20] > 0 then
        for i = 1, chipBreakdown[20] do
          if enemyCount < 8 then
            local chip20 = bagHigh.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip20.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[10] > 0 then
        for i = 1, chipBreakdown[10] do
          if enemyCount < 8 then
            local chip10 = bagHigh.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip10.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[5] > 0 then
        for i = 1, chipBreakdown[5] do
          if enemyCount < 8 then
            local chip5 = bagLow.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip5.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[1] > 0 then
        for i = 1, chipBreakdown[1] do
          if enemyCount < 8 then
            local chip1 = bagLow.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip1.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end
    end, 1)

  elseif cardName == "Keep Ayleid on It" then

    local deployedChips = {}
    local initialCalculatedEP = currentCalculatedEP
    local epSpent = 0

    Wait.time(function()

      -- 20s
      if chipBreakdown[20] > 0 then
        for i = 1, chipBreakdown[20] do
          if enemyCount < playerCount then
            local chipValue = 20
            local chip20 = bagHigh.takeObject({rotation = {0,180,0}})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function()
              chip20.setPositionSmooth(spacesEnemies[index], false, true)
              table.insert(deployedChips, chip20)
            end)
            currentCalculatedEP = currentCalculatedEP - chipValue
            epSpent = epSpent + chipValue
          end
        end
      end

      -- 10s
      if chipBreakdown[10] > 0 then
        for i = 1, chipBreakdown[10] do
          if enemyCount < playerCount then
            local chipValue = 10
            local chip10 = bagHigh.takeObject({rotation = {0,180,180}})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function()
              chip10.setPositionSmooth(spacesEnemies[index], false, true)
              table.insert(deployedChips, chip10)
            end)
            currentCalculatedEP = currentCalculatedEP - chipValue
            epSpent = epSpent + chipValue
          end
        end
      end

      -- 5s
      if chipBreakdown[5] > 0 then
        for i = 1, chipBreakdown[5] do
          if enemyCount < playerCount then
            local chipValue = 5
            local chip5 = bagLow.takeObject({rotation = {0,180,0}})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function()
              chip5.setPositionSmooth(spacesEnemies[index], false, true)
              table.insert(deployedChips, chip5)
            end)
            currentCalculatedEP = currentCalculatedEP - chipValue
            epSpent = epSpent + chipValue
          end
        end
      end

      -- 1s
      if chipBreakdown[1] > 0 then
        for i = 1, chipBreakdown[1] do
          if enemyCount < playerCount then
            local chipValue = 1
            local chip1 = bagLow.takeObject({rotation = {0,180,180}})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function()
              chip1.setPositionSmooth(spacesEnemies[index], false, true)
              table.insert(deployedChips, chip1)
            end)
            currentCalculatedEP = currentCalculatedEP - chipValue
            epSpent = epSpent + chipValue
          end
        end
      end

      -- final HP calc AFTER all EP deductions are complete
      Wait.time(function()

        local remainingEP = initialCalculatedEP - epSpent
        local hpIncrease = math.floor(remainingEP / 5)

        for _, chip in ipairs(deployedChips) do
          local oldVal = chip.getVar('val')
          local newVal = oldVal + hpIncrease
          local bagScript = getObjectbyName("Defeated Monsters Bag")
          bagScript.call('set_val_remote', {chipObj=chip, val=newVal})
        end

        broadcastToAll(
          "[" .. Color.fromString("Orange"):toHex() .. "]Reminder[-]: " ..
          remainingEP .. " remaining in Calculated EP after deployment, increasing HP by " .. hpIncrease .. ".",
          "White"
        )

      end, 2)

    end, 1)


  elseif cardName == "Origin of the Species" then
    -- first enemy deployed must be a beast type and it's health stat is doubled, maybe highlight red or something
    -- 3+ players: add quest unit skill Vindictive to first beast enemy
    local firstEnemyDrawn = false
    local vindictiveDescription = "\n\nVindictive:\nThis unit increases its Combat stat by the number of opposing adventurers."
    Wait.time(function()

      -- 20 EP chips
      if chipBreakdown[20] > 0 then
        for i = 1, chipBreakdown[20] do
          local chip20 = nil
          if enemyCount < 8 then
            enemyCount = enemyCount + 1
            local index = enemyCount

            if firstEnemyDrawn then
              chip20 = bagHigh.takeObject({rotation = {0,180,0}})
              Wait.frames(function() chip20.setPositionSmooth(spacesEnemies[index], false, true) end)
            else
              chip20 = deployEnemyType(20, "Beast", spacesEnemies[index])
              firstEnemyDrawn = true
              Wait.time(function()
              
                local oldVal = chip20.getVar('val')
                local newVal = oldVal * 2
                local bagScript = getObjectbyName("Defeated Monsters Bag")
                bagScript.call('set_val_remote', {chipObj=chip20, val=newVal})
                chip20.highlightOn("Red")
                if playerCount > 2 then                  
                  chip20.setDescription(chip20.getDescription() .. vindictiveDescription)
                  broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder 3+ Players[-]: New species gains quest unit skill: Vindictive.", "White")
                end

              end, 1)
            end

          end
        end
      end

      -- 10 EP chips
      if chipBreakdown[10] > 0 then
        for i = 1, chipBreakdown[10] do
          local chip10 = nil
          if enemyCount < 8 then
            enemyCount = enemyCount + 1
            local index = enemyCount

            if firstEnemyDrawn then
              chip10 = bagHigh.takeObject({rotation = {0,180,180}})
              Wait.frames(function() chip10.setPositionSmooth(spacesEnemies[index], false, true) end)
            else
              chip10 = deployEnemyType(10, "Beast", spacesEnemies[index])
              firstEnemyDrawn = true
              Wait.time(function()
              
                local oldVal = chip10.getVar('val')
                local newVal = oldVal * 2
                local bagScript = getObjectbyName("Defeated Monsters Bag")
                bagScript.call('set_val_remote', {chipObj=chip10, val=newVal})
                chip10.highlightOn("Red")
                if playerCount > 2 then                  
                  chip10.setDescription(chip10.getDescription() .. vindictiveDescription)
                  broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder 3+ Players[-]: New species gains quest unit skill: Vindictive.", "White")
                end

              end, 1)
            end
          end
        end
      end

      -- 5 EP chips
      if chipBreakdown[5] > 0 then
        for i = 1, chipBreakdown[5] do
          local chip5 = nil
          if enemyCount < 8 then
            enemyCount = enemyCount + 1
            local index = enemyCount

            if firstEnemyDrawn then
              chip5 = bagLow.takeObject({rotation = {0,180,0}})
              Wait.frames(function() chip5.setPositionSmooth(spacesEnemies[index], false, true) end)
            else
              chip5 = deployEnemyType(5, "Beast", spacesEnemies[index])
              firstEnemyDrawn = true
              Wait.time(function()
              
                local oldVal = chip5.getVar('val')
                local newVal = oldVal * 2
                local bagScript = getObjectbyName("Defeated Monsters Bag")
                bagScript.call('set_val_remote', {chipObj=chip5, val=newVal})
                chip5.highlightOn("Red")
                if playerCount > 2 then                  
                  chip5.setDescription(chip5.getDescription() .. vindictiveDescription)
                  broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder 3+ Players[-]: New species gains quest unit skill: Vindictive.", "White")
                end

              end, 1)
            end
          end
        end
      end

      -- 1 EP chips
      if chipBreakdown[1] > 0 then
        for i = 1, chipBreakdown[1] do
          local chip1 = nil
          if enemyCount < 8 then
            enemyCount = enemyCount + 1
            local index = enemyCount

            if firstEnemyDrawn then
              chip1 = bagLow.takeObject({rotation = {0,180,180}})
              Wait.frames(function() chip1.setPositionSmooth(spacesEnemies[index], false, true) end)
            else
              chip1 = deployEnemyType(1, "Beast", spacesEnemies[index])
              firstEnemyDrawn = true
              Wait.time(function()
              
                local oldVal = chip1.getVar('val')
                local newVal = oldVal * 2
                local bagScript = getObjectbyName("Defeated Monsters Bag")
                bagScript.call('set_val_remote', {chipObj=chip1, val=newVal})
                chip1.highlightOn("Red")
                if playerCount > 2 then                  
                  chip1.setDescription(chip1.getDescription() .. vindictiveDescription)
                  broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder 3+ Players[-]: New species gains quest unit skill: Vindictive.", "White")
                end

              end, 1)
            end
          end
        end
      end

      -- now deploy playerCount level 1 enemies, up to 8 total enemies
      local lvl1DeployCount = playerCount

      Wait.time(function()
        for i = 1, lvl1DeployCount do
          if enemyCount < 8 then
            enemyCount = enemyCount + 1
            local index = enemyCount

            local chip1 = bagLow.takeObject({rotation = {0,180,180}})
            Wait.frames(function()
              chip1.setPositionSmooth(spacesEnemies[index], false, true)
            end)
          end
        end
      end, 1.5)

    end, 1)
 
  elseif cardName == "Captive Audience" then
    -- add level 5 dark elf marauder to EP and deploy it first
    local extraEnemy = "Dark Elf Marauder"
    local extraBag = bagLow
    local extraRot = { 0, 180, 0 }
    for _, object in pairs(extraBag.getObjects()) do
      if object.name:find(extraEnemy) then
        local chipExtraEnemy = extraBag.takeObject({guid = object.guid, rotation = extraRot})
        enemyCount = 1
        Wait.frames(function()
          -- chipExtraEnemy.setVar('fresh_out_of_bag')
          chipExtraEnemy.setPositionSmooth(spacesEnemies[enemyCount], false, true)
        end)
        break
      end
    end

    -- deploy EP
    Wait.time(function()

      if chipBreakdown[20] > 0 then
        for i = 1, chipBreakdown[20] do
          if enemyCount < 8 then
            local chip20 = bagHigh.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip20.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[10] > 0 then
        for i = 1, chipBreakdown[10] do
          if enemyCount < 8 then
            local chip10 = bagHigh.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip10.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[5] > 0 then
        for i = 1, chipBreakdown[5] do
          if enemyCount < 8 then
            local chip5 = bagLow.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip5.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[1] > 0 then
        for i = 1, chipBreakdown[1] do
          if enemyCount < 8 then
            local chip1 = bagLow.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip1.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end
    end, 1)

    -- if weather is rainy or flooding, each adventurer drains 1 available skill die (broadcast reminder)
    -- if weather is flooding, each adventurer also gains 1 overfatigue
    local currentWeather = checkWeather()
    if currentWeather == "Rainy" then
      broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder[-]: Current weather in Black Marsh is Rainy - Adventurers select 1 available skill die to drain.", "White")
    elseif currentWeather == "Flooding" then
      broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder[-]: Current weather in Black Marsh is Flooding - Adventurers select 1 available skill die to drain (manually), and also gain 1 overfatigue.", "White")
    end

    -- 3+ players: remove 1 cache (broadcast reminder)
    if playerCount > 2 then
      broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder 3+ Players[-]: Remember to select a cache chip to remove.", "White")
    end  

  -- CY ENCOUNTERS 
  elseif cardName == "Heroes for Hire" then
    -- OPTION 1
    -- add playerCount level 1 enemies to the EP and deploy them last
    -- OPTION 2
    -- decrease calculatedEP by 2 (minimum of 1)
    if optionNumber == 2 then
      currentCalculatedEP = currentCalculatedEP - 2
      if currentCalculatedEP < 1 then currentCalculatedEP = 1 end
      chipBreakdown = getChipBreakdown(currentCalculatedEP)
    end

    -- deploy EP
    Wait.time(function()

      if chipBreakdown[20] > 0 then
        for i = 1, chipBreakdown[20] do
          if enemyCount < 8 then
            local chip20 = bagHigh.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip20.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[10] > 0 then
        for i = 1, chipBreakdown[10] do
          if enemyCount < 8 then
            local chip10 = bagHigh.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip10.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[5] > 0 then
        for i = 1, chipBreakdown[5] do
          if enemyCount < 8 then
            local chip5 = bagLow.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip5.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[1] > 0 then
        for i = 1, chipBreakdown[1] do
          if enemyCount < 8 then
            local chip1 = bagLow.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip1.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end
    end, 1)

    -- now deploy playerCount level 1 enemies, up to 8 total enemies
    if optionNumber == 1 then
      local lvl1DeployCount = playerCount
      Wait.time(function()

        for i = 1, lvl1DeployCount do
          if enemyCount < 8 then
            enemyCount = enemyCount + 1
            local index = enemyCount

            local chip1 = bagLow.takeObject({rotation = {0,180,180}})
            Wait.frames(function()
              chip1.setPositionSmooth(spacesEnemies[index], false, true)
            end)
          end
        end

      end, 1.5)
    end


  elseif cardName == "Champion of the Downtrodden" then
    -- place 5 - playerCount generic counters with 4 HP next to entrance tile
    local posCounters = {
      {-11.28, 1.75, 7.74},
      {-11.28, 1.75, 4.19},
      {-11.28, 1.75, 0.64},
      {-11.28, 1.75, -2.91},
    }
    local bagCounter = getObjectbyName("Generic Counter Bag")
    local counterCount = 5 - playerCount

    for i = 1, counterCount do
      local counter = bagCounter.takeObject()
      Wait.frames(function()
        counter.setRotation({ 0, 180, 0 })
        counter.setPosition(posCounters[i])
        counter.call('set_val', 4)
      end)
    end
    -- deploy EP
    Wait.time(function()

      if chipBreakdown[20] > 0 then
        for i = 1, chipBreakdown[20] do
          if enemyCount < 8 then
            local chip20 = bagHigh.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip20.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[10] > 0 then
        for i = 1, chipBreakdown[10] do
          if enemyCount < 8 then
            local chip10 = bagHigh.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip10.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[5] > 0 then
        for i = 1, chipBreakdown[5] do
          if enemyCount < 8 then
            local chip5 = bagLow.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip5.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[1] > 0 then
        for i = 1, chipBreakdown[1] do
          if enemyCount < 8 then
            local chip1 = bagLow.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip1.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end
    end, 1)

  elseif cardName == "Cast Your Lot!" then
    -- need a checkDominantFaction() function, similar to checkWeather() was in BM
    local dominantFaction = checkDominantFaction()
    if dominantFaction == nil then log("deployClashEnemies() .. dominantFaction is nil") return end
    -- broadcast effect of dominant faction
    local factionEffect = {
      ["Empire"]        = "Empire Remnant - Adventurers cannot change battle forms (you still choose a battle form at the start of battle).",
      ["DC"]            = "Daggerfall Covenant - Enemies increase their Combat stat by 1.",
      ["EP"]            = "Ebonheart Pact - Enemies deploy with +2 HP.",
      ["AD"]            = "Aldmeri Dominion - Adventurers cannot roll more than 3 dice per engage.", 
    }
    broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder[-]: Current Dominant Faction is " .. factionEffect[dominantFaction], "White")
    
    -- deploy EP, add chips to table for potential HP adjustment later
    local toModifyHP = {}
    Wait.time(function()

      if chipBreakdown[20] > 0 then
        for i = 1, chipBreakdown[20] do
          if enemyCount < 8 then
            local chip20 = bagHigh.takeObject({rotation = { 0, 180, 0 }})

            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip20.setPositionSmooth(spacesEnemies[index], false, true) table.insert(toModifyHP, chip20) end)
          end
        end
      end

      if chipBreakdown[10] > 0 then
        for i = 1, chipBreakdown[10] do
          if enemyCount < 8 then
            local chip10 = bagHigh.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip10.setPositionSmooth(spacesEnemies[index], false, true) table.insert(toModifyHP, chip10) end)
          end
        end
      end

      if chipBreakdown[5] > 0 then
        for i = 1, chipBreakdown[5] do
          if enemyCount < 8 then
            local chip5 = bagLow.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip5.setPositionSmooth(spacesEnemies[index], false, true) table.insert(toModifyHP, chip5) end)
          end
        end
      end

      if chipBreakdown[1] > 0 then
        for i = 1, chipBreakdown[1] do
          if enemyCount < 8 then
            local chip1 = bagLow.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip1.setPositionSmooth(spacesEnemies[index], false, true) table.insert(toModifyHP, chip1) end)
          end
        end
      end
    end, 1)

    -- if pact dominant, add 2 HP to every enemy    
    if dominantFaction == "EP" then
      Wait.time(function()

        for _, chip in pairs(toModifyHP) do
          local oldVal = chip.getVar('val')
          local newVal = oldVal + 2
          local bagScript = getObjectbyName("Defeated Monsters Bag")
          bagScript.call('set_val_remote', {chipObj=chip, val=newVal})
        end

      end, 2)
    end

  elseif cardName == "Predictive Diplomacy" then
    -- add playerCount to calculated EP
    currentCalculatedEP = currentCalculatedEP + playerCount

    Wait.time(function()

      -- hexes that require arrow tokens
      local arrowHexes = { [1]=true, [4]=true, [6]=true, [8]=true }

      -- pull ONE base arrow token
      local tokenBag = getObjectbyName("Overland Token Bag")
      local baseArrowToken = nil
      for _, object in pairs(tokenBag.getObjects()) do
        if object.name == "Arrow Overland Token" then
          baseArrowToken = tokenBag.takeObject({ guid = object.guid })
          Wait.time(function() tokenBag.putObject(baseArrowToken) end, 2)
          break
        end
      end

      -- drop arrow token clone on chip if in correct hex
      local function handleArrowToken(chipObj, index)
      if not arrowHexes[index] or not baseArrowToken then return end

        Wait.time(function()

          local clone = baseArrowToken.clone({})          
          local posChip = chipObj.getPosition()
          posChip.y = 3.50
          posChip.z = posChip.z + 0.58

          -- place clone on chip
          Wait.frames(function()
            if clone then
              clone.setGMNotes("Cloned Token")
              clone.setRotation({ 0, 330, 0 })
              clone.setPosition({x=posChip.x, y=posChip.y, z=posChip.z})
            end
          end)

        end, 2)
      end

      -- deploy chip and handle arrow token
      local function deployChip(chipObj)
        enemyCount = enemyCount + 1
        local index = enemyCount
        Wait.frames(function()
          chipObj.setPositionSmooth(spacesEnemies[index], false, true)
          handleArrowToken(chipObj, index)
        end)
      end

      -- deploy 20-value chips
      if chipBreakdown[20] > 0 then
        for i = 1, chipBreakdown[20] do
          if enemyCount < 8 then
            deployChip(bagHigh.takeObject({ rotation = {0,180,0} }))
          end
        end
      end

      -- deploy 10-value chips
      if chipBreakdown[10] > 0 then
        for i = 1, chipBreakdown[10] do
          if enemyCount < 8 then
            deployChip(bagHigh.takeObject({ rotation = {0,180,180} }))
          end
        end
      end

      -- deploy 5-value chips
      if chipBreakdown[5] > 0 then
        for i = 1, chipBreakdown[5] do
          if enemyCount < 8 then
            deployChip(bagLow.takeObject({ rotation = {0,180,0} }))
          end
        end
      end

      -- deploy 1-value chips
      if chipBreakdown[1] > 0 then
        for i = 1, chipBreakdown[1] do
          if enemyCount < 8 then
            deployChip(bagLow.takeObject({ rotation = {0,180,180} }))
          end
        end
      end

      -- add extra level-1 if only one enemy deployed
      Wait.time(function()
        if enemyCount == 1 then
          deployChip(bagLow.takeObject({ rotation = {0,180,180} }))
        end

        -- return the base arrow token
        if baseArrowToken then
          baseArrowToken.putObject(tokenBag)
        end
      end, 2.2)

    end, 1)

    -- checkDominantFaction(), broadcast goal
    local dominantFaction = checkDominantFaction()
    if dominantFaction == nil then log("deployClashEnemies() .. dominantFaction is nil") return end
    -- broadcast effect of dominant faction
    local factionEffect = {
      ["Empire"]        = "Empire Remnant - Conquer. All enemies reduce their defense stat to 0.",
      ["DC"]            = "Daggerfall Covenant - Eliminate enemies without [Arrow] tokens.",
      ["EP"]            = "Ebonheart Pact - Conquer. All enemies reduce their defense stat to 0",
      ["AD"]            = "Aldmeri Dominion - Eliminate enemies with [Arrow] tokens.", 
    }
    broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder[-]: Current Dominant Faction is " .. factionEffect[dominantFaction], "White")

  elseif cardName == "Traders to the Cause" then
    local toModifyHP = {}
    -- deploy EP
    Wait.time(function()

      if chipBreakdown[20] > 0 then
        for i = 1, chipBreakdown[20] do
          if enemyCount < 8 then
            local chip20 = bagHigh.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip20.setPositionSmooth(spacesEnemies[index], false, true) table.insert(toModifyHP, chip20) end)
          end
        end
      end

      if chipBreakdown[10] > 0 then
        for i = 1, chipBreakdown[10] do
          if enemyCount < 8 then
            local chip10 = bagHigh.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip10.setPositionSmooth(spacesEnemies[index], false, true) table.insert(toModifyHP, chip10) end)
          end
        end
      end

      if chipBreakdown[5] > 0 then
        for i = 1, chipBreakdown[5] do
          if enemyCount < 8 then
            local chip5 = bagLow.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip5.setPositionSmooth(spacesEnemies[index], false, true) table.insert(toModifyHP, chip5) end)
          end
        end
      end

      if chipBreakdown[1] > 0 then
        for i = 1, chipBreakdown[1] do
          if enemyCount < 8 then
            local chip1 = bagLow.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip1.setPositionSmooth(spacesEnemies[index], false, true) table.insert(toModifyHP, chip1) end)
          end
        end
      end
    end, 1)

    -- OPTION 1
    -- simply broadcast effect
    if optionNumber == 1 then
      broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder[-]: Each time an adventurer defeats an enemy while overtaxing a [Weapon], they may move the battlefront token 1 space in any direction.", "White")

    -- OPTION 2
    elseif optionNumber == 2 then      
      -- checkIfUnstable(), enemies deploy with 1/2 additional HP
      local isUnstable = checkIfUnstable()
      local extraHP = checkIfUnstable() == true and 2 or 1
      Wait.time(function()

        for _, chip in pairs(toModifyHP) do
          local oldVal = chip.getVar('val')
          local newVal = oldVal + extraHP
          local bagScript = getObjectbyName("Defeated Monsters Bag")
          bagScript.call('set_val_remote', {chipObj=chip, val=newVal})
        end

      end, 2)
      -- broadcast effect
      broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder[-]: Enemies deploy with +" .. extraHP .. " HP. Each time an adventurer overtaxes a [Weapon] or [Armor], they gain 1 tenacity.", "White")
    end

  elseif cardName == "Anchors, Away!" then
    -- after deploying enemies, pull and place another calculatedEP's worth of enemies near mat, defaulting to daedra if possible
  
    -- first deploy EP
    Wait.time(function()

      if chipBreakdown[20] > 0 then
        for i = 1, chipBreakdown[20] do
          if enemyCount < 8 then
            local chip20 = bagHigh.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip20.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[10] > 0 then
        for i = 1, chipBreakdown[10] do
          if enemyCount < 8 then
            local chip10 = bagHigh.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip10.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[5] > 0 then
        for i = 1, chipBreakdown[5] do
          if enemyCount < 8 then
            local chip5 = bagLow.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip5.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[1] > 0 then
        for i = 1, chipBreakdown[1] do
          if enemyCount < 8 then
            local chip1 = bagLow.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip1.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end
    end, 1)

    -- second daedra preferring deploy EP (what, they don't know about second EP deploy?!)
    local posExtraEnemies = {
      { -11.28, 2.50, 14.84 },
      { -11.28, 2.50, 11.29 },
      { -11.28, 2.50, 7.74 },
      { -11.28, 2.50, 4.19 },
      { -11.28, 2.50, 0.64 },
      { -11.28, 2.50, -2.91 },
      { -11.28, 2.50, -6.46 },
      { -11.28, 2.50, -10.02 },
    }
    local secondEnemyCount = 0
    Wait.time(function()

      if chipBreakdown[20] > 0 then
        for i = 1, chipBreakdown[20] do
          if secondEnemyCount < 8 then
            secondEnemyCount = secondEnemyCount + 1
            local index = secondEnemyCount
            local chip20 = deployEnemyType(20, "Daedra", posExtraEnemies[index])
            if not chip20 then
              chip20 = bagHigh.takeObject({rotation = { 0, 180, 0 }})
            end            
            Wait.frames(function() chip20.setPositionSmooth(posExtraEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[10] > 0 then
        for i = 1, chipBreakdown[10] do
          if secondEnemyCount < 8 then
            secondEnemyCount = secondEnemyCount + 1
            local index = secondEnemyCount
            local chip10 = deployEnemyType(10, "Daedra", posExtraEnemies[index])
            if not chip10 then
              chip10 = bagHigh.takeObject({rotation = { 0, 180, 180 }})
            end            
            Wait.frames(function() chip10.setPositionSmooth(posExtraEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[5] > 0 then
        for i = 1, chipBreakdown[5] do
          if secondEnemyCount < 8 then
            secondEnemyCount = secondEnemyCount + 1
            local index = secondEnemyCount
            local chip5 = deployEnemyType(5, "Daedra", posExtraEnemies[index])
            if not chip5 then
              chip5 = bagLow.takeObject({rotation = { 0, 180, 0 }})
            end            
            Wait.frames(function() chip5.setPositionSmooth(posExtraEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[1] > 0 then
        for i = 1, chipBreakdown[1] do
          if secondEnemyCount < 8 then
            secondEnemyCount = secondEnemyCount + 1
            local index = secondEnemyCount
            local chip1 = deployEnemyType(1, "Daedra", posExtraEnemies[index])
            if not chip1 then
              chip1 = bagLow.takeObject({rotation = { 0, 180, 180 }})
            end            
            Wait.frames(function() chip1.setPositionSmooth(posExtraEnemies[index], false, true) end)
          end
        end
      end

    end, 2)

    -- pull generic counter, set to playerCount * 3, place to hex A (column1, row 2)
    Wait.time(function()

      local rotCounter = { 0, 180, 0 }
      local posCounter = {-8.20, 2.00, 2.41}
      local bagCounter = getObjectbyName("Generic Counter Bag")
      local darkAnchorCounter = bagCounter.takeObject()
      local counterVal = playerCount * 3
      Wait.frames(function()
        darkAnchorCounter.setRotation(rotCounter)
        darkAnchorCounter.setPosition(posCounter)
        darkAnchorCounter.call('set_val', counterVal)
      end)

    end, 2)


  -- HR ENCOUNTERS
  elseif cardName == "Supine and Supernal" then
    -- will leave it up to player to police option 1, but,
    -- if optionNumber 2, each adventurer gets a daze die, round counter starts at 2
    -- will need checkUnrest() function, if unrest >= tense, round counter starts at 3 insteas
    local currentRound = 1
    if optionNumber == 2 then

      -- somehow determine which adv mats are actually in use
      local seatedColors = {"Red", "Orange", "Blue", "Green"}
      local actuallySeatedColors = {}
      for i = 1, 4 do
        local matExists = false
        local buttonExists = false
        for _, object in pairs(getObjects()) do

          -- detect if player mat exists
          if object.getName() == seatedColors[i] .. " Adventurer Mat" then
            matExists = true
            break
          end
        end

        -- if mat exists, check for button (should not be there if actually seated)
        if matExists then
          for _, obj in pairs(getObjects()) do
            if obj.getName() == "Button Clear Playerarea" and obj.getGMNotes() == seatedColors[i] then
              buttonExists = true
              break
            end
          end
        end

        -- handle daze die
        if matExists and not buttonExists then        
          local bagStatusDice = getObjectbyName("Status Effect Dice Bag")
          if #bagStatusDice.getObjects() < 1 then
            broadcastToAll("Unable to take a Status Die - Supply is empty!", "Orange")
            return
          else
            local statusEffectDie = bagStatusDice.takeObject()
            
            Wait.frames(function()
              statusEffectDie.setRotation({ 0, 0, 270 })
              statusEffectDie.setDescription("Daze:\nThis unit cannot roll dice on the same turn it moves, and it cannot move on the same turn it rolls dice. At the end of this unit's turn, remove this die.")
              placeDieToTrack(seatedColors[i], statusEffectDie, "Cooldown")            
            end)
          end        
        end
      end

      -- handle round counter stuff
      local currentUnrest, unrestString = checkUnrest()
      if currentUnrest == nil then log("deployClashEnemies(): currentUnrest not found") return end
      if unrestString == nil then log("deployClashEnemies(): unrestString not found") return end

      if currentUnrest > 2 then
        currentRound = 3
      else
        currentRound = 2
      end

      -- if required, set round counter to new round
      local rotDie = { { 270, 0, 0 }, { 0, 0, 0 }, { 0, 0, 270 }, { 0, 0, 90 }, { 0, 0, 180 }, { 90, 0, 0 } }
      local die = getObjectbyName("Round Counter")
      die.setRotationSmooth(rotDie[currentRound], false, false)
      local roundCounter = getObjectbyName("Battle Round Counter")
      roundCounter.call('set_val', currentRound)

      -- broadcast round change reminder
      if currentRound ~= 1 then
        broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder[-]: Due to encounter effect, the battle round counter has been set to " .. currentRound .. ".", "White")
      end
    end

    -- deploy EP
    Wait.time(function()

      if chipBreakdown[20] > 0 then
        for i = 1, chipBreakdown[20] do
          if enemyCount < 8 then
            local chip20 = bagHigh.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip20.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[10] > 0 then
        for i = 1, chipBreakdown[10] do
          if enemyCount < 8 then
            local chip10 = bagHigh.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip10.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[5] > 0 then
        for i = 1, chipBreakdown[5] do
          if enemyCount < 8 then
            local chip5 = bagLow.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip5.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[1] > 0 then
        for i = 1, chipBreakdown[1] do
          if enemyCount < 8 then
            local chip1 = bagLow.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip1.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end
    end, 1)


  elseif cardName == "Border Battle" then
    -- checkUnrest()
    local currentUnrest, unrestString = checkUnrest()    
    -- OPTION 1
    if optionNumber == 1 then
      -- add current unrest value to the calculatedEP
      currentCalculatedEP = currentCalculatedEP + currentUnrest
      chipBreakdown = getChipBreakdown(currentCalculatedEP)
      -- checkIfUnstable, broadcast reminder to gain 3 tenacity
      local isUnstable = checkIfUnstable()
      if not isUnstable then
        broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder[-]: Party token in unstable location, each adventurer gains 3 tenacity.", "White")
      end    
    
    -- OPTION 2
    elseif optionNumber == 2 then
      -- increase unrest by 1
      moveUnrest(1)
    end

    -- deploy EP
    Wait.time(function()

      if chipBreakdown[20] > 0 then
        for i = 1, chipBreakdown[20] do
          if enemyCount < 8 then
            local chip20 = bagHigh.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip20.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[10] > 0 then
        for i = 1, chipBreakdown[10] do
          if enemyCount < 8 then
            local chip10 = bagHigh.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip10.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[5] > 0 then
        for i = 1, chipBreakdown[5] do
          if enemyCount < 8 then
            local chip5 = bagLow.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip5.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[1] > 0 then
        for i = 1, chipBreakdown[1] do
          if enemyCount < 8 then
            local chip1 = bagLow.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip1.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end
    end, 1)


  elseif cardName == "Pit Stop" then
    -- no special action required here, requires nonstandard actions in deployClash()

    -- deploy EP
    Wait.time(function()

      if chipBreakdown[20] > 0 then
        for i = 1, chipBreakdown[20] do
          if enemyCount < 8 then
            local chip20 = bagHigh.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip20.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[10] > 0 then
        for i = 1, chipBreakdown[10] do
          if enemyCount < 8 then
            local chip10 = bagHigh.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip10.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[5] > 0 then
        for i = 1, chipBreakdown[5] do
          if enemyCount < 8 then
            local chip5 = bagLow.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip5.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[1] > 0 then
        for i = 1, chipBreakdown[1] do
          if enemyCount < 8 then
            local chip1 = bagLow.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip1.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end
    end, 1)

  elseif cardName == "Rooks to the Left, Midnight to the Right" then
    -- use as many humanoid enemies as possible while deploying
    Wait.time(function()

      -- hexes that require arrow tokens
      local arrowHexes = { [1]=true, [4]=true, [5]=true, [7]=true }

      -- pull ONE base arrow token
      local tokenBag = getObjectbyName("Overland Token Bag")
      local baseArrowToken = nil
      for _, object in pairs(tokenBag.getObjects()) do
        if object.name == "Arrow Overland Token" then
          baseArrowToken = tokenBag.takeObject({ guid = object.guid })
          break
        end
      end

      -- drop arrow token clone on chip if in correct hex
      local function handleArrowToken(chipObj, index)
        if not arrowHexes[index] or not baseArrowToken then return end

        Wait.time(function()

          local clone = baseArrowToken.clone({})          
          local posChip = chipObj.getPosition()
          posChip.y = 3.50
          posChip.z = posChip.z + 0.58

          -- place clone on chip
          Wait.frames(function()
            if clone then
              clone.setGMNotes("Cloned Token")
              clone.setRotation({ 0, 330, 0 })
              clone.setPosition({x=posChip.x, y=posChip.y, z=posChip.z})
            end
          end)

        end, 2)
      end

      -- deploy chip and handle arrow token
      local function deployChip(chipObj)
        enemyCount = enemyCount + 1
        local index = enemyCount
        Wait.frames(function()
          chipObj.setPositionSmooth(spacesEnemies[index], false, true)
          handleArrowToken(chipObj, index)
        end)
      end

      -- 20 EP chips
      if chipBreakdown[20] > 0 then
        for i = 1, chipBreakdown[20] do
          if enemyCount < 8 then
            local chip20 = deployEnemyType(20, "Human", spacesEnemies[enemyCount + 1])
            if chip20 == nil then
              chip20 = bagLow.takeObject({rotation = { 0, 180, 0 }})
            end
            deployChip(chip20)
          end
        end
      end

      -- 10 EP chips
      if chipBreakdown[10] > 0 then
        for i = 1, chipBreakdown[10] do
          if enemyCount < 8 then
            local chip10 = deployEnemyType(10, "Human", spacesEnemies[enemyCount + 1])
            if chip10 == nil then
              chip10 = bagLow.takeObject({rotation = { 0, 180, 180 }})
            end
            deployChip(chip10)
          end
        end
      end

      -- 5 EP chips
      if chipBreakdown[5] > 0 then
        for i = 1, chipBreakdown[5] do
          if enemyCount < 8 then
            local chip5 = deployEnemyType(5, "Human", spacesEnemies[enemyCount + 1])
            if chip5 == nil then
              chip5 = bagLow.takeObject({rotation = { 0, 180, 0 }})
            end
            deployChip(chip5)
          end          
        end
      end

      -- 1 EP chips
      if chipBreakdown[1] > 0 then
        for i = 1, chipBreakdown[1] do
          if enemyCount < 8 then
            local chip1 = deployEnemyType(1, "Human", spacesEnemies[enemyCount + 1])
            if chip1 == nil then
              chip1 = bagLow.takeObject({rotation = { 0, 180, 180}})
            end
            deployChip(chip1)
          end          
        end
      end

      -- after deploying, deploy an additional level 1 enemy to each remaining unoccupied numbered hex
      local lvl1DeployCount = 8 - enemyCount

      Wait.time(function()
        for i = 1, lvl1DeployCount do
          if enemyCount < 8 then
            local chip1 = deployEnemyType(1, "Human", spacesEnemies[enemyCount + 1])
            if chip1 == nil then
              chip1 = bagLow.takeObject({rotation = {0,180,180}})
            end

            -- wait a frame before deploying, so the chip exists in the world
            Wait.frames(function()
              deployChip(chip1)
            end)
          end
        end

        -- return the base arrow token
        if baseArrowToken then
          Wait.time(function()
            tokenBag.putObject(baseArrowToken)
          end, 2)
        end

      end, 1.5)

    end, 1)
    
    -- if 3+ players, broadcast reminder to flip playerCount level 1 enemies to level 5
    if playerCount > 2 then
      broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder 3+ Players[-]: The party will need to flip up to " .. playerCount ..  " level 1 enemies to their level 5 sides.", "White")        
    end

  elseif cardName == "No Unrest for the Wicked" then
    local currentUnrest, unrestString = checkUnrest()
    -- OPTION 1
    -- first checkIfUnstable(), add unrest by 2 if so before adding HP
    -- checkUnrest(), determine +HP amount
    if optionNumber == 1 then
      local isUnstable = checkIfUnstable()
      if isUnstable then
        broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder [-]: Party token is currently on unstable space - Unreast increases by 2 via encounter effect.", "White")
        moveUnrest(2)
      end      

    -- OPTION 2
    -- simply increase unrest by 2, then normal deploy
    elseif optionNumber == 2 then
      broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder [-]: Unreast increases by 2 via encounter effect. You cannot retreat from this battle.", "White")
      moveUnrest(2)
    end

    -- deploy EP
    local toModifyHP = {}
    Wait.time(function()

      if chipBreakdown[20] > 0 then
        for i = 1, chipBreakdown[20] do
          if enemyCount < 8 then
            local chip20 = bagHigh.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip20.setPositionSmooth(spacesEnemies[index], false, true) table.insert(toModifyHP, chip20) end)
          end
        end
      end

      if chipBreakdown[10] > 0 then
        for i = 1, chipBreakdown[10] do
          if enemyCount < 8 then
            local chip10 = bagHigh.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip10.setPositionSmooth(spacesEnemies[index], false, true) table.insert(toModifyHP, chip10) end)
          end
        end
      end

      if chipBreakdown[5] > 0 then
        for i = 1, chipBreakdown[5] do
          if enemyCount < 8 then
            local chip5 = bagLow.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip5.setPositionSmooth(spacesEnemies[index], false, true) table.insert(toModifyHP, chip5) end)
          end
        end
      end

      if chipBreakdown[1] > 0 then
        for i = 1, chipBreakdown[1] do
          if enemyCount < 8 then
            local chip1 = bagLow.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip1.setPositionSmooth(spacesEnemies[index], false, true) table.insert(toModifyHP, chip1) end)
          end
        end
      end
    end, 1)

    if optionNumber == 1 then
      Wait.time(function()

        currentUnrest, unrestString = checkUnrest()
        local hpModifyValue = {
          ["Peaceful"]      = 1,
          ["Tense"]         = 2,
          ["Dangerous"]     = 3,
          ["Chaotic"]       = 5
        }
        for _, chip in pairs(toModifyHP) do
          local oldVal = chip.getVar('val')
          local newVal = oldVal + hpModifyValue[unrestString]
          local bagScript = getObjectbyName("Defeated Monsters Bag")
          bagScript.call('set_val_remote', {chipObj=chip, val=newVal})
        end

      end, 2)
    end

  elseif cardName == "Rumormonger" then
    -- OPTION 1
    -- checkUnrest(), determine HP modify amount
    local currentUnrest, unrestString = checkUnrest()  
    local hpModify = 0
    if optionNumber == 1 then
      local hpUnrestModify  = {
        ["Peaceful"]  = 0,
        ["Tense"]     = -1,
        ["Dangerous"] = -2,
        ["Chaotic"]   = -3
      }
      hpModify = hpUnrestModify[unrestString]
      -- broadcast reminder about not being able to retreat, and how much HP is being modified by
      broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder[-]: Unrest level is currently " .. unrestString .. ", HP will be modified by " .. hpModify .. ".", "White")

    -- OPTION 2
    -- broadcast reminder about reducing unrest by 2 if successful
    elseif optionNumber == 2 then
      broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder[-]: If this clash is successful, reduce unrest by 2.", "White")
    end

    -- deploy EP
    local toModifyHP = {}
    Wait.time(function()

      if chipBreakdown[20] > 0 then
        for i = 1, chipBreakdown[20] do
          if enemyCount < 8 then
            local chip20 = bagHigh.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip20.setPositionSmooth(spacesEnemies[index], false, true) table.insert(toModifyHP, chip20) end)
          end
        end
      end

      if chipBreakdown[10] > 0 then
        for i = 1, chipBreakdown[10] do
          if enemyCount < 8 then
            local chip10 = bagHigh.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip10.setPositionSmooth(spacesEnemies[index], false, true) table.insert(toModifyHP, chip10) end)
          end
        end
      end

      if chipBreakdown[5] > 0 then
        for i = 1, chipBreakdown[5] do
          if enemyCount < 8 then
            local chip5 = bagLow.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip5.setPositionSmooth(spacesEnemies[index], false, true) table.insert(toModifyHP, chip5) end)
          end
        end
      end

      if chipBreakdown[1] > 0 then
        for i = 1, chipBreakdown[1] do
          if enemyCount < 8 then
            local chip1 = bagLow.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip1.setPositionSmooth(spacesEnemies[index], false, true) table.insert(toModifyHP, chip1) end)
          end
        end
      end
    end, 1)

    Wait.time(function()
      for _, chip in pairs(toModifyHP) do
        local oldVal = chip.getVar('val')
        local newVal = oldVal + hpModify
        if newVal < 1 then newVal = 1 end
        local bagScript = getObjectbyName("Defeated Monsters Bag")
        bagScript.call('set_val_remote', {chipObj=chip, val=newVal})
      end

    end, 2)
    

  -- MW ENCOUNTERS
  elseif cardName == "Wrong Side of the Law" then
    -- check if unstable, broadcast reminder to choose adventurer to be prisoner (include lockpick check)
    local lockpickString = checkIfUnstable() == false and "5-4-3" or "6-4-1"
    broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder[-]: Choose an adventurer to be the prisoner for this clash. On their turn, they must make a (" .. lockpickString .. ") (2 attempts) lockpick check to avoid being captive.", "White")

    -- deploy EP
    local toModifyHP = {}
    Wait.time(function()

      if chipBreakdown[20] > 0 then
        for i = 1, chipBreakdown[20] do
          if enemyCount < 8 then
            local chip20 = bagHigh.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip20.setPositionSmooth(spacesEnemies[index], false, true) table.insert(toModifyHP, chip20) end)
          end
        end
      end

      if chipBreakdown[10] > 0 then
        for i = 1, chipBreakdown[10] do
          if enemyCount < 8 then
            local chip10 = bagHigh.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip10.setPositionSmooth(spacesEnemies[index], false, true) table.insert(toModifyHP, chip10) end)
          end
        end
      end

      if chipBreakdown[5] > 0 then
        for i = 1, chipBreakdown[5] do
          if enemyCount < 8 then
            local chip5 = bagLow.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip5.setPositionSmooth(spacesEnemies[index], false, true) table.insert(toModifyHP, chip5) end)
          end
        end
      end

      if chipBreakdown[1] > 0 then
        for i = 1, chipBreakdown[1] do
          if enemyCount < 8 then
            local chip1 = bagLow.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip1.setPositionSmooth(spacesEnemies[index], false, true) table.insert(toModifyHP, chip1) end)
          end
        end
      end
    end, 1)

    -- check if occupying anchre egg mine, if so enemies get +2 HP, broadcast reminder
    local isAnchre = checkIfAnchre()
    if isAnchre then
      Wait.time(function()

        -- broadcast
        broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder[-]: Party token is occupying Anchre Egg Mine - All enemies gain +2 HP via encounter effect.", "White")

        -- add HP
        for _, chip in pairs(toModifyHP) do
          local oldVal = chip.getVar('val')
          local newVal = oldVal + 2
          local bagScript = getObjectbyName("Defeated Monsters Bag")
          bagScript.call('set_val_remote', {chipObj=chip, val=newVal})
        end

      end, 2)
      
    end

  elseif cardName == "Not Mushroom to Move" then
    -- requires obstacle placed (in deployClash)
    -- add level 5 orc marauder (lvl 10 orc wizard if 3+ players) to ep, deploy first
    -- before deploying EP, add khajiit marauder (<3) or khajiit cultist to enemy pool and deploy
    local extraEnemy = playerCount < 3 and "Orc Marauder" or "Orc Wizard"
    local extraBag = playerCount < 3 and bagLow or bagHigh
    local extraRot = extraEnemy == "Orc Marauder" and { 0, 180, 0 } or { 0, 180, 180 }
    for _, object in pairs(extraBag.getObjects()) do
      if object.name:find(extraEnemy) then
        local chipExtraEnemy = extraBag.takeObject({guid = object.guid, rotation = extraRot})
        enemyCount = 1
        Wait.frames(function()
          -- chipExtraEnemy.setVar('fresh_out_of_bag')
          chipExtraEnemy.setPositionSmooth(spacesEnemies[enemyCount], false, true)
        end)
        break
      end
    end
    -- deploy rest of EP
    Wait.time(function()

      if chipBreakdown[20] > 0 then
        for i = 1, chipBreakdown[20] do
          if enemyCount < 8 then
            local chip20 = bagHigh.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip20.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[10] > 0 then
        for i = 1, chipBreakdown[10] do
          if enemyCount < 8 then
            local chip10 = bagHigh.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip10.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[5] > 0 then
        for i = 1, chipBreakdown[5] do
          if enemyCount < 8 then
            local chip5 = bagLow.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip5.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[1] > 0 then
        for i = 1, chipBreakdown[1] do
          if enemyCount < 8 then
            local chip1 = bagLow.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip1.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end
    end, 1)

    -- checkIfUnstable, if so broadcast reminder that enemies go before adventurers each round
    if checkIfUnstable() then
      broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder[-]: Party token is on unstable space, enemies go before adventurers each round.", "White")
    end

  elseif cardName == "Egg Mine? No, Eggs Mine!" then

    -- deploy EP
    Wait.time(function()

      if chipBreakdown[20] > 0 then
        for i = 1, chipBreakdown[20] do
          if enemyCount < 8 then
            local chip20 = bagHigh.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip20.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[10] > 0 then
        for i = 1, chipBreakdown[10] do
          if enemyCount < 8 then
            local chip10 = bagHigh.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip10.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[5] > 0 then
        for i = 1, chipBreakdown[5] do
          if enemyCount < 8 then
            local chip5 = bagLow.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip5.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[1] > 0 then
        for i = 1, chipBreakdown[1] do
          if enemyCount < 8 then
            local chip1 = bagLow.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip1.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end
    end, 1)

    -- pull generic counters, place just offset above the cache chips, set to 6-playerCount, set description or gmnotes
    Wait.time(function()

      local cacheChips = {}    
      local checkZone = getObjectFromGUID("b5dd6d")
      local bagCounter = getObjectbyName("Generic Counter Bag")
      local counterVal = 6 - playerCount
      for _, object in pairs(checkZone.getObjects()) do
        if object.getName() == "Cache Chip" then        
          table.insert(cacheChips, object)
        end
      end
      for i = 1, #cacheChips do
        local posCounter = cacheChips[i].getPosition()
        posCounter.y = 2.50
        local counter = bagCounter.takeObject()
        Wait.frames(function()
          counter.setPosition(posCounter)
          counter.call('set_val', counterVal)
          counter.setGMNotes("Egg Counter")
        end)
      end

    end, 2)

    -- ifUnstable, on round end, do check for description or gmnotes added, remove HP value by 1, broadcast
    -- (currently that script lives on battle round counter object)
    -- check if occupying Anchre Egg Mine, broadcast about reward as bonus XP
    local isAnchre = checkIfAnchre()
    if isAnchre then
      broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder[-]: Party token is occupying Anchre Egg Mine - Treat 1 XP of the encounter reward as bonus HP.", "White")
    end

  elseif cardName == "Deals in Dwemer" then
    -- deploy EP
    Wait.time(function()

      if chipBreakdown[20] > 0 then
        for i = 1, chipBreakdown[20] do
          if enemyCount < 8 then
            local chip20 = bagHigh.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip20.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[10] > 0 then
        for i = 1, chipBreakdown[10] do
          if enemyCount < 8 then
            local chip10 = bagHigh.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip10.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[5] > 0 then
        for i = 1, chipBreakdown[5] do
          if enemyCount < 8 then
            local chip5 = bagLow.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip5.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[1] > 0 then
        for i = 1, chipBreakdown[1] do
          if enemyCount < 8 then
            local chip1 = bagLow.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip1.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end
    end, 1)

    -- OPTION 1
    if optionNumber == 1 then
      -- set round counter to playerCount
      local rotDie = { { 270, 0, 0 }, { 0, 0, 0 }, { 0, 0, 270 }, { 0, 0, 90 }, { 0, 0, 180 }, { 90, 0, 0 } }
      local die = getObjectbyName("Round Counter")
      die.setRotationSmooth(rotDie[playerCount], false, false)
      local roundCounter = getObjectbyName("Battle Round Counter")
      roundCounter.call('set_val', playerCount)

      -- add playerCount level 1 enemies to the EP and deploy them last
      local lvl1DeployCount = playerCount
      Wait.time(function()

        for i = 1, lvl1DeployCount do
          if enemyCount < 8 then
            enemyCount = enemyCount + 1
            local index = enemyCount

            local chip1 = bagLow.takeObject({rotation = {0,180,180}})
            Wait.frames(function()
              chip1.setPositionSmooth(spacesEnemies[index], false, true)
            end)
          end
        end

      end, 1.5)

      -- broadcast reminder about enemies going before adventurers each round, and cannot retreat
      broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder[-]: Enemies go before adventurers each round, and the party cannot retreat from this battle.", "White")
    end
    -- OPTION 2
    -- will need to add check in deployClash() before placing caches    

  elseif cardName == "Augmented Arms" then
    -- place playerCount + 2 caches next to clash mat, broadcast reminder to manually place
    local cacheCount = playerCount + 2
    broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder[-]: Manually place " .. cacheCount .. "X caches.", "White")
    
    -- checkIfUnstable, if so do legendary caches, happens in deployClash()
    -- if not occupying tormented spire, broadcast reminder about discarding item
    local partyToken = getObjectbyName("Party Overland Token")
    if partyToken == nil then log("deployClashEnemies(): Augmented Arms partyToken not found") return false end

    local posSpire = { -50.72, 1.69, 5.54 }
    local tolerance = 0.50
    local posToken = partyToken.getPosition()
    if math.abs(posToken.x - posSpire[1]) <= tolerance
    and math.abs(posToken.z - posSpire[3]) <= tolerance then      
      broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder[-]: Party token is on Tormented Spire - Items from caches are not discarded.", "White")
    else
      broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder[-]: Party token is not on Tormented Spire - Items from caches must be discarded.", "White")
    end

    -- clear battle button scripting checks to see if card is in slot, auto advance the dig track and broadcast if so

    -- deploy EP
    Wait.time(function()

      if chipBreakdown[20] > 0 then
        for i = 1, chipBreakdown[20] do
          if enemyCount < 8 then
            local chip20 = bagHigh.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip20.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[10] > 0 then
        for i = 1, chipBreakdown[10] do
          if enemyCount < 8 then
            local chip10 = bagHigh.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip10.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[5] > 0 then
        for i = 1, chipBreakdown[5] do
          if enemyCount < 8 then
            local chip5 = bagLow.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip5.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[1] > 0 then
        for i = 1, chipBreakdown[1] do
          if enemyCount < 8 then
            local chip1 = bagLow.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip1.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end
    end, 1)    

  elseif cardName == "Yours for the Taking" then
    -- will require a nonstandard clash map, in deployClash()
    -- 3+ players set round counter to playerCount, broadcast
    if playerCount > 2 then
      local rotDie = { { 270, 0, 0 }, { 0, 0, 0 }, { 0, 0, 270 }, { 0, 0, 90 }, { 0, 0, 180 }, { 90, 0, 0 } }
      local die = getObjectbyName("Round Counter")
      die.setRotationSmooth(rotDie[playerCount], false, false)
      local roundCounter = getObjectbyName("Battle Round Counter")
      roundCounter.call('set_val', playerCount)
    end
    broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder[-]: This encounter is failed if the cache remains at the end of the battle.", "White")
    Wait.time(function() broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder 3+ Players[-]: Round counter set to " .. playerCount .. ".", "White") end, .50)

    -- ifUnstable, add current dig and excavation values to currentEP before deploy, broadcast
    local isUnstable = checkIfUnstable()
    if isUnstable then
      Wait.time(function() broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "] Party token is on unstable space - adding current dig and excavation values to calculated EP.", "White") end, 1)
    end
    local currentDig = checkDig()
    local currentExc = checkExcavation()
    currentCalculatedEP = currentCalculatedEP + currentDig + currentExc
    chipBreakdown = getChipBreakdown(currentCalculatedEP)

    -- deploy EP
    Wait.time(function()

      if chipBreakdown[20] > 0 then
        for i = 1, chipBreakdown[20] do
          if enemyCount < 8 then
            local chip20 = bagHigh.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip20.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[10] > 0 then
        for i = 1, chipBreakdown[10] do
          if enemyCount < 8 then
            local chip10 = bagHigh.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip10.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[5] > 0 then
        for i = 1, chipBreakdown[5] do
          if enemyCount < 8 then
            local chip5 = bagLow.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip5.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[1] > 0 then
        for i = 1, chipBreakdown[1] do
          if enemyCount < 8 then
            local chip1 = bagLow.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip1.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end
    end, 1)

  -- SK ENCOUNTERS
  elseif cardName == "Cold Discomfort" then    
    -- set round counter to playerCount + 1
    local rotDie = { { 270, 0, 0 }, { 0, 0, 0 }, { 0, 0, 270 }, { 0, 0, 90 }, { 0, 0, 180 }, { 90, 0, 0 } }
    local die = getObjectbyName("Round Counter")
    die.setRotationSmooth(rotDie[playerCount+1], false, false)
    local roundCounter = getObjectbyName("Battle Round Counter")
    roundCounter.call('set_val', playerCount+1)

    -- broadcast reminder about not being able to reteat from this battle
    broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder[-]: You cannot retreat from this battle.", "White")

    -- deploy EP
    Wait.time(function()

      if chipBreakdown[20] > 0 then
        for i = 1, chipBreakdown[20] do
          if enemyCount < 8 then
            local chip20 = bagHigh.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip20.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[10] > 0 then
        for i = 1, chipBreakdown[10] do
          if enemyCount < 8 then
            local chip10 = bagHigh.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip10.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[5] > 0 then
        for i = 1, chipBreakdown[5] do
          if enemyCount < 8 then
            local chip5 = bagLow.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip5.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[1] > 0 then
        for i = 1, chipBreakdown[1] do
          if enemyCount < 8 then
            local chip1 = bagLow.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip1.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end
    end, 1)

  elseif cardName == "A Storm of Fists" then
    -- add lvl 10 nord swordmaster to EP, deploy first   
    -- 3+ players = lvl 20 nord pyromancer instead
    local extraEnemy = playerCount < 3 and "Nord Swordmaster" or "Nord Pyromancer"
    local extraBag = bagHigh
    local extraRot = extraEnemy == "Nord Swordmaster" and { 0, 180, 180 } or { 0, 180, 0 }
    for _, object in pairs(extraBag.getObjects()) do
      if object.name:find(extraEnemy) then
        local chipExtraEnemy = extraBag.takeObject({guid = object.guid, rotation = extraRot})
        enemyCount = 1
        Wait.frames(function()
          -- chipExtraEnemy.setVar('fresh_out_of_bag')
          chipExtraEnemy.setPositionSmooth(spacesEnemies[enemyCount], false, true)
        end)
        break
      end
    end

    Wait.time(function()

      if chipBreakdown[20] > 0 then
        for i = 1, chipBreakdown[20] do
          if enemyCount < 8 then
            local chip20 = bagHigh.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip20.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[10] > 0 then
        for i = 1, chipBreakdown[10] do
          if enemyCount < 8 then
            local chip10 = bagHigh.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip10.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[5] > 0 then
        for i = 1, chipBreakdown[5] do
          if enemyCount < 8 then
            local chip5 = bagLow.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip5.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[1] > 0 then
        for i = 1, chipBreakdown[1] do
          if enemyCount < 8 then
            local chip1 = bagLow.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip1.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end
    end, 1)

    -- broadcast reminder about nord XXX doing damage, and the session 1 thing
    broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder[-]: When " .. extraEnemy .. " causes an adventurer to take damage, the adventurer must discard a [Weapon] from either their ready slots or their pack, if possible.", "White")
    broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder[-]: If it is currently Session 1, reduce the " .. extraEnemy .. "'s defense stat by 1.", "White")

  elseif cardName == "Mudcrab Crossing" then
    -- deploy lvl 1 mudcrab with +1 HP to hex A, make party companion counter on it
    local rotMudcrab = { 0, 180, 180 }
    local posMudcrab = { -8.09, 2.50, 2.47 }
    local chipMudcrab = nil
    for _, object in pairs(bagLow.getObjects()) do
      if object.name:find("Mudcrab") then
        chipMudcrab = bagLow.takeObject({guid=object.guid, rotation=rotMudcrab})
        Wait.frames(function()
          chipMudcrab.setPosition(posMudcrab)
        end)
      end
    end
    Wait.time(function()
    
      local oldVal = chipMudcrab.getVar('val')
      local newVal = oldVal + 1
      local bagScript = getObjectbyName("Defeated Monsters Bag")
      bagScript.call('set_val_remote', {chipObj=chipMudcrab, val=newVal})

      -- mark mudcrab as party companion
      Wait.time(function()

        bagScript.call('mark_party_companion', chipMudcrab)

      end, .50)
    end, 1)

    Wait.time(function()

      if chipBreakdown[20] > 0 then
        for i = 1, chipBreakdown[20] do
          if enemyCount < 8 then
            local chip20 = bagHigh.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip20.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[10] > 0 then
        for i = 1, chipBreakdown[10] do
          if enemyCount < 8 then
            local chip10 = bagHigh.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip10.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[5] > 0 then
        for i = 1, chipBreakdown[5] do
          if enemyCount < 8 then
            local chip5 = bagLow.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip5.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[1] > 0 then
        for i = 1, chipBreakdown[1] do
          if enemyCount < 8 then
            local chip1 = bagLow.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip1.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end
    end, 1)
    
    -- broadcast reminder to check encounter card for targeting rules changes
    broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder[-]: Check encounter card for updated enemy targeting effects and other encounter specific rules.", "White")

  elseif cardName == "Compass of Cruelty" then
    -- fuck me. will need check of which province map is in play, eastern or western
    -- determine whether current province map is Eastern or Western Skyrim
    local zone = getObjectFromGUID("64c0a4")
    local skyrimProvince = nil    
    for _, obj in ipairs(zone.getObjects()) do
      local name = obj.getName()
      skyrimProvince = (name == "Western Skyrim Overland Map" and "Western") or (name == "Eastern Skyrim Overland Map" and "Eastern")
    end
    if skyrimProvince == nil then log("deployClashEnemies() Compass of Cruelty: Unable to determine skyrim province.", "Orange") return end
    
    -- will need check on enemy deployments, make changes (skills to chips) or broadcast reminder (increasing combat)
    -- 3+ players all enemies get the extra skill, otherwise only humanoids
    local extraTTip = skyrimProvince == "Eastern" and "\n\nSwift:\nThis units movement is equal to the current round (Fatigue Rounds = 6)." or
                      skyrimProvince == "Western" and "\n\nChilblain:\nAfter this unit is engaged by an adventurer who is not using a weapon item that adventurer gains light fatigue equal to player count."
    local is3Plus = playerCount > 2 and true or false

    Wait.time(function()

      if chipBreakdown[20] > 0 then
        for i = 1, chipBreakdown[20] do
          if enemyCount < 8 then
            local chip20 = bagHigh.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip20.setPositionSmooth(spacesEnemies[index], false, true) end)
            Wait.time(function()
              
              local tags = chip20.getTags()
              local hasEnemyHuman = false
              for _, t in ipairs(tags) do
                if t:match("_enemyHuman$") or t == "enemyHuman" then
                  hasEnemyHuman = true
                  break
                end
              end
              local desc = chip20.getDescription()
              if (not is3Plus and hasEnemyHuman) or is3Plus then
                chip20.setDescription(desc .. extraTTip)
              end

            end, 1)
          end
        end
      end

      if chipBreakdown[10] > 0 then
        for i = 1, chipBreakdown[10] do
          if enemyCount < 8 then
            local chip10 = bagHigh.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip10.setPositionSmooth(spacesEnemies[index], false, true) end)
            Wait.time(function()
              
              local tags = chip10.getTags()
              local hasEnemyHuman = false
              for _, t in ipairs(tags) do
                if t:match("^enemyHuman_") or t == "enemyHuman" then
                  hasEnemyHuman = true
                  break
                end
              end
              local desc = chip10.getDescription()
              if (not is3Plus and hasEnemyHuman) or is3Plus then
                chip10.setDescription(desc .. extraTTip)
              end
              
            end, 1)
          end
        end
      end

      if chipBreakdown[5] > 0 then
        for i = 1, chipBreakdown[5] do
          if enemyCount < 8 then
            local chip5 = bagLow.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip5.setPositionSmooth(spacesEnemies[index], false, true) end)
            Wait.time(function()
              
              local tags = chip5.getTags()
              local hasEnemyHuman = false
              for _, t in ipairs(tags) do
                if t:match("_enemyHuman$") or t == "enemyHuman" then
                  hasEnemyHuman = true
                  break
                end
              end
              local desc = chip5.getDescription()
              if (not is3Plus and hasEnemyHuman) or is3Plus then
                chip5.setDescription(desc .. extraTTip)
              end
              
            end, 1)
          end
        end
      end

      if chipBreakdown[1] > 0 then
        for i = 1, chipBreakdown[1] do
          if enemyCount < 8 then
            local chip1 = bagLow.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip1.setPositionSmooth(spacesEnemies[index], false, true) end)
            Wait.time(function()
              
              local tags = chip1.getTags()
              local hasEnemyHuman = false
              for _, t in ipairs(tags) do
                if t:match("^enemyHuman") or t == "enemyHuman" then
                  hasEnemyHuman = true
                  break
                end
              end
              local desc = chip1.getDescription()
              if (not is3Plus and hasEnemyHuman) or is3Plus then
                chip1.setDescription(desc .. extraTTip)
              end
              
            end, 1)
          end
        end
      end
    end, 1)

    -- broadcast reminder
    if is3Plus and skyrimProvince == "Eastern" then
      broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder[-]: All non quest enemies gain quest unit skill: Swift. All Argonian, Nord, and Dark Elf enemies increase their combat stat by 1.", "White")
    elseif not is3Plus and skyrimProvince == "Eastern" then
      broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder[-]: All [Humanoid] enemies gain quest unit skill: Swift. All Argonian, Nord, and Dark Elf enemies increase their combat stat by 1.", "White")
    elseif is3Plus and skyrimProvince == "Western" then
      broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder[-]: All non quest enemies gain quest unit skill: Chilblain.", "White")
    elseif not is3Plus and skyrimProvince == "Western" then
      broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder[-]: All [Humanoid] enemies gain quest unit skill: Chilblain.", "White")
    end

  elseif cardName == "Maniacal Monolith" then
    -- pull generic counter to hex A, set to playerCount * 5
    local rotCounter = { 0, 180, 0 }
    local posCounter = { 10.25, 2.00, 2.41 }
    local bagCounter = getObjectbyName("Generic Counter Bag")
    local monolithCounter = bagCounter.takeObject()
    Wait.frames(function()
      monolithCounter.setRotation(rotCounter)
      monolithCounter.setPosition(posCounter)
      monolithCounter.call('set_val', playerCount * 5)
    end)
    -- checkIfUnstable, if so broadcast reminder about monolith defeat requirement
    if checkIfUnstable() then
      broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder[-]: The encounter is failed unless the monolith is defeated at the end of round 5.", "White")
    end

    Wait.time(function()

      if chipBreakdown[20] > 0 then
        for i = 1, chipBreakdown[20] do
          if enemyCount < 8 then
            local chip20 = bagHigh.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip20.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[10] > 0 then
        for i = 1, chipBreakdown[10] do
          if enemyCount < 8 then
            local chip10 = bagHigh.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip10.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[5] > 0 then
        for i = 1, chipBreakdown[5] do
          if enemyCount < 8 then
            local chip5 = bagLow.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip5.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[1] > 0 then
        for i = 1, chipBreakdown[1] do
          if enemyCount < 8 then
            local chip1 = bagLow.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip1.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end
    end, 1)

  elseif cardName == "Good Finds are Hard to Help" then
    -- OPTION 1
    -- broadcast reminder about enemy defeat effect
    if optionNumber == 1 then
      broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder[-]: Each time an adventurer defeats an enemy, they may draw 1 [Common Item].", "White")

      Wait.time(function()

        if chipBreakdown[20] > 0 then
          for i = 1, chipBreakdown[20] do
            if enemyCount < 8 then
              local chip20 = bagHigh.takeObject({rotation = { 0, 180, 0 }})
              enemyCount = enemyCount + 1
              local index = enemyCount
              Wait.frames(function() chip20.setPositionSmooth(spacesEnemies[index], false, true) end)
            end
          end
        end

        if chipBreakdown[10] > 0 then
          for i = 1, chipBreakdown[10] do
            if enemyCount < 8 then
              local chip10 = bagHigh.takeObject({rotation = { 0, 180, 180 }})
              enemyCount = enemyCount + 1
              local index = enemyCount
              Wait.frames(function() chip10.setPositionSmooth(spacesEnemies[index], false, true) end)
            end
          end
        end

        if chipBreakdown[5] > 0 then
          for i = 1, chipBreakdown[5] do
            if enemyCount < 8 then
              local chip5 = bagLow.takeObject({rotation = { 0, 180, 0 }})
              enemyCount = enemyCount + 1
              local index = enemyCount
              Wait.frames(function() chip5.setPositionSmooth(spacesEnemies[index], false, true) end)
            end
          end
        end

        if chipBreakdown[1] > 0 then
          for i = 1, chipBreakdown[1] do
            if enemyCount < 8 then
              local chip1 = bagLow.takeObject({rotation = { 0, 180, 180 }})
              enemyCount = enemyCount + 1
              local index = enemyCount
              Wait.frames(function() chip1.setPositionSmooth(spacesEnemies[index], false, true) end)
            end
          end
        end
      end, 1)

    -- OPTION 2
    elseif optionNumber == 2 then
      -- broadcast reminder that town encounter will need to be set up manually after siege battle
      broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder[-]: Click the Setup Siege Battle button on province map to set up Siege battle. Traveling Caravan town encounter must be manually set up after battle.", "White")
    end

  elseif cardName == "SK Siege Encounter" then
    -- requires obstacle placement (and also description tooltip updates / also a clear of obstacle descrptions in clear battle )
    -- deploy EP
    Wait.time(function()

      if chipBreakdown[20] > 0 then
        for i = 1, chipBreakdown[20] do
          if enemyCount < 8 then
            local chip20 = bagHigh.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip20.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[10] > 0 then
        for i = 1, chipBreakdown[10] do
          if enemyCount < 8 then
            local chip10 = bagHigh.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip10.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[5] > 0 then
        for i = 1, chipBreakdown[5] do
          if enemyCount < 8 then
            local chip5 = bagLow.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip5.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[1] > 0 then
        for i = 1, chipBreakdown[1] do
          if enemyCount < 8 then
            local chip1 = bagLow.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip1.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end
    end, 1)

  -- VW ENCOUNTERS
  elseif cardName == "Forest Fatalities" then
    -- deploy EP
    local enemyList = {}
    Wait.time(function()

      if chipBreakdown[20] > 0 then
        for i = 1, chipBreakdown[20] do
          if enemyCount < 8 then
            local chip20 = bagHigh.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip20.setPositionSmooth(spacesEnemies[index], false, true) table.insert(enemyList, chip20) end)
          end
        end
      end

      if chipBreakdown[10] > 0 then
        for i = 1, chipBreakdown[10] do
          if enemyCount < 8 then
            local chip10 = bagHigh.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip10.setPositionSmooth(spacesEnemies[index], false, true) table.insert(enemyList, chip10) end)
          end
        end
      end

      if chipBreakdown[5] > 0 then
        for i = 1, chipBreakdown[5] do
          if enemyCount < 8 then
            local chip5 = bagLow.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip5.setPositionSmooth(spacesEnemies[index], false, true) table.insert(enemyList, chip5) end)
          end
        end
      end

      if chipBreakdown[1] > 0 then
        for i = 1, chipBreakdown[1] do
          if enemyCount < 8 then
            local chip1 = bagLow.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip1.setPositionSmooth(spacesEnemies[index], false, true) table.insert(enemyList, chip1) end)
          end
        end
      end
    end, 1)

    -- OPTION 1
    -- normal setup, broadcast reminder about being able to deploy to any unoccupied hex
    if optionNumber == 1 then
      broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder[-]: Adventurers may deploy to any unoccupied hex.", "White")

    -- OPTION 2
    -- place arrows on playerCount number of enemies, highest possible
    elseif optionNumber == 2 then
      Wait.time(function()

        -- pull ONE base arrow token
        local tokenBag = getObjectbyName("Overland Token Bag")
        local baseArrowToken = nil
        for _, object in pairs(tokenBag.getObjects()) do
          if object.name == "Arrow Overland Token" then
            baseArrowToken = tokenBag.takeObject({ guid = object.guid })
            Wait.time(function() tokenBag.putObject(baseArrowToken) end, 2)
            break
          end
        end

        for i = 1, playerCount do
          Wait.time(function()

            local clone = baseArrowToken.clone({})          
            local posChip = enemyList[i].getPosition()
            posChip.y = 3.50
            posChip.z = posChip.z + 0.58

            -- place clone on chip
            Wait.frames(function()
              if clone then
                clone.setGMNotes("Cloned Token")
                clone.setRotation({ 0, 330, 0 })
                clone.setPosition({x=posChip.x, y=posChip.y, z=posChip.z})
              end
            end)
          end, 2)
        end
      end, 1)
      broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder[-]: Arrow token enemies take their turns before adventurers each round.", "White")
    end

  elseif cardName == "Altar Your Destiny" then
    -- deploy EP aside mat instead of spacesEnemies
    local enemyList = {}
    Wait.time(function()

      if chipBreakdown[20] > 0 then
        for i = 1, chipBreakdown[20] do
          if enemyCount < 8 then
            local chip20 = bagHigh.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip20.setPositionSmooth(spacesEnemies[index], false, true) table.insert(enemyList, chip20) end)
          end
        end
      end

      if chipBreakdown[10] > 0 then
        for i = 1, chipBreakdown[10] do
          if enemyCount < 8 then
            local chip10 = bagHigh.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip10.setPositionSmooth(spacesEnemies[index], false, true) table.insert(enemyList, chip10) end)
          end
        end
      end

      if chipBreakdown[5] > 0 then
        for i = 1, chipBreakdown[5] do
          if enemyCount < 8 then
            local chip5 = bagLow.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip5.setPositionSmooth(spacesEnemies[index], false, true) table.insert(enemyList, chip5) end)
          end
        end
      end

      if chipBreakdown[1] > 0 then
        for i = 1, chipBreakdown[1] do
          if enemyCount < 8 then
            local chip1 = bagLow.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip1.setPositionSmooth(spacesEnemies[index], false, true) table.insert(enemyList, chip1) end)
          end
        end
      end
      
      Wait.time(function()

        -- sum HP of those enemies
        local sumHP = 0
        for i = 1, #enemyList do
          sumHP = sumHP + enemyList[i].getVar('val')
        end
        broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Encounter effect combined health stats[-]: " .. sumHP .. ".", "White")

        -- deploy level 10, give HP of those enemies
        local lvl10 = bagHigh.takeObject({rotation = { 0, 180, 180 }})
        Wait.frames(function() lvl10.setPosition({ -2.08, 2.00, 2.41 }) end)
        Wait.time(function()
          
          local bagScript = getObjectbyName("Defeated Monsters Bag")
          bagScript.call('set_val_remote', {chipObj=lvl10, val=sumHP})

        end, 2)

        -- broadcast reminder about stalwart and session 1 ignore defense stat
        if lvl10.getDescription():find("Stalwart") then
          broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder[-]: Ignore enemy skill Stalwart." .. sumHP .. ".", "White")
        end
        broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder[-]: If you are in session 1, also ignore the enemy's defense.", "White")

      end, 1)

    end, 1)        

  elseif cardName == "Heeding the Call" then
    -- increase calculatedEP by playerCount * 2
    currentCalculatedEP = currentCalculatedEP + (playerCount * 2)
    chipBreakdown = getChipBreakdown(currentCalculatedEP)

    -- deploy EP
    Wait.time(function()

      if chipBreakdown[20] > 0 then
        for i = 1, chipBreakdown[20] do
          if enemyCount < 8 then
            local chip20 = bagHigh.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip20.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[10] > 0 then
        for i = 1, chipBreakdown[10] do
          if enemyCount < 8 then
            local chip10 = bagHigh.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip10.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[5] > 0 then
        for i = 1, chipBreakdown[5] do
          if enemyCount < 8 then
            local chip5 = bagLow.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip5.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[1] > 0 then
        for i = 1, chipBreakdown[1] do
          if enemyCount < 8 then
            local chip1 = bagLow.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip1.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end
    end, 1)

    -- broadcast reminder about fear status die on enemy defeat
    broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder[-]: When an enemy is defeated, apply a Fear status die to an enemy of a lower level, if possible.", "White")

    -- need to pull and place arvan, set as party companion
    local bagQuestChip = getObjectbyName("Quest Unit / Companion Chip Bag")
    local posArvan = { 13.32, 2.00, -2.91 }
    local chipArvan = nil
    for _, object in pairs(bagQuestChip.getObjects()) do
      if object.name:find("Arvan") then
        chipArvan = bagQuestChip.takeObject({guid=object.guid, rotation={ 0, 180, 0 }})
      end
    end
    if chipArvan ~= nil then
      Wait.frames(function() chipArvan.setPosition(posArvan) end)
    end
    Wait.time(function()

      local bagScript = getObjectbyName("Defeated Monsters Bag")
      bagScript.call('mark_party_companion', chipArvan)

    end, 2)

    -- broadcast reminder about arvan defeating enemy effect
    broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder[-]: When Arvan defeats an enemy, set it aside.", "White")

    -- broadcast reminder about resistance keyword
    Wait.time(function() broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder[-]: At the end of the encounter, gain keyword: Resistance for each enemy set aside.", "White") end, 1)

  elseif cardName == "An Enemy In Need" then
    --  obstacle placement in deployClash()    
    -- add Arvan to EP, deploy him first    
    local extraBag = getObjectbyName("Quest Unit / Companion Chip Bag")
    local extraRot = { 0, 180, 0 }
    for _, object in pairs(extraBag.getObjects()) do
      if object.name:find("Arvan") then
        local chipExtraEnemy = extraBag.takeObject({guid = object.guid, rotation = extraRot})
        enemyCount = 1
        Wait.frames(function()
          chipExtraEnemy.setPositionSmooth(spacesEnemies[enemyCount], false, true)
        end)
        break
      end
    end

    -- deploy rest of EP
    Wait.time(function()

      if chipBreakdown[20] > 0 then
        for i = 1, chipBreakdown[20] do
          if enemyCount < 8 then
            local chip20 = bagHigh.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip20.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[10] > 0 then
        for i = 1, chipBreakdown[10] do
          if enemyCount < 8 then
            local chip10 = bagHigh.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip10.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[5] > 0 then
        for i = 1, chipBreakdown[5] do
          if enemyCount < 8 then
            local chip5 = bagLow.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip5.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[1] > 0 then
        for i = 1, chipBreakdown[1] do
          if enemyCount < 8 then
            local chip1 = bagLow.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip1.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end
    end, 1)

    -- OPTION 1    
    -- broadcast reminder about ignoring conflict influence track
    if optionNumber == 1 then
      broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder[-]: Ignore the Conflict Influence Track during this battle.", "White")

    elseif optionNumber == 2 then     
    -- OPTION 2
    -- broadcast reminder about unlocking caches
      broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder[-]: When a cache is unlocked, you may choose to discard the gained item to reduce an influence track by up to 2.", "White")
    end

  elseif cardName == "Vine Snared" then
    -- broadcast reminder about fatigue etc
    broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder[-]: For each hex an adventurer moves into during their move action, they must gain light fatigue equal to the number of items in their ready slots.", "White")

    -- deploy EP
    Wait.time(function()

      if chipBreakdown[20] > 0 then
        for i = 1, chipBreakdown[20] do
          if enemyCount < 8 then
            local chip20 = bagHigh.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip20.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[10] > 0 then
        for i = 1, chipBreakdown[10] do
          if enemyCount < 8 then
            local chip10 = bagHigh.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip10.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[5] > 0 then
        for i = 1, chipBreakdown[5] do
          if enemyCount < 8 then
            local chip5 = bagLow.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip5.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[1] > 0 then
        for i = 1, chipBreakdown[1] do
          if enemyCount < 8 then
            local chip1 = bagLow.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip1.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end
    end, 1)

  elseif cardName == "Parting the Veiled" then
    -- OPTION 1
    -- pull, place Arvan, make companion
    -- increase influence tracks by playerCount
    if optionNumber == 1 then
      broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder[-]: Increase influence tracks by a collective total of ".. playerCount .. ".", "White")
      local bagQuestChip = getObjectbyName("Quest Unit / Companion Chip Bag")
      local posArvan = { -11.28, 1.24, -2.91 }
      local chipArvan = nil
      for _, object in pairs(bagQuestChip.getObjects()) do
        if object.name:find("Arvan") then
          chipArvan = bagQuestChip.takeObject({guid=object.guid, rotation={ 0, 180, 0 }})
        end
      end
      if chipArvan ~= nil then
        Wait.frames(function() chipArvan.setPosition(posArvan) end)
      end
      Wait.time(function()

        local bagScript = getObjectbyName("Defeated Monsters Bag")
        bagScript.call('mark_party_companion', chipArvan)

      end, 2)

    -- OPTION 2
    -- broadcast about skipping round 1 recovery
    -- also broadcast about reducing influence track and skipping activate province step
    elseif optionNumber == 2 then
      broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder[-]: Each adventurer skips their recovery step during Round 1.", "White")
      Wait.time(function() broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder[-]: If this encounter is successful, reduce the influence track of your choice by up to 2 and skip today's Activate Province step.", "White") end, 1)
    end

    -- deploy EP
    Wait.time(function()

      if chipBreakdown[20] > 0 then
        for i = 1, chipBreakdown[20] do
          if enemyCount < 8 then
            local chip20 = bagHigh.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip20.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[10] > 0 then
        for i = 1, chipBreakdown[10] do
          if enemyCount < 8 then
            local chip10 = bagHigh.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip10.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[5] > 0 then
        for i = 1, chipBreakdown[5] do
          if enemyCount < 8 then
            local chip5 = bagLow.takeObject({rotation = { 0, 180, 0 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip5.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end

      if chipBreakdown[1] > 0 then
        for i = 1, chipBreakdown[1] do
          if enemyCount < 8 then
            local chip1 = bagLow.takeObject({rotation = { 0, 180, 180 }})
            enemyCount = enemyCount + 1
            local index = enemyCount
            Wait.frames(function() chip1.setPositionSmooth(spacesEnemies[index], false, true) end)
          end
        end
      end
    end, 1)
  end
end


function deployEnemyType(enemyLevel, enemyType, position)
  
  -- this function handles the deployment of Clash battle enemies
  
  local chipFound = false

  -- this function handles a clash enemy draw that is required to be of a special type
  local enemyChipSide = (enemyLevel == 1 or enemyLevel == 10) and "Low" or "High"
  local rotDrawnEnemy  = enemyChipSide == "Low" and { 0, 180, 180 } or { 0, 180, 0 }
  local validTags      = { enemyHuman = true, enemyBeast = true, enemyDaedra = true }
  local bagEnemyDraw = (enemyLevel == 1 or enemyLevel == 5) and getObjectbyName("Level 1 / 5 Enemies") or getObjectbyName("Level 10 / 20 Enemies")
  bagEnemyDraw.shuffle()

  local chip = nil

  for _, object in pairs(bagEnemyDraw.getObjects()) do
    local objTags = object.tags

    for _, tag in ipairs(objTags) do
      local tagLeft, tagRight = tag:match("([^_]+)_([^_]+)")
      local primaryTag

      if tagLeft and tagRight then
        if validTags[tagLeft] and validTags[tagRight] then
          primaryTag = (enemyChipSide == "Low") and tagLeft or tagRight
        else
          primaryTag = nil
        end
      else
        primaryTag = validTags[tag] and tag or nil
      end

      if primaryTag
      and ((primaryTag == "enemyHuman"  and enemyType == "Human")
      or (primaryTag == "enemyBeast"  and enemyType == "Beast")
      or (primaryTag == "enemyDaedra" and enemyType == "Daedra")) then

        chip = bagEnemyDraw.takeObject({ rotation = rotDrawnEnemy, guid = object.guid })
        Wait.time(function()

          chip.clearButtons()
          chip.setVar('just_flipped', true)

        end, 2)
        -- Wait.frames(function() chip.setPositionSmooth(position, false, true) end)
        chipFound = true
        break

      end
    end

    if chip then break end
  end
  return chip
end


function checkWeather()
  
  -- this function checks current weather during black marsh province encounters, returns nil if unable to determine
  local isBM = false
  local currentWeather = nil
  for _, object in pairs(getObjects()) do
    if object.getName() == "" then
      isBM = true
    end
  end
  if not isBM then log("checkWeather(): not currently Black Marsh in play") return nil end

  local weatherToken = nil
  for _, object in pairs(getObjects()) do
    if object.getName() == "Book Overland Token" and object.getDescription() == "Weather Gauge" then
      weatherToken = object
    end
  end
  if weatherToken == nil then log("checkWeather(): unable to find Weather Gauge token") return nil end

  local tolerance = 0.50
  local posWeatherToken = weatherToken.getPosition()
  local posX     = {
    ["Sunny"]    = -37.40,
    ["Rainy"]    = -36.10,
    ["Flooding"] = -34.79,
  }

  -- use X axis position via tolerance to determine current weather
  for weatherType, posVal in pairs(posX) do
    if math.abs(posWeatherToken.x - posVal) <= tolerance then
      currentWeather = weatherType
      break
    end
  end
  return currentWeather
end


function checkDominantFaction()

  -- this function handles the check of current dominant faction in cyrodiil, returns faction or nil
  local dominantFaction = nil
  local dominantFactionToken = nil
  local posFactions = {
    ["Empire"]      = { -54.43, 1.69, 0.72 },
    ["DC"]          = { -54.40, 1.69, 5.70 },
    ["EP"]          = { -50.90, 1.69, 4.22 },
    ["AD"]          = { -49.46, 1.69, 0.71 },    
  }

  for _, object in pairs(getObjects()) do
    if object.getName() == "Scroll Overland Token" and object.getDescription() == "Dominant Faction Token" then
      dominantFactionToken = object
    end
  end
  if dominantFactionToken == nil then log("checkDominantFaction(): dominantFactionToken not found") return nil end
  
  local posToken = dominantFactionToken.getPosition()
  local tolerance = 0.50
  -- determine token's current faction via position
  for factionName, posFaction in pairs(posFactions) do
    if math.abs(posToken.x - posFaction[1]) <= tolerance
    and math.abs(posToken.z - posFaction[3]) <= tolerance then
      dominantFaction = factionName    
      break
    end
  end
 return dominantFaction
end


function checkUnrest()

  -- this function handles the check of current unrest in high rock, returns number value, level string
  local unrestCount = 0
  local unrestString = ""
  local posUnrest = {
    {-47.29, 1.69, 0.75},
    {-45.97, 1.69, 0.75},
    {-44.65, 1.69, 0.75},
    {-43.09, 1.69, 0.75},
    {-41.75, 1.69, 0.75},
    {-40.20, 1.69, 0.72},
    {-38.88, 1.69, 0.72},
    {-37.30, 1.69, 0.73},
    {-35.99, 1.69, 0.72},
    {-34.65, 1.69, 0.72},
  }
  local tolerance = 0.50
  local tokenUnrest = nil
  for _, object in pairs(getObjects()) do
    if object.getName() == "Book Overland Token" and object.getDescription() == "Unrest Token" then
      tokenUnrest = object
    end
  end
  if tokenUnrest == nil then log("checkUnrest(): tokenUnrest not found") return nil, nil end

  -- using tolerance method, determine which index of posUnrest the token is on, if any
  local posToken = tokenUnrest.getPosition()
  for index, posVal in pairs(posUnrest) do
    if math.abs(posToken.x - posVal[1]) <= tolerance
    and math.abs(posToken.z - posVal[3]) <= tolerance then
      unrestCount = index - 1
      break
    end
  end

  -- set unrestString per current numerical unrestCount value
  if unrestCount < 3 then
    unrestString = "Peaceful"
  elseif unrestCount == 3 or unrestCount == 4 then
    unrestString = "Tense"
  elseif unrestCount == 5 or unrestCount == 6 then
    unrestString = "Dangerous"
  elseif unrestCount > 6 then
    unrestString = "Chaotic"
  end

  return unrestCount, unrestString
end


function moveUnrest(count)

  local oldCount, _ = checkUnrest()
  local newCount = oldCount + count
  if newCount < 0 then newCount = 0 end
  if newCount > 9 then newCount = 9 end
  local posUnrest = {
    { -47.29, 1.69, 0.75 },
    { -45.97, 1.69, 0.75 },
    { -44.65, 1.69, 0.75 },
    { -43.09, 1.69, 0.75 },
    { -41.75, 1.69, 0.75 },
    { -40.20, 1.69, 0.72 },
    { -38.88, 1.69, 0.72 },
    { -37.30, 1.69, 0.73 },
    { -35.99, 1.69, 0.72 },
    { -34.65, 1.69, 0.72 },
  }
  local tokenUnrest = nil
  for _, object in pairs(getObjects()) do
    if object.getName() == "Book Overland Token" and object.getDescription() == "Unrest Token" then
      tokenUnrest = object
    end
  end
  if tokenUnrest == nil then log("moveUnrest(): tokenUnrest not found") return end

  Wait.frames(function()
    tokenUnrest.setPosition(posUnrest[newCount + 1])
  end)

  local _, unrestString = checkUnrest()

  broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder[-]: Unrest level is now " .. unrestString .. " (from " .. oldCount .. " to " .. newCount .. ").", "White")
end


function checkDig()

  -- same as checkUnrest() but for MW dig track (returns single number value)
  local digCount = 0
  local posDig = {
    { -46.92, 1.69, 0.72 },
    { -45.62, 1.69, 0.73 },
    { -44.30, 1.69, 0.73 },
    { -42.97, 1.69, 0.72 },
  }
  local tolerance = 0.50
  local tokenDig = nil
  for _, object in pairs(getObjects()) do
    if object.getName() == "Book Overland Token" and object.getDescription() == "Dig Token" then
      tokenDig = object
    end
  end
  if tokenDig == nil then log("checkDig(): tokenDig not found") return nil, nil end

  -- using tolerance method, determine which index of posDig the token is on, if any
  local posToken = tokenDig.getPosition()
  for index, posVal in pairs(posDig) do
    if math.abs(posToken.x - posVal[1]) <= tolerance
    and math.abs(posToken.z - posVal[3]) <= tolerance then
      digCount = index - 1
      break
    end
  end
  return digCount
end


function checkExcavation()

  -- same as checkDig() but for MW excavation track
  local excCount = 0
  local posExc = {
    { -41.36, 1.69, 0.72 },
    { -40.04, 1.69, 0.72 },
    { -38.72, 1.69, 0.72 },
    { -37.40, 1.69, 0.72 },
    { -36.08, 1.69, 0.72 },
    { -34.82, 1.69, 0.72 },
  }
  local tolerance = 0.50
  local tokenExc = nil
  for _, object in pairs(getObjects()) do
    if object.getName() == "Book Overland Token" and object.getDescription() == "Excavation Token" then
      tokenExc = object
    end
  end
  if tokenExc == nil then log("checkDig(): tokenExc not found") return nil, nil end

  -- using tolerance method, determine which index of posDig the token is on, if any
  local posToken = tokenExc.getPosition()
  for index, posVal in pairs(posExc) do
    if math.abs(posToken.x - posVal[1]) <= tolerance
    and math.abs(posToken.z - posVal[3]) <= tolerance then
      excCount = index - 1
      break
    end
  end
  return excCount
end


function moveDig(count)

  -- this function handles the movement of the dig track, and excavation track if required
  local posDig = {
    { -46.92, 1.69, 0.72 },
    { -45.62, 1.69, 0.73 },
    { -44.30, 1.69, 0.73 },
    { -42.97, 1.69, 0.72 },
  }
  local posExc = {
    { -41.36, 1.69, 0.72 },
    { -40.04, 1.69, 0.72 },
    { -38.72, 1.69, 0.72 },
    { -37.40, 1.69, 0.72 },
    { -36.08, 1.69, 0.72 },
    { -34.82, 1.69, 0.72 },
  }
  local oldDig = checkDig()
  local oldExc = checkExcavation()
  local newDig = oldDig + count
  local newExc = 0

  local digToken = nil
  local excToken = nil

  for _, object in pairs(getObjects()) do
    if object.getName() == "Book Overland Token" and object.getDescription() == "Dig Token" then
      digToken = object
    end
    if object.getName() == "Book Overland Token" and object.getDescription() == "Excavation Token" then
      excToken = object
    end
  end
  if digToken == nil then log("moveDig(): digToken not found") return end
  if excToken == nil then log("moveDig(): excToken not found") return end
  
  -- handle newDig being off the track, and increasing excavation track by 1
  if newDig > 4 then
    -- broadcast alert about the dig track increasing off the track, and excavation track increasing by 1
    newExc = oldExc + 1
    if newExc > 5 then newExc = 5 end
    Wait.time(function()

      if oldExc == 5 then
        broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder[-]: Dig track has moved off the track (from " .. oldDig .. "), excavation track is already full.", "White")
      else
        broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder[-]: Dig track has moved off the track (from " .. oldDig .. "), excavation track increases by 1 (from " .. oldExc .. " to " .. newExc .. ").", "White")
        -- move excavation tracker
        excToken.setPosition(posExc[newExc+1])
      end

    end, .5)
    newDig = 0
  else
    broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder[-]: Dig track has moved from " .. oldExc .. " to " .. newExc .. ".", "White")
  end
  -- move dig tracker
  digToken.setPosition(posDig[newDig+1])
end


function checkIfAnchre()

  -- helper for MW, a few clashes check if party token is on Anchre Egg Mine site
  local partyToken = getObjectbyName("Party Overland Token")
  if partyToken == nil then log("checkIfAnchre(): partyToken not found") return false end

  local posAnchre = { -37.79, 1.69, 10.01 }
  local tolerance = 0.50
  local posToken = partyToken.getPosition()
  if math.abs(posToken.x - posAnchre[1]) <= tolerance
  and math.abs(posToken.z - posAnchre[3]) <= tolerance then
    return true
  else
    return false
  end
end


function siegeBattle(button, _, _)
  animateButtonsGeneric(button)
  deployClash("SK Siege Encounter", 1)

end


function deploySkyrimTown()
  local townData = {
    ["Traveling Caravan"] = {
      ["Trainers"]        = true,
      ["Guild Kiosk"]     = true,
      ["Shop"]            = true,
      ["Inn"]             = false,
    },
    ["Dragon Bridge"] = {
      ["Trainers"]        = true,
      ["Guild Kiosk"]     = false,
      ["Shop"]            = false,
      ["Inn"]             = true,
    },
    ["Dusktown"] = {
      ["Trainers"]        = true,
      ["Guild Kiosk"]     = true,
      ["Shop"]            = true,
      ["Inn"]             = true,
    },
    ["Fort Amol"] = {
      ["Trainers"]        = true,
      ["Guild Kiosk"]     = true,
      ["Shop"]            = true,
      ["Inn"]             = true,
    },
    ["Fort Morvunskar"] = {
      ["Trainers"]        = true,
      ["Guild Kiosk"]     = true,
      ["Shop"]            = false,
      ["Inn"]             = true,
    },
    ["Fullhelm Fort"] = {
      ["Trainers"]        = true,
      ["Guild Kiosk"]     = false,
      ["Shop"]            = true,
      ["Inn"]             = true,
    },
    ["Ivarstead"] = {
      ["Trainers"]        = true,
      ["Guild Kiosk"]     = false,
      ["Shop"]            = true,
      ["Inn"]             = true,
    },
    ["Jorunn's Stand"] = {
      ["Trainers"]        = true,
      ["Guild Kiosk"]     = true,
      ["Shop"]            = true,
      ["Inn"]             = false,
    },
    ["Karthwasten"] = {
      ["Trainers"]        = true,
      ["Guild Kiosk"]     = false,
      ["Shop"]            = false,
      ["Inn"]             = false,
    },
    ["Karthwatch"] = {
      ["Trainers"]        = true,
      ["Guild Kiosk"]     = false,
      ["Shop"]            = false,
      ["Inn"]             = true,
    },
    ["Kilkreath Temple"] = {
      ["Trainers"]        = true,
      ["Guild Kiosk"]     = false,
      ["Shop"]            = false,
      ["Inn"]             = true,
    },
    ["Lost Valley Redoubt"] = {
      ["Trainers"]        = false,
      ["Guild Kiosk"]     = false,
      ["Shop"]            = true,
      ["Inn"]             = false,
    },
    ["Markarth"] = {
      ["Trainers"]        = true,
      ["Guild Kiosk"]     = true,
      ["Shop"]            = true,
      ["Inn"]             = true,
    },
    ["Mistwatch"] = {
      ["Trainers"]        = true,
      ["Guild Kiosk"]     = false,
      ["Shop"]            = false,
      ["Inn"]             = false,
    },
    ["Mor Khazgur"] = {
      ["Trainers"]        = true,
      ["Guild Kiosk"]     = true,
      ["Shop"]            = true,
      ["Inn"]             = false,
    },
    ["Morthal"] = {
      ["Trainers"]        = true,
      ["Guild Kiosk"]     = true,
      ["Shop"]            = true,
      ["Inn"]             = true,
    },
    ["Nimalten"] = {
      ["Trainers"]        = true,
      ["Guild Kiosk"]     = true,
      ["Shop"]            = true,
      ["Inn"]             = true,
    },
    ["Rebel's Retreat"] = {
      ["Trainers"]        = true,
      ["Guild Kiosk"]     = false,
      ["Shop"]            = true,
      ["Inn"]             = false,
    },
    ["Riften"] = {
      ["Trainers"]        = true,
      ["Guild Kiosk"]     = true,
      ["Shop"]            = true,
      ["Inn"]             = true,
    },
    ["Shor's Stone"] = {
      ["Trainers"]        = true,
      ["Guild Kiosk"]     = true,
      ["Shop"]            = true,
      ["Inn"]             = true,
    },
    ["The Silver Cormorant"] = {
      ["Trainers"]        = true,
      ["Guild Kiosk"]     = false,
      ["Shop"]            = false,
      ["Inn"]             = true,
    },
    ["Skald's Retreat"] = {
      ["Trainers"]        = true,
      ["Guild Kiosk"]     = true,
      ["Shop"]            = false,
      ["Inn"]             = true,
    },
    ["Solitude"] = {
      ["Trainers"]        = true,
      ["Guild Kiosk"]     = true,
      ["Shop"]            = true,
      ["Inn"]             = true,
    },
    ["Windhelm"] = {
      ["Trainers"]        = true,
      ["Guild Kiosk"]     = true,
      ["Shop"]            = true,
      ["Inn"]             = true,
    },
    ["Wittestadr"] = {
      ["Trainers"]        = true,
      ["Guild Kiosk"]     = false,
      ["Shop"]            = false,
      ["Inn"]             = true,
    },
  }

  -- tiles that always deploy
  local alwaysTile = {
    ["Town Square"] = true,
  }

  local rot3Hex = { 0, 60, 0 }
  local pos3Hex = {
    { 2.05, 2.38, 13.06 },
    { 2.05, 2.63, 2.41 },
    { 2.05, 2.38, -8.24 },
  }
  local ttip3Hex = {
    "Trainers",
    "Town Square",
    "Guild Kiosk",
  }
  local rot7Hex = { 0, 120, 0 }
  local pos7Hex = {
    { 13.32, 1.24, 11.29 },
    { 13.32, 1.24, -6.46 },
  }
  local ttip7Hex = {
    "Shop",
    "Inn",
  }

  -- determine whether current province map is Eastern or Western Skyrim
  local zone = getObjectFromGUID("64c0a4")
  local provinceMapName = nil
  for _, obj in ipairs(zone.getObjects()) do
    local name = obj.getName()
    local match = string.match(name, "^(.-) Overland Map$")
    if match and posEncounters[match] then
      provinceMapName = match
      break
    end
  end
  if not provinceMapName then
    broadcastToAll("No Province Map Found. Set up encounter manually", "Orange")
    return
  end

  -- get partyToken, determine its position 
  local partyToken = getObjectbyName("Party Overland Token")
  if not partyToken then
    broadcastToAll("Party Overland Token not found - Set up encounter manually.", "Orange")
    return
  end
  local pos = partyToken.getPosition()
  local x, y = pos.x, pos.z
  local data = posEncounters[provinceMapName]
  local tol = 0.3

  -- determine name of town for layout
  local townName = nil
  for category, entries in pairs(data) do    
    for name, coords in pairs(entries) do
      if math.abs(coords[1] - x) <= tol and math.abs(coords[3] - y) <= tol then
        if category == "Town" then
          townName = name
        end
      end
    end
  end
  if not townName then
    townName = "Traveling Caravan"
  end

  -- merge alwaysTile layout
  local layout = townData[townName] or townData["Traveling Caravan"]
  for k, v in pairs(alwaysTile) do
    layout[k] = v
  end

  local bagObstacle = getObjectbyName("Obstacle Hex Bag")

  -- pull, place 3 hex tiles if required
  for i = 1, 3 do
    local hexName = ttip3Hex[i]
    if layout[hexName] then
      local hex3 = nil
      for _, object in pairs(bagObstacle.getObjects()) do
        if object.name == "Skyrim Siege " .. hexName then
          hex3 = bagObstacle.takeObject({guid=object.guid})
          break
        end
      end
      if hex3 ~= nil then
        hex3.setRotation(rot3Hex)
        hex3.setPosition(pos3Hex[i], false, false)
        hex3.setLock(true)
        hex3.setDescription(ttip3Hex[i])
      end
    end
  end

  -- pull, place 7 hex tiles if required
  for i = 1, 2 do
    local hexName = ttip7Hex[i]
    if layout[hexName] then
      local hex7 = nil
      for _, object in pairs(bagObstacle.getObjects()) do
        if object.name == "Skyrim Siege " .. hexName then
          hex7 = bagObstacle.takeObject({guid=object.guid})
          break
        end
      end
      if hex7 ~= nil then
        hex7.setRotation(rot7Hex)
        hex7.setPosition(pos7Hex[i], false, false)
        hex7.setLock(true)
        hex7.setDescription(ttip7Hex[i])
      end
    end
  end
  
  -- broadcast
  Wait.time(function()
    broadcastToAll("[" .. Color.fromString("Yellow"):toHex() .. "]" .. townName .. "[-] Skyrim Siege encounter has been set up.")
  end, 2)
end


function setupDungeonMap(button, _, _)

  -- this function sets up a base dungeon map for current province
  animateButtonsGeneric(button)

  local playerCount = getObjectbyName("Button Player Count").getVar('val')

  -- detect current province
  -- get and find province map, provinceMapName (especially important for eastern/western skyrim)
  local zone = getObjectFromGUID("64c0a4")
  local provinceName = nil
  for _, obj in ipairs(zone.getObjects()) do
    local name = obj.getName()
    local match = string.match(name, "^(.-) Overland Map$")
    if match and posEncounters[match] then
      provinceName = match
      break
    end
  end
  if provinceName:find("Eastern") or provinceName:find("Western") then provinceName = "Skyrim" end
  if not provinceName then
    broadcastToAll("No Province Map Found, unable to determine dungeon to set up!.", "Orange")
    return
  end
  
  -- detect if battle area is clear
  local checkZoneBattle = getObjectFromGUID("b5dd6d")
  for _, object in pairs(checkZoneBattle.getObjects()) do
    if object.getName() == "Clash Mat" or object.getName():find("Gazetteer") then
      broadcastToAll("Clear previous encounter before using this button.", "Orange")
      return
    end
  end

  -- if clear, lay out dungeon
  local bagEntrance = getObjectbyName("Entrance Tile Bag")
  local bagClash = getObjectbyName("Clash Mat Bag")    
  local bag3Hex = getObjectbyName("3 Hex Bag")
  local bag6Hex = getObjectbyName("6 Hex Bag")
  local bag7Hex = getObjectbyName("7 Hex Bag")
  local bag19Hex = getObjectbyName("19 Hex Bag")
  local bagObstacle = getObjectbyName("Obstacle Hex Bag")
  local bagCaches = getObjectbyName("Cache Chip Bag")
  rotDungeon = {
    ["Black Marsh"] = {
      ["Clash"]     = { 0, 300, 0 },
      ["Entrance"]  = { 0, 180, 0 },
      ["7Hex"]      = { 0, 60, 0 },
      ["6Hex"]      = { { 0, 120, 0 }, { 0, 0, 0 }, { 0, 0, 0 } },
      ["3Hex"]      = { { 0, 0, 0 }, { 0, 0, 0 }, { 0, 60, 0 } },
      ["Caches"]    = { 0, 180, 0 }
    },
    ["Cyrodiil"]    = {
      ["Entrance"]  = { 0, 180, 0 },
      ["19Hex"]     = { 0, 60, 0 },
      ["7Hex"]      = { 0, 60, 0 },
      ["6Hex"]      = { { 0, 60, 0 }, { 0, 180, 0 }, { 0, 180, 0 } },
      ["3Hex"]      = { 0, 0, 0 },
      ["Caches"]    = { 0, 180, 0 }
    },
    ["High Rock"]   = {
      ["Entrance"]  = { 0, 120, 0 },
      ["19Hex"]     = { 0, 60, 0 },
      ["7Hex"]      = { 0, 60, 0 },
      ["6Hex"]      = { { 0, 180, 0 }, { 0, 120, 0 } },
      ["3Hex"]      = { { 0, 0, 0 }, { 0, 300, 0 }, { 0, 300, 0 } },
      ["Caches"]    = { { 0, 180, 0}, { 0, 180, 0}, { 0, 180, 0}, { 0, 180, 0}, { 0, 180, 180} }
    },
    ["Morrowind"]   = {
      ["Entrance"]  = { 0, 180, 0 },
      ["19Hex"]     = { 0, 60, 0 },
      ["6Hex"]      = { { 0, 180, 0 }, { 0, 120, 0 }, { 0, 120, 0 } },
      ["3Hex"]      = { { 0, 0, 0 }, { 0, 300, 0 } },
      ["Caches"]    = { 0, 180, 0 }
    },
    ["Skyrim"]      = {
      ["Entrance"]  = { 0, 0, 0 },
      ["19Hex"]     = { 0, 60, 0 },
      ["6Hex"]      = { 0, 120, 0 },
      ["3Hex"]      = { { 0, 0, 0 }, { 0, 0, 0 }, { 0, 60, 0} },
      ["Caches"]    = { { 0, 180, 0 }, { 0, 180, 180} },
      ["Counters"]  = { 0, 180, 0 },
      ["Vampire"]    = { 0, 180, 0 }
    },
    ["Valenwood"]   = {
      ["Entrance"]  = { 0, 300, 0 },
      ["19Hex"]     = { 0, 60, 0 },
      ["7Hex"]      = { 0, 60, 0 },
      ["6Hex"]      = { { 0, 60, 0 }, { 0, 0, 0 }, { 0, 120, 0 } },
      ["3Hex"]      = { 0, 0, 0 },
      ["19Obs"]     = { 0, 60, 0 },
      ["6Obs"]      = { 0, 300, 0 },
      ["3Obs"]      = { 0, 0, 0 },
    }
  }
  posDungeon = {
    ["Black Marsh"] = {
      ["Clash"]     = { 12.30, 1.37, 5.97 },
      ["Entrance"]  = { 18.45, 1.53, -4.69 },
      ["7Hex"]      = { -17.43, 1.24, 11.29 },
      ["6Hex"]      = { { -1.03, 1.24, 7.74 }, { -7.18, 1.24, 4.19 }, { 2.10, 1.24, -4.74 } },
      ["3Hex"]      = { { -3.08, 1.53, 14.84 }, { -15.38, 1.53, 0.64 }, { -7.18, 1.53, -6.46 } },
      ["Caches"]    = { { 13.33, 1.83, 14.86 }, { -2.10, 1.53, 6.04 }, { 4.12, 1.53, -8.22 } }
    },
    ["Cyrodiil"]    = {
      ["Entrance"]  = { -4.10, 1.53, 13.06 },
      ["19Hex"]     = { 0.00, 1.53, -1.14 },
      ["7Hex"]      = { { -12.30, 1.24, 13.06 }, { 15.37, 1.24, 7.74 }, { 0.00, 1.53, -1.14 } },
      ["6Hex"]      = { { -19.48, 1.24, -2.91 }, { -13.33, 1.24, 0.64 }, { 11.27, 1.24, -2.91 } },
      ["3Hex"]      = { { 2.05, 1.53, 9.51 }, { 17.42, 1.53, 0.64 } },
      ["Caches"]    = { { 0.04, 1.53, 5.82 }, { 6.09, 1.53, -1.18 }, { 0.06, 1.53, -8.13 }, { -6.07, 1.53, -1.25 } }
    },
    ["High Rock"]   = {
      ["Entrance"]  = { 4.10, 1.53, 13.06 },
      ["19Hex"]     = { -6.15, 1.53, -1.14 },
      ["7Hex"]      = { { -12.30, 1.24, 13.06 }, { 16.40, 1.24, -1.14 } },
      ["6Hex"]      = { { -4.10, 1.24, 13.06 }, { 14.35, 1.24, 5.96 } },
      ["3Hex"]      = { { -16.40, 1.53, -1.14 }, { 4.10, 1.53, -1.14 }, { 14.35, 1.53, 13.06 } },
      ["Caches"]    =  { { -6.09, 1.53, -8.13 }, { -6.11, 1.53, 5.82 }, { 13.46, 1.53, -2.92 }, { 19.34, 1.53, -2.87 }, { 16.40, 2.37, -1.20 } }
    },
    ["Morrowind"]   = {
      ["Entrance"]  = { 14.35, 1.53, -4.69 },
      ["19Hex"]     = { 0.00, 1.53, 5.96 },
      ["6Hex"]      = { { -13.33, 1.24, 11.29 }, { -11.28, 1.24, -2.91 }, { 10.25, 1.24, 13.06 } },
      ["3Hex"]      = { { 8.20, 1.53, -1.14 }, { 13.32, 1.53, 0.64 } },
      ["Caches"]    = { { -15.35, 1.53, -2.96 }, { -15.35, 1.53, 14.77 }, { 15.17, 1.53, 14.82 } }
    },
    ["Skyrim"]      = {
      ["Entrance"]  = { 16.40, 1.53, 5.96 },
      ["19Hex"]     = { -9.23, 1.53, 4.19 },
      ["6Hex"]      = { { 1.04, 1.24, 11.33 }, { 10.25, 1.24, -1.14 } },
      ["3Hex"]      = { { -1.03, 1.53, -2.91 }, { 8.20, 1.53, 9.51 }, { 4.10, 1.53, -4.69 } },
      ["Caches"]    = { { 2.98, 1.53, 14.78 }, { 3.05, 2.37, -6.41 } },
      ["Counters"]  = { { -15.38, 1.53, 7.74 }, { -3.08, 1.53, 7.74 }, { -15.38, 1.53, 0.64 }, { -3.08, 1.53, 0.64 } },
      ["Vampire"]    = { -9.13, 2.00, 4.13 }
    },
    ["Valenwood"]   = {
      ["Entrance"]  = { -14.35, 1.53, 2.41 },
      ["19Hex"]     = { 17.42, 1.53, 4.19 },
      ["7Hex"]      = { -7.18, 1.24, 4.19 },
      ["6Hex"]      = { { -11.28, 1.24, 11.29 }, { -6.15, 1.24, -4.69 }, { 3.07, 1.24, 4.19 } },
      ["3Hex"]      = { { 1.02, 1.53, -6.46 }, { -5.13, 1.53, 14.84 }, { 7.17, 1.53, 0.64 } },
      ["19Obs"]     = { 17.41, 3.00, 4.16 },
      ["6Obs"]      = { 4.10, 1.53, 5.96 },
      ["3Obs"]      = { 7.17, 3.00, 0.64 },
    }
  }    

  if provinceName == "Black Marsh" then
    
    -- clash mat
    for _, object in pairs(bagClash.getObjects()) do
      if object.gm_notes == "B" then
        local clashMat = bagClash.takeObject({guid=object.guid})
        Wait.frames(function()
          clashMat.setRotation(rotDungeon[provinceName]["Clash"])
          clashMat.setPosition(posDungeon[provinceName]["Clash"])
          clashMat.setLock(true)
        end)
      end
    end

    -- Entrance
    local entranceTile = bagEntrance.takeObject()
    Wait.frames(function()
      entranceTile.setRotation(rotDungeon[provinceName]["Entrance"])
      entranceTile.setPosition(posDungeon[provinceName]["Entrance"])
      entranceTile.setLock(true)
      entranceTile.highlightOn("Green")
    end)

    -- 7 Hex
    local tile7Hex = bag7Hex.takeObject()
    Wait.frames(function()
      tile7Hex.setRotation(rotDungeon[provinceName]["7Hex"])
      tile7Hex.setPosition(posDungeon[provinceName]["7Hex"])
      tile7Hex.setLock(true)
      tile7Hex.highlightOn("Pink")
    end)

    -- 6 Hex X3
    for i = 1, 3 do
      local tile6Hex = bag6Hex.takeObject()
      Wait.frames(function()
        tile6Hex.setRotation(rotDungeon[provinceName]["6Hex"][i])
        tile6Hex.setPosition(posDungeon[provinceName]["6Hex"][i])
        tile6Hex.setLock(true)          
      end)
    end

    -- 3 Hex X3
    for i = 1, 3 do
      local tile3Hex = bag3Hex.takeObject()
      Wait.frames(function()
        tile3Hex.setRotation(rotDungeon[provinceName]["3Hex"][i])
        tile3Hex.setPosition(posDungeon[provinceName]["3Hex"][i])
        tile3Hex.setLock(true)
        tile3Hex.highlightOn("Pink")
      end)
    end

    -- caches
    Wait.time(function()
    
      for i = 1, 3 do
        local cache = bagCaches.takeObject()
        Wait.frames(function()
          cache.setRotation(rotDungeon[provinceName]["Caches"])
          cache.setPositionSmooth(posDungeon[provinceName]["Caches"][i], false, true)
        end)        
      end

    end, 1)
    
  elseif provinceName == "Cyrodiil" then
    -- Entrance
    local tileEntrance = bagEntrance.takeObject()
    Wait.frames(function()
      if tileEntrance then
        tileEntrance.setRotation(rotDungeon[provinceName]["Entrance"])
        tileEntrance.setPosition(posDungeon[provinceName]["Entrance"])
        tileEntrance.setLock(true)
        tileEntrance.highlightOn("Green")
      end
    end)

    -- 19 Hex
    for _, object in pairs(bag19Hex.getObjects()) do        
      local tile19Hex = bag19Hex.takeObject({guid=object.guid})        
      Wait.frames(function()
        if tile19Hex then
          tile19Hex.setRotation(rotDungeon[provinceName]["19Hex"])
          tile19Hex.setPosition(posDungeon[provinceName]["19Hex"])
          tile19Hex.setLock(true)
          tile19Hex.highlightOn("Brown")
        end
      end)     
    end

    -- 7 Hex X3
    for i = 1, 3 do
      local tile7Hex = bag7Hex.takeObject()
      Wait.frames(function()
        tile7Hex.setRotation(rotDungeon[provinceName]["7Hex"])
        tile7Hex.setPosition(posDungeon[provinceName]["7Hex"][i])
        tile7Hex.setLock(true)
        tile7Hex.highlightOn(i == 3 and "Brown" or "Green")
      end)
    end

    -- 6 Hex X3
    for i = 1, 3 do
      local tile6Hex = bag6Hex.takeObject()
      Wait.frames(function()
        tile6Hex.setRotation(rotDungeon[provinceName]["6Hex"][i])
        tile6Hex.setPosition(posDungeon[provinceName]["6Hex"][i])
        tile6Hex.setLock(true)
        tile6Hex.highlightOn(i == 3 and "Green" or "Yellow")
      end)
    end

    -- 3 Hex X2
    for i = 1, 2 do
      local tile3Hex = bag3Hex.takeObject()
      Wait.frames(function()
        tile3Hex.setRotation(rotDungeon[provinceName]["3Hex"])
        tile3Hex.setPosition(posDungeon[provinceName]["3Hex"][i])
        tile3Hex.setLock(true)
        tile3Hex.highlightOn("Green")
      end)
    end

    -- caches
    Wait.time(function()
    
      for i = 1, 4 do
        local cache = bagCaches.takeObject()
        Wait.frames(function()
          cache.setRotation(rotDungeon[provinceName]["Caches"])
          cache.setPositionSmooth(posDungeon[provinceName]["Caches"][i], false, true)
        end)        
      end

    end, 1)

  elseif provinceName == "High Rock" then
    -- Entrance
    local tileEntrance = bagEntrance.takeObject()
    Wait.frames(function()
      if tileEntrance then
        tileEntrance.setRotation(rotDungeon[provinceName]["Entrance"])
        tileEntrance.setPosition(posDungeon[provinceName]["Entrance"])
        tileEntrance.setLock(true)
        tileEntrance.highlightOn("Green")
      end
    end)

    -- 19 Hex
    for _, object in pairs(bag19Hex.getObjects()) do        
      local tile19Hex = bag19Hex.takeObject({guid=object.guid})        
      Wait.frames(function()
        if tile19Hex then
          tile19Hex.setRotation(rotDungeon[provinceName]["19Hex"])
          tile19Hex.setPosition(posDungeon[provinceName]["19Hex"])
          tile19Hex.setLock(true)
          tile19Hex.highlightOn("Teal")
        end
      end)     
    end

    -- 7 Hex X2
    for i = 1, 2 do
      local tile7Hex = bag7Hex.takeObject()
      Wait.frames(function()
        tile7Hex.setRotation(rotDungeon[provinceName]["7Hex"])
        tile7Hex.setPosition(posDungeon[provinceName]["7Hex"][i])
        tile7Hex.setLock(true)
        tile7Hex.highlightOn(i == 1 and "Green" or "Pink")
      end)
    end

    -- 6 Hex X2
    for i = 1, 2 do
      local tile6Hex = bag6Hex.takeObject()
      Wait.frames(function()
        tile6Hex.setRotation(rotDungeon[provinceName]["6Hex"][i])
        tile6Hex.setPosition(posDungeon[provinceName]["6Hex"][i])
        tile6Hex.setLock(true)
        tile6Hex.highlightOn(i == 1 and "Green" or "Pink")
      end)
    end

    -- 3 Hex X3
    for i = 1, 3 do
      local tile3Hex = bag3Hex.takeObject()
      Wait.frames(function()
        tile3Hex.setRotation(rotDungeon[provinceName]["3Hex"][i])
        tile3Hex.setPosition(posDungeon[provinceName]["3Hex"][i])
        tile3Hex.setLock(true)
        tile3Hex.highlightOn(i == 3 and "Pink" or "Teal")
      end)
    end

    -- caches
    Wait.time(function()
    
      for i = 1, 5 do
        local cache = bagCaches.takeObject()
        Wait.frames(function()
          cache.setRotation(rotDungeon[provinceName]["Caches"][i])
          cache.setPositionSmooth(posDungeon[provinceName]["Caches"][i], false, true)
        end)        
      end

    end, 1)

  elseif provinceName == "Morrowind" then
    -- Entrance
    local tileEntrance = bagEntrance.takeObject()
    Wait.frames(function()
      if tileEntrance then
        tileEntrance.setRotation(rotDungeon[provinceName]["Entrance"])
        tileEntrance.setPosition(posDungeon[provinceName]["Entrance"])
        tileEntrance.setLock(true)
        tileEntrance.highlightOn("Green")
      end
    end)

    -- 19 Hex
    for _, object in pairs(bag19Hex.getObjects()) do        
      local tile19Hex = bag19Hex.takeObject({guid=object.guid})        
      Wait.frames(function()
        if tile19Hex then
          tile19Hex.setRotation(rotDungeon[provinceName]["19Hex"])
          tile19Hex.setPosition(posDungeon[provinceName]["19Hex"])
          tile19Hex.setLock(true)           
        end
      end)     
    end

    -- 6 Hex X3
    for i = 1, 3 do
      local tile6Hex = bag6Hex.takeObject()
      Wait.frames(function()
        tile6Hex.setRotation(rotDungeon[provinceName]["6Hex"][i])
        tile6Hex.setPosition(posDungeon[provinceName]["6Hex"][i])
        tile6Hex.setLock(true)
      end)
    end

    -- 3 Hex X2
    for i = 1, 2 do
      local tile3Hex = bag3Hex.takeObject()
      Wait.frames(function()
        tile3Hex.setRotation(rotDungeon[provinceName]["3Hex"][i])
        tile3Hex.setPosition(posDungeon[provinceName]["3Hex"][i])
        tile3Hex.setLock(true)
      end)
    end

    -- caches
    Wait.time(function()
    
      for i = 1, 3 do
        local cache = bagCaches.takeObject()
        Wait.frames(function()
          cache.setRotation(rotDungeon[provinceName]["Caches"])
          cache.setPositionSmooth(posDungeon[provinceName]["Caches"][i], false, true)
          cache.highlightOn("Green")
        end)        
      end

    end, 1)

  elseif provinceName == "Skyrim" then
    -- Entrance
    local tileEntrance = bagEntrance.takeObject()
    Wait.frames(function()
      if tileEntrance then
        tileEntrance.setRotation(rotDungeon[provinceName]["Entrance"])
        tileEntrance.setPosition(posDungeon[provinceName]["Entrance"])
        tileEntrance.setLock(true)
        tileEntrance.highlightOn("Green")
      end
    end)

    -- 19 Hex
    for _, object in pairs(bag19Hex.getObjects()) do        
      local tile19Hex = bag19Hex.takeObject({guid=object.guid})        
      Wait.frames(function()
        if tile19Hex then
          tile19Hex.setRotation(rotDungeon[provinceName]["19Hex"])
          tile19Hex.setPosition(posDungeon[provinceName]["19Hex"])
          tile19Hex.setLock(true)           
        end
      end)     
    end

    -- 6 Hex X2
    for i = 1, 2 do
      local tile6Hex = bag6Hex.takeObject()
      Wait.frames(function()
        tile6Hex.setRotation(rotDungeon[provinceName]["6Hex"])
        tile6Hex.setPosition(posDungeon[provinceName]["6Hex"][i])
        tile6Hex.setLock(true)
      end)
    end

    -- 3 Hex X3
    for i = 1, 3 do
      local tile3Hex = bag3Hex.takeObject()
      Wait.frames(function()
        tile3Hex.setRotation(rotDungeon[provinceName]["3Hex"][i])
        tile3Hex.setPosition(posDungeon[provinceName]["3Hex"][i])
        tile3Hex.setLock(true)
      end)
    end

    -- caches
    Wait.time(function()
    
      for i = 1, 2 do
        local cache = bagCaches.takeObject()
        Wait.frames(function()
          cache.setRotation(rotDungeon[provinceName]["Caches"][i])
          cache.setPositionSmooth(posDungeon[provinceName]["Caches"][i], false, true)
          cache.highlightOn("Green")
        end)        
      end

    end, 1)

    -- additional items (lvl 20 vampire, 4X counters set to playerCount)
    local vampire = nil
    local bagHigh = getObjectbyName("Level 10 / 20 Enemies")
    for _, object in pairs(bagHigh.getObjects()) do
      if object.name:find("Vampire") then
        vampire = bagHigh.takeObject({guid=object.guid, rotation=rotDungeon[provinceName]["Vampire"]})
      end
    end
    if vampire ~= nil then
      vampire.setPositionSmooth(posDungeon[provinceName]["Vampire"], false, true)
    end
    for i = 1, 4 do
      local counter = getObjectbyName("Generic Counter Bag").takeObject()
      Wait.frames(function()
        counter.call('set_val', playerCount)
        counter.setRotation(rotDungeon[provinceName]["Counters"])
        counter.setPosition(posDungeon[provinceName]["Counters"][i])
      end)
    end

  elseif provinceName == "Valenwood" then
    -- Entrance
    local tileEntrance = bagEntrance.takeObject()
    Wait.frames(function()
      if tileEntrance then
        tileEntrance.setRotation(rotDungeon[provinceName]["Entrance"])
        tileEntrance.setPosition(posDungeon[provinceName]["Entrance"])
        tileEntrance.setLock(true)
      end
    end)

    -- 19 Hex
    local tile19Hex = bag19Hex.takeObject()
    Wait.frames(function()
      if tile19Hex then
        tile19Hex.setRotation(rotDungeon[provinceName]["19Hex"])
        tile19Hex.setPosition(posDungeon[provinceName]["19Hex"])
        tile19Hex.setLock(true)
        tile19Hex.highlightOn("Teal")
      end
    end)

    -- 7 Hex
    for _, object in pairs(bag7Hex.getObjects()) do        
      local tile7Hex = bag7Hex.takeObject({guid=object.guid})
      Wait.frames(function()
        if tile7Hex then
          tile7Hex.setRotation(rotDungeon[provinceName]["7Hex"])
          tile7Hex.setPosition(posDungeon[provinceName]["7Hex"])
          tile7Hex.setLock(true)
          tile7Hex.highlightOn("Pink")
        end          
      end)
      break
    end

    -- 6 Hex X3
    for i = 1, 3 do
      local tile6Hex = bag6Hex.takeObject()
      Wait.frames(function()
        tile6Hex.setRotation(rotDungeon[provinceName]["6Hex"][i])
        tile6Hex.setPosition(posDungeon[provinceName]["6Hex"][i])
        tile6Hex.setLock(true)
        tile6Hex.highlightOn(i == 3 and "Yellow" or "Pink")
      end)
    end

    -- 3 Hex X3
    for i = 1, 3 do
      local tile3Hex = bag3Hex.takeObject()
      Wait.frames(function()
        tile3Hex.setRotation(rotDungeon[provinceName]["3Hex"])
        tile3Hex.setPosition(posDungeon[provinceName]["3Hex"][i])
        tile3Hex.setLock(true)
        tile3Hex.highlightOn(i == 3 and "Yellow" or "Pink")
      end)
    end

    -- 19 Hex obstacle
    local tile19Obs = nil
    for _, object in pairs(bagObstacle.getObjects()) do
      if object.name == "19 Hex Obstacle" then
        tile19Obs = bagObstacle.takeObject({guid=object.guid}) 
        break
      end
    end
    Wait.frames(function()
      if tile19Obs then
        tile19Obs.setRotation(rotDungeon[provinceName]["19Obs"])
        tile19Obs.setPosition(posDungeon[provinceName]["19Obs"])          
        tile19Obs.highlightOn("Teal")
        tile19Obs.addContextMenuItem("Open Inner Sanctum", returnObstacle)
        tile19Obs.setDescription("Use the right click context menu to return Inner Sanctum obstacle to it's bag.")
      end
    end)

    -- 6 Hex obstacle
    local tile6Obs = nil
    for _, object in pairs(bagObstacle.getObjects()) do
      if object.name == "6 Hex Obstacle" then
        tile6Obs = bagObstacle.takeObject({guid=object.guid}) 
        break
      end
    end
    Wait.frames(function()
      if tile6Obs then
        tile6Obs.setRotation(rotDungeon[provinceName]["6Obs"])
        tile6Obs.setPosition(posDungeon[provinceName]["6Obs"])          
        tile6Obs.highlightOn("Yellow")
        tile6Obs.addContextMenuItem("Open Antechamber", returnObstacle)
        tile6Obs.setDescription("Use the right click context menu to return Antechamber obstacles to their bag.")
      end
    end)

    -- 3 Hex obstacle
    local tile3Obs = nil
    for _, object in pairs(bagObstacle.getObjects()) do
      if object.name == "3 Hex Obstacle" then
        tile3Obs = bagObstacle.takeObject({guid=object.guid})
        break
      end
    end
    Wait.frames(function()
      if tile3Obs then
        tile3Obs.setRotation(rotDungeon[provinceName]["3Obs"])
        tile3Obs.setPosition(posDungeon[provinceName]["3Obs"])          
        tile3Obs.highlightOn("Yellow")
        tile3Obs.addContextMenuItem("Open Antechamber", returnObstacle)
        tile3Obs.setDescription("Use the right click context menu to return Antechamber obstacles to their bag.")
      end
    end)
    
  end

  broadcastToAll("[" .. Color.fromString("Green"):toHex() .. "]" .. provinceName .. "[-] Dungeon battle started!", "White")    
  Wait.time(function()

    broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder:[-] You may use the Deploy Enemies buttons to pull enemies per the rules of your encounter.", "White")

  end, 2)
  Wait.time(function()

    broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder:[-] You may use the Clear Battle button to clean up once the dungeon encounter is completed.", "White")

  end, 4)
  Wait.time(function()
  
    if provinceName == "Black Marsh" then
      broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder:[-] You may use the right click context menu on an enemy chip to set it to 0 HP without sending it to the defeated monster bag.", "White")
    elseif provinceName == "Valenwood" then
      broadcastToAll("[" .. Color.fromString("Orange"):toHex() .. "]Reminder:[-] You may use the right click context menu on an obstacle tile to open up dungeon sections.", "White")
    end

  end, 6)

  -- open main gazetteer PDF to dungeon page
  local gazetteer = nil
  local posGaz = { -9.14, 12.47, 54.30 }
  local tolerance = 0.50
  -- get current gazetteer
  for _, object in pairs(getObjects()) do
    if object.getName() == provinceName .. " Gazetteer" then
      local objPos = object.getPosition()
      if math.abs(objPos[1] - posGaz[1]) <= tolerance and math.abs(objPos[2] - posGaz[2]) <= tolerance and math.abs(objPos[3] - posGaz[3]) <= tolerance then
        gazetteer = object
        break
      end
    end
  end
  local pdfPage     = {
    ["Black Marsh"] = 43,
    ["Cyrodiil"]    = 46,
    ["High Rock"]   = 44,
    ["Morrowind"]   = 42,
    ["Skyrim"]      = 54,
    ["Valenwood"]   = 45,
  }
  if gazetteer ~= nil then
    gazetteer.Book.setPage(pdfPage[provinceName])
  end    
end


function returnObstacle(_, _, object)
  
  -- this function handles the removal of obstacles in the Valenwood dungeon
  local bagObstacle = getObjectbyName("Obstacle Hex Bag")
  
  local roomType = object.getName() == "19 Hex Obstacle" and "Sanctum" or "Antechamber"
  if roomType == "Sanctum" then
    -- return 19 hex obstacle
    object.setDescription("")
    object.highlightOff()
    bagObstacle.putObject(object)
    -- place caches
    
    local posCaches = {
      { 11.30, 1.53, 7.65 },
      { 11.29, 1.53, 0.69 },
      { 23.46, 2.37, 7.63 },
      { 23.55, 2.37, 0.63 }
    }
    local bagCaches = getObjectbyName("Cache Chip Bag")
    for i = 1, 4 do
      local cache = bagCaches.takeObject({
        rotation = i > 2 and { 0, 180, 180 } or { 0, 180, 0 },
        position = posCaches[i],
      })
    end
    broadcastToAll("[" .. Color.fromString("Teal"):toHex() .. "]Inner Sanctum[-] has been opened!", "White")

  elseif roomType == "Antechamber" then
    -- return 6, 3 hex obstacles
    for _, object in pairs(getObjects()) do
      if object.getName() == "3 Hex Obstacle" or object.getName() == "6 Hex Obstacle" then
        object.setDescription("")
        object.highlightOff()
        bagObstacle.putObject(object)
      end
    end
    broadcastToAll("[" .. Color.fromString("Yellow"):toHex() .. "]Antechamber[-] has been opened!", "White")
  end
end